<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SOC Splunk101 | Classroom</title><meta name=keywords content="splunk,soc"><meta name=description content="More than 80 Use Cases for Splunk."><meta name=author content="Animesh Roy"><link rel=canonical href=https://classroom.anir0y.in/post/soc-splunk101/><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=icon type=image/png sizes=16x16 href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=icon type=image/png sizes=32x32 href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=apple-touch-icon href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=mask-icon href=https://classroom.anir0y.in/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://classroom.anir0y.in/post/soc-splunk101/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://classroom.anir0y.in/post/soc-splunk101/"><meta property="og:site_name" content="Classroom"><meta property="og:title" content="SOC Splunk101"><meta property="og:description" content="More than 80 Use Cases for Splunk."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-04-10T19:27:17+05:30"><meta property="article:modified_time" content="2023-04-10T19:27:17+05:30"><meta property="article:tag" content="Splunk"><meta property="article:tag" content="Soc"><meta property="og:image" content="https://classroom.anir0y.in/img/soc-101.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://classroom.anir0y.in/img/soc-101.png"><meta name=twitter:title content="SOC Splunk101"><meta name=twitter:description content="More than 80 Use Cases for Splunk."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://classroom.anir0y.in/post/"},{"@type":"ListItem","position":2,"name":"SOC Splunk101","item":"https://classroom.anir0y.in/post/soc-splunk101/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SOC Splunk101","name":"SOC Splunk101","description":"More than 80 Use Cases for Splunk.","keywords":["splunk","soc"],"articleBody":"some Use Cases for Splunk. 1- Windows Audit Log Tampering Check for any tampering done to Windows audit logs.\nindex=__your_sysmon_index__ (sourcetype=wineventlog AND (EventCode=1102 OR EventCode=1100)) OR (sourcetype=wineventlog AND EventCode=104) | stats count by _time EventCode Message sourcetype host 2- Finding Large Web Uploads Find large file uploads that could point to data exfiltration in your network.\nindex=__your_sysmon_index__ sourcetype=websense* | where bytes_out \u003e 35000000 | table _time src_ip bytes* uri 3- Detecting Recurring Malware on Host Using anti-virus logs to detect if malware is recurring on a host after being removed.\nindex=__your_sysmon_index__ sourcetype=symantec:* | stats count range(_time) as TimeRange by Risk_Name, Computer_Name | where TimeRange\u003e1800 | eval TimeRange_In_Hours = round(TimeRange/3600,2), TimeRange_In_Days = round(TimeRange/3600/24,2) 4-Detecting Brute Force Attacks A brute-force attack consists of a multiple login attempts using many passwords by an unauthorized user/attacker with the hope of eventually guessing the correct password.\nindex=__your_sysmon_index__ sourcetype=winxsecurity user=* user!\"\" | stats count(eval(action=\"success\")) as successes count(eval(action=\"failure\")) as failures by user, ComputerName | where successes\u003e0 AND failures\u003e100 Windows\nindex=windows source=\"WinEventLog:Security\" EventCode=4625 | bin _time span=5m | stats count by _time,user,host,src,action | where count \u003e= 5 Linux\nindex=linux source=\"/var/log/auth.log\" \"Failed password\" | bin _time span=5m | stats count by _time,user,host,src,action | where count \u003e= 5 5- Detecting Unencrypted Web Communications Find unencrypted web communications that could lead to a data breach.\nindex=__your_sysmon_index__ sourcetype=firewall_data dest_port!=443 app=workday* | table _time user app bytes* src_ip dest_ip dest_port 6- Identifying Web Users By Country Use IPs in your data to report and visualize user locations.\nindex=web sourcetype=access_combined | iplocation clientip | geostats dc(clientip) by Country 7- Identifying Slow Web Content A slow loading web site can not only frustrate users, but can also hurt search rankings.\nindex=web sourcetype=ms:iis:auto OR sourcetype=apache: access | stats avg(response_time) as art by uri_path | eval \"Average Response Time\" = round(art,2) | sort -\"Average Response Time\" | table uri_path, \"Average Response Time\" 8- Finding New Local Admin Accounts Often an attack will include the creation of a new user, followed by permissions being elevated to an admin level.\nindex=win_servers sourcetype=windows:security EventCode=4720 OR (EventCode=4732 Administrators) | transaction Security_ID maxspan=180m | search EventCode=4720 EventCode=4732 | table _time, EventCode, Recurity_ID, SamAccountName 9- Finding Interactive Logins From Service Accounts Most service accounts should never interactively log into servers.\nindex=systems sourcetype=audit_logs user=svc_* | stats earliest(_time) as earliest latest(_time) as latest by user, dest | eval isOutlier=if(earliest \u003e= relative_time(now(), \"-1d@d\"), 1, 0) | convert ctime(earliest) ctime(Latest) 10- Log Volume Trending Visualizing the number of events being logged by an application can provide a simple, yet powerful indicator of the state of your application, or changes in the behavior of your code or environment.\n|tstats prestats=t count WHERE index=apps by host _time span=1m |timechart partial=f span=1m count by host limit=0 11- Basic TOR Traffic Detection Use firewall data to find TOR traffic on your network.\nindex=network sourcetype=firewall_data app=tor src_ip=* | table _time src_ip src_port dest_ip dest_port bytes app 12- Measuring Storage I/O Latency Quickly find I/O bottlenecks across your systems.\nindex=main sourcetype=iostat | timechart avg(latency) by host 13- Measuring Storage Speed I/O Utilization by Host It simple to track disk I/O, helping you quickly discover storage issues on your servers.\nindex=main sourcetype=iostat | eval hostdevice=host+\":\"+Device | timechart avg(total_ops) by hostdevice 14- Measuring Memory Utilization by Host It’s easy to track memory utilization of your systems using Splunk Enterprise.\nindex=main sourcetype=vmstat | stats max(memUsedPct) as memused by host | where memused\u003e80 15- Rogue DNS detection Look for DNS requests that are not destined for the dedicated DNS server.\nindex=security sourcetype=cp_log src_ip!=192.168.14.10 dest_ip!=192.168.14.10 protocol=53 action!=Drop | where dest_ip=\"192.168.0.0/16\" AND src_ip=\"192.168.0.0/16\" | stats count, values(dest_ip) by src_ip 16- Suspicious PowerShell Commands Look for logs with commands that try to download external scripts/content or bypass PowerShell.\nindex=windows source=\"WinEventLog:Microsoft-Windows-PowerShell/Operational\" EventCode=4104 AND ((ScriptBlockText=*-noni* *iex* *New-Object*) OR (ScriptBlockText=*-ep* *bypass* *-Enc*) OR (ScriptBlockText=*powershell* *reg* *add* *HKCU\\\\software\\\\microsoft\\\\windows\\\\currentversion\\\\run*) OR (ScriptBlockText=*bypass* *- noprofile* *-windowstyle* *hidden* *new-object* *system.net.webclient* *.download*) OR (ScriptBlockText=*iex* *New-Object* *Net.WebClient* *.Download*)) | table Computer, ScriptBlockText, UserID 17- Windows audit log cleared Look for security logs filtered with EventCode 1102.\nindex=windows source=\"WinEventLog:Security\" EventCode=1102 | table _time, host, signature, user 18- Detecting Network and Port Scanning Look for distinct count of destination ports within a short span of time.\n| from datamodel:\"Network_Traffic\".\"All_Traffic\" | stats dc(dest_port) as dc_dest_port by src, dest | where dc_dest_port \u003e 10 OR\nindex=__your_sysmon_index__ sourcetype=firewall* | stats dc(dest_port) as num_dest_port dc(dest_ip) as num_dest_ip by src_ip | where num_dest_port \u003e500 OR num_dest_ip \u003e500 19- Unusual Access Look for count of multiple failed login attempts where successful login is true.\n| from datamodel:\"Authentication\".\"Authentication\" | where like(app,\"ssh\") | stats list(action) as Attempts, count(eval(match(action,\"failure\"))) as Failed, count(eval(match(action,\"success\"))) as Success by user,src,dest,app | where mvcount(Attempts)\u003e=6 AND Success\u003e0 AND Failed\u003e=5 20- Malware Attack Look for infection count of malware attack.\n| from datamodel:\"Malware\".\"Malware_Attacks\" | stats dc(\"signature\") as \"infection_count\" by \"dest\" | where 'infection_count'\u003e1 21-Attempt To Add Certificate To Untrusted Store Adversaries may add their own root certificate to the certificate store, to cause the web browser to trust that certificate and not display a security warning when it encounters the previously unseen certificate. This action may be the precursor to malicious activity.\n| tstats count min(_time) as firstTime values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=*certutil* (Processes.process=*-addstore*) by Processes.parent_process Processes.process_name Processes.user 22**- Batch File Write to System32** While batch files are not inherently malicious, it is uncommon to see them created after OS installation, especially in the Windows directory. This analytic looks for the suspicious activity of a batch file being created within the C:\\Windows\\System32 directory tree. There will be only occasional false positives due to administrator actions.\n| tstats count min(_time) as firstTime max(_time) as lastTime values(Filesystem.dest) as dest values(Filesystem.file_name) as file_name values(Filesystem.user) as user from datamodel=Endpoint.Filesystem by Filesystem.file_path | rex field=file_name \"(?\\.[^\\.]+)$\" | search file_path=*system32* AND file_extension=.bat 23- BCDEdit Failure Recovery Modification This search looks for flags passed to bcdedit.exe modifications to the built-in Windows error recovery boot configurations. This is typically used by ransomware to prevent recovery.\n| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = bcdedit.exe Processes.process=\"*recoveryenabled*\" (Processes.process=\"* no*\") by Processes.process_name Processes.process Processes.parent_process_name Processes.dest Processes.user 24- BITS Job Persistence The following query identifies Microsoft Background Intelligent Transfer Service utility bitsadmin.exe scheduling a BITS job to persist on an endpoint. The query identifies the parameters used to create, resume or add a file to a BITS job. Typically seen combined in a oneliner or ran in sequence. If identified, review the BITS job created and capture any files written to disk. It is possible for BITS to be used to upload files and this may require further network data analysis to identify. You can use bitsadmin /list /verbose to list out the jobs during investigation.\n| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=bitsadmin.exe Processes.process IN (*create*, *addfile*, *setnotifyflags*, *setnotifycmdline*, *setminretrydelay*, *setcustomheaders*, *resume* ) by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id 25- BITSAdmin Download File The following query identifies Microsoft Background Intelligent Transfer Service utility bitsadmin.exe using the transfer parameter to download a remote object. In addition, look for download or upload on the command-line, the switches are not required to perform a transfer. Capture any files downloaded. Review the reputation of the IP or domain used. Typically once executed, a follow on command will be used to execute the dropped file. Note that the network connection or file modification events related will not spawn or create from bitsadmin.exe, but the artifacts will appear in a parallel process of svchost.exe with a command-line similar to svchost.exe -k netsvcs -s BITS. It’s important to review all parallel and child processes to capture any behaviors and artifacts. In some suspicious and malicious instances, BITS jobs will be created. You can use bitsadmin /list /verbose to list out the jobs during investigation.\n| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=bitsadmin.exe Processes.process=*transfer* by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id 26- CertUtil Download With URLCache and Split Arguments Certutil.exe may download a file from a remote destination using urlcache. This behavior does require a URL to be passed on the command-line. In addition, f (force) and split (Split embedded ASN.1 elements, and save to files) will be used. It is not entirely common for certutil.exe to contact public IP space. However, it is uncommon for certutil.exe to write files to world writeable paths.\\ During triage, capture any files on disk and review. Review the reputation of the remote IP or domain in question.\n| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=certutil.exe Processes.process=*urlcache* Processes.process=*split* by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id 27- CertUtil Download With VerifyCtl and Split Arguments Certutil.exe may download a file from a remote destination using VerifyCtl. This behavior does require a URL to be passed on the command-line. In addition, f (force) and split (Split embedded ASN.1 elements, and save to files) will be used. It is not entirely common for certutil.exe to contact public IP space. \\ During triage, capture any files on disk and review. Review the reputation of the remote IP or domain in question. Using VerifyCtl, the file will either be written to the current working directory or %APPDATA%\\..\\LocalLow\\Microsoft\\CryptnetUrlCache\\Content\\.\n| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=certutil.exe Processes.process=*verifyctl* Processes.process=*split* by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id 28- Certutil exe certificate extraction This search looks for arguments to certutil.exe indicating the manipulation or extraction of Certificate. This certificate can then be used to sign new authentication tokens specially inside Federated environments such as Windows ADFS.\n| tstats count min(_time) as firstTime values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=certutil.exe Processes.process = \"* -exportPFX *\" by Processes.parent_process Processes.process_name Processes.process Processes.user 29- CertUtil With Decode Argument CertUtil.exe may be used to encode and decode a file, including PE and script code. Encoding will convert a file to base64 with ----BEGIN CERTIFICATE----- and ----END CERTIFICATE----- tags. Malicious usage will include decoding a encoded file that was downloaded. Once decoded, it will be loaded by a parallel process. Note that there are two additional command switches that may be used - encodehex and decodehex. Similarly, the file will be encoded in HEX and later decoded for further execution. During triage, identify the source of the file being decoded. Review its contents or execution behavior for further analysis.\n| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=certutil.exe Processes.process=*decode* by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id 30- Create local admin accounts using net exe This search looks for the creation of local administrator accounts using net.exe.\n| tstats count values(Processes.user) as user values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=net.exe OR Processes.process_name=net1.exe) AND (Processes.process=*localgroup* OR Processes.process=*/add* OR Processes.process=*user*) by Processes.process Processes.process_name Processes.dest |`create_local_admin_accounts_using_net_exe_filter` 31- Create Remote Thread into LSASS Actors may create a remote thread into the LSASS service as part of a workflow to dump credentials.\n`sysmon` EventID=8 TargetImage=*lsass.exe | stats count min(_time) as firstTime max(_time) as lastTime by Computer, EventCode, TargetImage, TargetProcessId | rename Computer as dest 32- Create Service In Suspicious File Path This detection is to identify a creation of “user mode service” where the service file path is located in non-common service folder in windows.\n`wineventlog_system` EventCode=7045 Service_File_Name = \"*\\.exe\" NOT (Service_File_Name IN (\"C:\\\\Windows\\\\*\", \"C:\\\\Program File*\", \"C:\\\\Programdata\\\\*\", \"%systemroot%\\\\*\")) Service_Type = \"user mode service\" | stats count min(_time) as firstTime max(_time) as lastTime by EventCode Service_File_Name Service_Name Service_Start_Type Service_Type 33- Common Windows Process Masquerading “Masquerading occurs when the name or location of an object, legitimate or malicious, is manipulated or abused for the sake of evading defenses and observation. This may include manipulating file metadata, tricking users into misidentifying the file type, and giving legitimate task or service names.”\nMalware authors often use this technique to hide malicious executables behind legitimate Windows executable names (e.g. lsass.exe, svchost.exe, etc).\nindex=__your_sysmon_index__ source=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" AND ( (process_name=svchost.exe AND NOT (process_path=\"C:\\\\Windows\\\\System32\\\\svchost.exe\" OR process_path=\"C:\\\\Windows\\\\SysWow64\\\\svchost.exe\")) OR (process_name=smss.exe AND NOT process_path=\"C:\\\\Windows\\\\System32\\\\smss.exe\") OR (process_name=wininit.exe AND NOT process_path=\"C:\\\\Windows\\\\System32\\\\wininit.exe\") OR (process_name=taskhost.exe AND NOT process_path=\"C:\\\\Windows\\\\System32\\\\taskhost.exe\") OR (process_name=lasass.exe AND NOT process_path=\"C:\\\\Windows\\\\System32\\\\lsass.exe\") OR (process_name=winlogon.exe AND NOT process_path=\"C:\\\\Windows\\\\System32\\\\winlogon.exe\") OR (process_name=csrss.exe AND NOT process_path=\"C:\\\\Windows\\\\System32\\\\csrss.exe\") OR (process_name=services.exe AND NOT process_path=\"C:\\\\Windows\\\\System32\\\\services.exe\") OR (process_name=lsm.exe AND NOT process_path=\"C:\\\\Windows\\\\System32\\\\lsm.exe\") OR (process_name=explorer.exe AND NOT process_path=\"C:\\\\Windows\\\\explorer.exe\") ) 34- Unusual Child Process spawned using DDE exploit Adversaries may use Windows Dynamic Data Exchange (DDE) to execute arbitrary commands. DDE is a client-server protocol for one-time and/or continuous inter-process communication (IPC) between applications. Once a link is established, applications can autonomously exchange transactions consisting of strings, warm data links (notifications when a data item changes), hot data links (duplications of changes to a data item), and requests for command execution.\nindex = __your_sysmon__index__ (ParentImage=\"*excel.exe\" OR ParentImage=\"*word.exe\" OR ParentImage=\"*outlook.exe\") Image=\"*.exe\" 35- Detecting Tampering of Windows Defender Command Prompt In an attempt to avoid detection after compromising a machine, threat actors often try to disable Windows Defender. This is often done using “sc” [service control], a legitimate tool provided by Microsoft for managing services. This action interferes with event detection and may lead to a security event going undetected, thereby potentially leading to further compromise of the network.\nindex= __your_sysmon__index__ EventCode=1 Image = \"C:\\\\Windows\\\\System32\\\\sc.exe\" | regex CommandLine=\"^sc\\s*(config|stop|query)\\sWinDefend$\" 36- Disable UAC Threat actors often, after compromising a machine, try to disable User Access Control (UAC) to escalate privileges. This is often done by changing the registry key for system policies using “reg.exe”, a legitimate tool provided by Microsoft for modifying the registry via command prompt or scripts. This action interferes with UAC and may enable a threat actor to escalate privileges on the compromised system, thereby allowing further exploitation of the system.\nsourcetype = __your_sysmon_index__ ParentImage = \"C:\\\\Windows\\\\System32\\\\cmd.exe\" | where like(CommandLine,\"reg.exe%HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System%REG_DWORD /d 0%\") 37- Identifying Port Scanning Activity After compromising an initial machine, adversaries commonly attempt to laterally move across the network. The first step to attempt the lateral movement often involves conducting host identification, port and service scans on the internal network via the compromised machine using tools such as Nmap, Cobalt Strike, etc.\nsourcetype='firewall_logs' dest_ip = 'internal_subnet' | stats dc(dest_port) as pcount by src_ip | where pcount \u003e5 38- Unusually Long Command Line Strings Often, after a threat actor gains access to a system, they will attempt to run some kind of malware to further infect the victim machine. These malware often have long command line strings, which could be a possible indicator of attack. Here, we use sysmon and Splunk to first find the average command string length and search for command strings that stretch over multiple lines, thus identifying anomalies and possibly malicious commands.\nindex=__your_sysmon_index__ sourcetype=\"xmlwineventlog\" EventCode=4688 |eval cmd_len=len(CommandLine) | eventstats avg(cmd_len) as avg by host| stats max(cmd_len) as maxlen, values(avg) as avgperhost by host, CommandLine | where maxlen \u003e 10*avgperhost 39- Clearing Windows Logs with Wevtutil In an attempt to clear traces after compromising a machine, threat actors often try to clear Windows Event logs. This is often done using “wevtutil”, a legitimate tool provided by Microsoft. This action interferes with event collection and notification, and may lead to a security event going undetected, thereby potentially leading to further compromise of the network.\nindex=__your_sysmon_index__ sourcetype= __your__windows__sysmon__sourcetype EventCode=1 Image=*wevtutil* CommandLine=*cl* (CommandLine=*System* OR CommandLine=*Security* OR CommandLine=*Setup* OR CommandLine=*Application*) 40- Unusual Child Process for Spoolsv.Exe or Connhost.Exe After gaining initial access to a system, threat actors attempt to escalate privileges as they may be operating within a lower privileged process which does not allow them to access protected information or carry out tasks which require higher permissions. A common way of escalating privileges in a system is by externally invoking and exploiting spoolsv or connhost executables, both of which are legitimate Windows applications. This query searches for an invocation of either of these executables by a user, thus alerting us of any potentially malicious activity.\n(index=__your_sysmon_index__ EventCode=1) (Image=C:\\\\Windows\\\\System32\\\\spoolsv.exe* OR Image=C:\\\\Windows\\\\System32\\\\conhost.exe) ParentImage = \"C:\\\\Windows\\\\System32\\\\cmd.exe\" 41- Detecting Shadow Copy Deletion via Vssadmin.exe After compromising a network of systems, threat actors often try to delete Shadow Copy in an attempt to prevent administrators from restoring the systems to versions present before the attack. This is often done via vssadmin, a legitimate Windows tool to interact with shadow copies. This non-detection of this technique, which is often employed by ransomware strains such as “Olympic Destroyer”, may lead to a failure in recovering systems after an attack.\nindex=__your_win_event_log_index__ EventType=4688 CommandLine:\"delete\" OriginalFileName:\"VSSADMIN.EXE\" 42- Webshell-Indicative Process Tree A web shell is a web script placed on an openly accessible web server to allow an adversary to use the server as a gatway in a network. As the shell operates, commands will be issued from within the web application into the broader server operating system. This analytic looks for host enumeration executables initiated by any web service that would not normally be executed within that environment.\nindex=__your_sysmon_index__ (ParentImage=\"C:\\\\Windows\\\\System32\\\\services.exe\" Image=\"C:\\\\Windows\\\\System32\\\\cmd.exe\" (CommandLine=\"*echo*\" AND CommandLine=\"*\\\\pipe\\\\*\")) OR (Image=\"C:\\\\Windows\\\\System32\\\\rundll32.exe\" CommandLine=\"*,a /p:*\") 43- Get System Elevation Cyber actors frequently escalate to the SYSTEM account after gaining entry to a Windows host, to enable them to carry out various attacks more effectively. Tools such as Meterpreter, Cobalt Strike, and Empire carry out automated steps to “Get System”, which is the same as switching over to the System user account. Most of these tools utilize multiple techniques to try and attain SYSTEM: in the first technique, they create a named pipe and connects an instance of cmd.exe to it, which allows them to impersonate the security context of cmd.exe, which is SYSTEM. In the second technique, a malicious DLL is injected into a process that is running as SYSTEM; the injected DLL steals the SYSTEM token and applies it where necessary to escalate privileges. This analytic looks for both of these techniques.\nindex=__your_sysmon_index__ (ParentImage=\"C:\\\\Windows\\\\System32\\\\services.exe\" Image=\"C:\\\\Windows\\\\System32\\\\cmd.exe\" (CommandLine=\"*echo*\" AND CommandLine=\"*\\\\pipe\\\\*\")) OR (Image=\"C:\\\\Windows\\\\System32\\\\rundll32.exe\" CommandLine=\"*,a /p:*\") index=__your_sysmon_index__ (Image=\"C:\\\\Windows\\\\System32\\\\cmd.exe\" OR CommandLine=\"*%COMSPEC%*\") (CommandLine=\"*echo*\" AND CommandLine=\"*\\pipe\\*\") 44- Boot or Logon Initialization Scripts Adversaries may schedule software to run whenever a user logs into the system; this is done to establish persistence and sometimes for lateral movement. This trigger is established through the registry key HKEY_CURRENT_USER\\EnvironmentUserInitMprLogonScript. This signature looks edits to existing keys or creation of new keys in that path. Users purposefully adding benign scripts to this path will result in false positives; that case is rare, however. There are other ways of running a script at startup or login that are not covered in this signature. Note that this signature overlaps with the Windows Sysinternals Autoruns tool, which would also show changes to this registry path.\n(index=__your_sysmon_index__ EventCode=1 Image=\"C:\\\\Windows\\\\System32\\\\reg.exe\" CommandLine=\"*add*\\\\Environment*UserInitMprLogonScript\") OR (index=__your_sysmon_index__ (EventCode=12 OR EventCode=14 OR EventCode=13) TargetObject=\"*\\\\Environment*UserInitMprLogonScript\") 45- Local Network Sniffing Adversaries may use a variety of tools to gain visibility on the current status of things on the network: which processes are listening on which ports, which services are running on other hosts, etc. This analytic looks for the names of the most common network sniffing tools. While this may be noisy on networks where sysadmins are using any of these tools on a regular basis, in most networks their use is noteworthy.\n(index=__your_sysmon_index__ EventCode=1) (Image=\"*tshark.exe\" OR Image=\"*windump.exe\" OR (Image=\"*logman.exe\" AND ParentImage!=\"?\" AND ParentImage!=\"C:\\\\Program Files\\\\Windows Event Reporting\\\\Core\\\\EventReporting.AgentService.exe\") OR Image=\"*tcpdump.exe\" OR Image=\"*wprui.exe\" OR Image=\"*wpr.exe\") 46- DLL Injection with Mavinject Injecting a malicious DLL into a process is a common adversary TTP. Although the ways of doing this are numerous, mavinject.exe is a commonly used tool for doing so because it roles up many of the necessary steps into one, and is available within Windows. Attackers may rename the executable, so we also use the common argument “INJECTRUNNING” as a related signature here. Whitelisting certain applications may be necessary to reduce noise for this analytic.\n(index=__your_sysmon_index__ EventCode=1) (Image=\"C:\\\\Windows\\\\SysWOW64\\\\mavinject.exe\" OR Image=\"C:\\\\Windows\\\\System32\\\\mavinject.exe\" OR CommandLine=\"*\\INJECTRUNNING*\") 47- Processes Started From Irregular Parent Adversaries may start legitimate processes and then use their memory space to run malicious code. This analytic looks for common Windows processes that have been abused this way in the past; when the processes are started for this purpose they may not have the standard parent that we would expect. This list is not exhaustive, and it is possible for cyber actors to avoid this discepency. These signatures only work if Sysmon reports the parent process, which may not always be the case if the parent dies before sysmon processes the event.\n(index=__your_sysmon_index__ EventCode=1) AND ParentImage!=\"?\" AND ParentImage!=\"C:\\\\Program Files\\\\SplunkUniversalForwarder\\\\bin\\\\splunk-regmon.exe\" AND ParentImage!=\"C:\\\\Program Files\\\\SplunkUniversalForwarder\\\\bin\\\\splunk-powershell.exe\" AND ((Image=\"C:\\\\Windows\\System32\\\\smss.exe\" AND (ParentImage!=\"C:\\\\Windows\\\\System32\\\\smss.exe\" AND ParentImage!=\"System\")) OR (Image=\"C:\\\\Windows\\\\System32\\\\csrss.exe\" AND (ParentImage!=\"C:\\\\Windows\\\\System32\\\\smss.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\svchost.exe\")) OR (Image=\"C:\\\\Windows\\\\System32\\\\wininit.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\smss.exe\") OR (Image=\"C:\\\\Windows\\\\System32\\\\winlogon.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\smss.exe\") OR (Image=\"C:\\\\Windows\\\\System32\\\\lsass.exe\" and ParentImage!=\"C:\\\\Windows\\\\System32\\\\wininit.exe\") OR (Image=\"C:\\\\Windows\\\\System32\\\\LogonUI.exe\" AND (ParentImage!=\"C:\\\\Windows\\\\System32\\\\winlogon.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\wininit.exe\")) OR (Image=\"C:\\\\Windows\\\\System32\\\\services.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\wininit.exe\") OR (Image=\"C:\\\\Windows\\\\System32\\\\spoolsv.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\services.exe\") OR (Image=\"C:\\\\Windows\\\\System32\\\\taskhost.exe\" AND (ParentImage!=\"C:\\\\Windows\\\\System32\\\\services.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\svchost.exe\")) OR (Image=\"C:\\\\Windows\\\\System32\\\\taskhostw.exe\" AND (ParentImage!=\"C:\\\\Windows\\\\System32\\\\services.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\svchost.exe\")) OR (Image=\"C:\\\\Windows\\System32\\\\userinit.exe\" AND (ParentImage!=\"C:\\\\Windows\\\\System32\\\\dwm.exe\" AND ParentImage!=\"C:\\\\Windows\\\\System32\\\\winlogon.exe\"))) 48- Clear Powershell Console Command History Adversaries may attempt to conceal their tracks by deleting the history of commands run within the Powershell console, or turning off history saving to begin with. This analytic looks for several commands that would do this. This does not capture the event if it is done within the console itself; only commandline-based commands are detected. Note that the command to remove the history file directly may very a bit if the history file is not saved in the default path on a particular system.\n(index=__your_sysmon_index__ EventCode=1) (CommandLine=\"*rm (Get-PSReadlineOption).HistorySavePath*\" OR CommandLine=\"*del (Get-PSReadlineOption).HistorySavePath*\" OR CommandLine=\"*Set-PSReadlineOption –HistorySaveStyle SaveNothing*\" OR CommandLine=\"*Remove-Item (Get-PSReadlineOption).HistorySavePath*\" OR CommandLine=\"del*Microsoft\\\\Windows\\\\Powershell\\\\PSReadline\\\\ConsoleHost_history.txt\") 49- Local Permission Group Discovery Cyber actors frequently enumerate local or domain permissions groups. The net utility is usually used for this purpose. This analytic looks for any instances of net.exe, which is not normally used for benign purposes, although system administrator actions may trigger false positives.\n(index=__your_sysmon_index__ EventCode=1) Image=\"C:\\\\Windows\\\\System32\\\\net.exe\" AND (CommandLine=\"* user*\" OR CommandLine=\"* group*\" OR CommandLine=\"* localgroup*\" OR CommandLine=\"*get-localgroup*\" OR CommandLine=\"*get-ADPrincipalGroupMembership*\") 50- Network Share Connection Removal Adversaries may use network shares to exfliltrate date; they will then remove the shares to cover their tracks. This analytic looks for the removal of network shares via commandline, which is otherwise a rare event.\n(index=__your_sysmon_index__ EventCode=1) ((Image=\"C:\\\\Windows\\\\System32\\\\net.exe\" AND CommandLine=\"*delete*\") OR CommandLine=\"*Remove-SmbShare*\" OR CommandLine=\"*Remove-FileShare*\") 51- MSBuild and msxsl Trusted developer utilities such as MSBuild may be leveraged to run malicious code with elevated privileges. This analytic looks for any instances of msbuild.exe, which will execute any C# code placed within a given XML document; and msxsl.exe, which processes xsl transformation specifications for XML files and will execute a variaty of scripting languages contained within the XSL file. Both of these executables are rarely used outside of Visual Studio.\n(index=__your_sysmon_index__ EventCode=1) (Image=\"C:\\\\Program Files (x86)\\\\Microsoft Visual Studio\\\\*\\\\bin\\\\MSBuild.exe\" OR Image=\"C:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\msbuild.exe\" OR Image=\"C:\\\\users\\\\*\\\\appdata\\\\roaming\\\\microsoft\\\\msxsl.exe\") ParentImage!=\"*\\\\Microsoft Visual Studio*\") 52- Compiled HTML Access Adversaries may hide malicious code in .chm compiled HTML files. When these files are read, Windows uses the HTML help executable named hh.exe, which is the signature for this analytic.\n(index=__your_sysmon_index__ EventCode=1) (Image=\"C:\\\\Windows\\\\syswow64\\\\hh.exe\" OR Image=\"C:\\\\Windows\\\\system32\\\\hh.exe\") 53- CMSTP CMSTP.exe is the Microsoft Connection Manager Profile Installer, which can be leveraged to setup listeners that will receive and install malware from remote sources in trusted fashion. When CMSTP.exe is seen in combination with an external connection, it is a good indication of this TTP.\n(index=__your_sysmon_index__ EventCode=3) Image=\"C:\\\\Windows\\\\System32\\\\CMSTP.exe\" | where ((!cidrmatch(\"10.0.0.0/8\", SourceIp) AND !cidrmatch(\"192.168.0.0/16\", SourceIp) AND !cidrmatch(\"172.16.0.0/12\", SourceIp)) 54- Registry Edit from Screensaver Adversaries may use screensaver files to run malicious code. This analytic triggers on suspicious edits to the screensaver registry keys, which dictate which .scr file the screensaver runs.\nindex=your_sysmon_index (EventCode=12 OR EventCode=13 OR EventCode=14) TargetObject=\"*\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\Control Panel\\\\Desktop\\\\SCRNSAVE.EXE\" 55- Scheduled Task - File Access In order to gain persistence, privilege escalation, or remote execution, an adversary may use the Windows Task Scheduler to schedule a command to be run at a specified time, date, and even host. Task Scheduler stores tasks as files in two locations - C:\\Windows\\Tasks (legacy) or C:\\Windows\\System32\\Tasks. Accordingly, this analytic looks for the creation of task files in these two locations.\nindex=__your_sysmon_index__ EventCode=11 Image!=\"C:\\\\WINDOWS\\\\system32\\\\svchost.exe\" (TargetFilename=\"C:\\\\Windows\\\\System32\\\\Tasks\\\\*\" OR TargetFilename=\"C:\\\\Windows\\\\Tasks\\\\*\") 56- Component Object Model Hijacking Adversaries may establish persistence or escalate privileges by executing malicious content triggered by hijacked references to Component Object Model (COM) objects. This is typically done by replacing COM object registry entries under the HKEY_CURRENT_USER\\Software\\Classes\\CLSID or HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID keys. Accordingly, this analytic looks for any changes under these keys.\nindex=__your_sysmon_index__ (EventCode=12 OR EventCode=13 OR EventCode=14) TargetObject=\"*\\\\Software\\\\Classes\\\\CLSID\\\\*\" 57- Indicator Blocking - Driver Unloaded Adversaries may attempt to evade system defenses by unloading minifilter drivers used by host-based sensors such as Sysmon through the use of the fltmc command-line utility. Accordingly, this analytic looks for command-line invocations of this utility when used to unload minifilter drivers.\nindex=client EventCode=1 CommandLine=\"*unload*\" (Image=\"C:\\\\Windows\\\\SysWOW64\\\\fltMC.exe\" OR Image=\"C:\\\\Windows\\\\System32\\\\fltMC.exe\") 58- Credentials in Files \u0026 Registry Adversaries may search the Windows Registry on compromised systems for insecurely stored credentials for credential access. This can be accomplished using the query functionality of the reg.exe system utility, by looking for keys and values that contain strings such as “password”. In addition, adversaries may use toolkits such as PowerSploit in order to dump credentials from various applications such as IIS.Accordingly, this analytic looks for invocations of reg.exe in this capacity as well as that of several powersploit modules with similar functionality.\n((index=__your_sysmon_index__ EventCode=1) OR (index=__your_win_syslog_index__ EventCode=4688)) (CommandLine=\"*reg* query HKLM /f password /t REG_SZ /s*\" OR CommandLine=\"reg* query HKCU /f password /t REG_SZ /s\" OR CommandLine=\"*Get-UnattendedInstallFile*\" OR CommandLine=\"*Get-Webconfig*\" OR CommandLine=\"*Get-ApplicationHost*\" OR CommandLine=\"*Get-SiteListPassword*\" OR CommandLine=\"*Get-CachedGPPPassword*\" OR CommandLine=\"*Get-RegistryAutoLogon*\") 59- AppInit DLLs Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by AppInit DLLs loaded into processes. Dynamic-link libraries (DLLs) that are specified in the AppInit_DLLs value in the Registry keys HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows or HKEY_LOCAL_MACHINE\\Software\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows are loaded by user32.dll into every process that loads user32.dll. These values can be abused to obtain elevated privileges by causing a malicious DLL to be loaded and run in the context of separate processes. Accordingly, this analytic looks for modifications to these registry keys that may be indicative of this type of abuse.\nindex=__your_sysmon_index__ (EventCode=12 OR EventCode=13 OR EventCode=14) (TargetObject=\"*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Appinit_Dlls\\\\*\" OR TargetObject=\"*\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Appinit_Dlls\\\\*\") 60- NTFS Alternate Data Stream Execution - System Utilities NTFS Alternate Data Streams (ADSs) may be used by adversaries as a means of evading security tools by storing malicious data or binaries in file attribute metadata. ADSs are also powerful because they can be directly executed by various Windows tools; accordingly, this analytic looks at common ways of executing ADSs using system utilities such as powershell.\nNTFS ADS - PowerShell\nindex=__sysmon_index__ EventCode=1 Image=C:\\\\Windows\\\\*\\\\powershell.exe|regex CommandLine=\"Invoke-CimMethod\\s+-ClassName\\s+Win32_Process\\s+-MethodName\\s+Create.*\\b(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)|-ep bypass\\s+-\\s+\u003c.*\\b(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)|-command.*Get-Content.*-Stream.*Set-Content.*start-process .*(\\w+(\\.\\w+)?)\"NTFS ADS - wmic NTFS ADS - wmic\nindex=__sysmon_index__ EventCode=1 Image=C:\\\\Windows\\\\*\\\\wmic.exe | regex CommandLine=\"process call create.*\\\"(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)\" NTFS ADS - rundll32\nindex=__sysmon_index__ EventCode=1 Image=C:\\\\Windows\\\\*\\\\rundll32.exe | regex CommandLine=\"\\\"?(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)?\\\"?,\\w+\\|(advpack\\.dll\\|ieadvpack\\.dll),RegisterOCX\\s+(\\w+\\.\\w+):(\\w+(\\.\\w+)?)\\|(shdocvw\\.dll\\|ieframe\\.dll),OpenURL.*(\\w+\\.\\w+):(\\w+(\\.\\w+)?)\" NTFS ADS - wscript/cscript\nindex=__sysmon_index__ EventCode=1 (Image=C:\\\\Windows\\\\*\\\\wscript.exe OR Image=C:\\\\Windows\\\\*\\\\cscript.exe) | regex CommandLine=\"(?\u003c!\\/)\\b\\w+(\\.\\w+)?:\\w+(\\.\\w+)?$\" 61- NTFS Alternate Data Stream Execution - LOLBAS NTFS Alternate Data Streams (ADSs) may be used by adversaries as a means of evading security tools by storing malicious data or binaries in file attribute metadata. ADSs are also powerful because their contents can be directly executed by various Windows tools; accordingly, this analytic looks at common ways of executing ADSs using Living off the Land Binaries and Scripts (LOLBAS).\nNTFS ADS - control\nindex=__sysmon_index__ EventCode=1 (Image=C:\\\\Windows\\System32\\\\control.exe OR Image=C:\\\\Windows\\SysWOW64\\\\control.exe) | regex CommandLine=\"(\\w+(\\.\\w+)?):(\\w+\\.dll)\" NTFS ADS - appvlp\nindex=__sysmon_index__ EventCode=1 (Image=\"C:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Client\\\\AppVLP.exe\" OR Image=\"C:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\Client\\\\AppVLP.exe\") | regex CommandLine=\"(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)\" NTFS ADS - cmd\nindex=__sysmon_index__ EventCode=1 (Image=C:\\\\Windows\\\\System32\\\\cmd.exe OR Image=C:\\\\Windows\\\\SysWOW64\\\\cmd.exe) | regex CommandLine=\"-\\s+\u003c.*\\b(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)\" NTFS ADS - ftp\nindex=__sysmon_index__ EventCode=1 (Image=C:\\\\Windows\\\\System32\\\\ftp.exe OR Image=C:\\\\Windows\\\\SysWOW64\\\\ftp.exe) | regex CommandLine=\"-s:(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)\" NTFS ADS - bash\nindex=__sysmon_index__ EventCode=1 (Image=C:\\\\Windows\\\\System32\\\\bash.exe OR C:\\\\Windows\\\\SysWOW64\\\\bash.exe) | regex CommandLine=\"-c.*(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)\" NTFS ADS - mavinject\nindex=__sysmon_index__ EventCode=1 (Image=C:\\\\Windows\\\\System32\\\\mavinject.exe OR C:\\\\Windows\\\\SysWOW64\\\\mavinject.exe) | regex CommandLine=\"\\d+\\s+\\/INJECTRUNNING.*\\b(\\w+(\\.\\w+)?):(\\w+(\\.\\w+)?)\" NTFS ADS - bitsadmin\nindex=__sysmon_index__ EventCode=1 (Image=C:\\\\Windows\\\\System32\\\\bitsadmin.exe OR C:\\\\Windows\\\\SysWOW64\\\\bitsadmin.exe) | regex CommandLine=\"\\/create.*\\/addfile.*\\/SetNotifyCmdLine.*\\b(\\w+\\.\\w+):(\\w+(\\.\\w+)?)\" 62- Execution with AT In order to gain persistence, privilege escalation, or remote execution, an adversary may use the Windows built-in command AT (at.exe) to schedule a command to be run at a specified time, date, and even host. This method has been used by adversaries and administrators alike. Its use may lead to detection of compromised hosts and compromised users if it is used to move laterally. The built-in Windows tool schtasks.exe (CAR-2013-08-001) offers greater flexibility when creating, modifying, and enumerating tasks. For these reasons, schtasks.exe is more commonly used by administrators, tools/scripts, and power users.\nindex=__your_sysmon_index__ Image=\"C:\\\\Windows\\\\*\\\\at.exe\"|stats values(CommandLine) as \"Command Lines\" by ComputerName 63- Running executables with same hash and different names Executables are generally not renamed, thus a given hash of an executable should only have ever one name. Identifying instances where multiple process names share the same hash may find cases where tools are copied by attackers to different folders or hosts to avoid detection.\nAlthough this analytic was initially based on MD5 hashes, it is equally applicable to any hashing convention.\nindex=__your_sysmon_index__ EventCode=1|stats dc(Hashes) as Num_Hashes values(Hashes) as \"Hashes\" by Image|where Num_Hashes \u003e 1 64- Suspicious Arguments Malicious actors may rename built-in commands or external tools, such as those provided by SysInternals, to better blend in with the environment. In those cases, the file path name is arbitrary and may blend in well with the background. If the arguments are closely inspected, it may be possible to infer what tools are running and understand what an adversary is doing. When any legitimate software shares the same command lines, it must be whitelisted according to the expected parameters.\nindex=__your_sysmon_index__ EventCode=1 (CommandLine=\"* -R * -pw*\" OR CommandLine=\"* -pw * *@*\" OR CommandLine=\"*sekurlsa*\" OR CommandLine=\"* -hp *\" OR CommandLine=\"* a *\") 65- User Login Activity Monitoring Monitoring logon and logoff events for hosts on the network is very important for situational awareness. This information can be used as an indicator of unusual activity as well as to corroborate activity seen elsewhere.\nCould be applied to a number of different types of monitoring depending on what information is desired. Some use cases include monitoring for all remote connections and building login timelines for users. Logon events are Windows Event Code 4624 for Windows Vista and above, 518 for pre-Vista. Logoff events are 4634 for Windows Vista and above, 538 for pre-Vista.\nindex=__your_win_event_log_index__ EventCode=4624|search NOT [search index=__your_win_event_log_index__ EventCode=4624|top 30 Account_Name|table Account_Name] 66- PowerShell Execution PowerShell is a scripting environment included with Windows that is used by both attackers and administrators. Execution of PowerShell scripts in most Windows versions is opaque and not typically secured by antivirus which makes using PowerShell an easy way to circumvent security measures. This analytic detects execution of PowerShell scripts.\nPowershell can be used to hide monitored command line execution such as:\nnet use sc start index=__your_sysmon_index__ EventCode=1 Image=\"C:\\\\Windows\\\\*\\\\powershell.exe\" ParentImage!=\"C:\\\\Windows\\\\explorer.exe\"|stats values(CommandLine) as \"Command Lines\" values(ParentImage) as \"Parent Images\" by ComputerName 67- Services launching Cmd Windows runs the Service Control Manager (SCM) within the process services.exe. Windows launches services as independent processes or DLL loads within a svchost.exe group. To be a legitimate service, a process (or DLL) must have the appropriate service entry point SvcMain. If an application does not have the entry point, then it will timeout (default is 30 seconds) and the process will be killed.\nTo survive the timeout, adversaries and red teams can create services that direct to cmd.exe with the flag /c, followed by the desired command. The /c flag causes the command shell to run a command and immediately exit. As a result, the desired program will remain running and it will report an error starting the service. This analytic will catch that command prompt instance that is used to launch the actual malicious executable. Additionally, the children and descendants of services.exe will run as a SYSTEM user by default. Thus, services are a convenient way for an adversary to gain Persistence and Privilege Escalation.\nindex=__your_sysmon_index__ EventCode=1 Image=\"C:\\\\Windows\\\\*\\\\cmd.exe\" ParentImage=\"C:\\\\Windows\\\\*\\\\services.exe\" 68- Command Launched from WinLogon An adversary can use accessibility features (Ease of Access), such as StickyKeys or Utilman, to launch a command shell from the logon screen and gain SYSTEM access. Since an adversary does not have physical access to the machine, this technique must be run within Remote Desktop. To prevent an adversary from getting to the login screen without first authenticating, Network-Level Authentication (NLA) must be enabled. If a debugger is set up for one of the accessibility features, then it will intercept the process launch of the feature and instead execute a new command line. This analytic looks for instances of cmd.exe or powershell.exe launched directly from the logon process, winlogon.exe. It should be used in tandem with CAR-2014-11-003, which detects the accessibility programs in the command line.\nindex=__your_sysmon_index__ EventCode=1 ParentImage=\"C:\\\\Windows\\\\*\\\\winlogon.exe\" Image=\"C:\\\\Windows\\\\*\\\\cmd.exe\" 69- Host Discovery Commands When entering on a host for the first time, an adversary may try to discover information about the host. There are several built-in Windows commands that can be used to learn about the software configurations, active users, administrators, and networking configuration. These commands should be monitored to identify when an adversary is learning information about the system and environment. The information returned may impact choices an adversary can make when establishing persistence, escalating privileges, or moving laterally.\nBecause these commands are built in, they may be run frequently by power users or even by normal users. Thus, an analytic looking at this information should have well-defined white- or blacklists, and should consider looking at an anomaly detection approach, so that this information can be learned dynamically.\nindex=__your_sysmon_index__ EventCode=1 (Image=\"C:\\\\Windows\\\\*\\\\hostname.exe\" OR Image=\"C:\\\\Windows\\\\*\\\\ipconfig.exe\" OR Image=\"C:\\\\Windows\\\\*\\\\net.exe\" OR Image=\"C:\\\\Windows\\\\*\\\\quser.exe\" OR Image=\"C:\\\\Windows\\\\*\\\\qwinsta.exe\" OR (Image=\"C:\\\\Windows\\\\*\\\\sc.exe\" AND (CommandLine=\"* query *\" OR CommandLine=\"* qc *\")) OR Image=\"C:\\\\Windows\\\\*\\\\systeminfo.exe\" OR Image=\"C:\\\\Windows\\\\*\\\\tasklist.exe\" OR Image=\"C:\\\\Windows\\\\*\\\\whoami.exe\")|stats values(Image) as \"Images\" values(CommandLine) as \"Command Lines\" by ComputerName 70- Create Remote Process via WMIC Adversaries may use Windows Management Instrumentation (WMI) to move laterally, by launching executables remotely.The analytic CAR-2014-12-001 describes how to detect these processes with network traffic monitoring and process monitoring on the target host. However, if the command line utility wmic.exe is used on the source host, then it can additionally be detected on an analytic. The command line on the source host is constructed into something like wmic.exe /node:\"\\\" process call create \"\\\". It is possible to also connect via IP address, in which case the string \"\\\" would instead look like IP Address.\nAlthough this analytic was created after CAR-2014-12-001, it is a much simpler (although more limited) approach. Processes can be created remotely via WMI in a few other ways, such as more direct API access or the built-in utility\nindex=__your_sysmon_index__ EventCode=1 Image=\"C:\\\\Windows\\\\*\\\\wmic.exe\" CommandLine=\"* process call create *\"|search CommandLine=\"* /node:*\" 71- UAC Bypass Bypassing user account control (UAC Bypass) is generally done by piggybacking on a system process that has auto-escalate privileges. This analytic looks to detect those cases as described by the open-source UACME tool.\nindex=_your_sysmon_index_ EventCode=1 IntegrityLevel=High|search (ParentCommandLine=\"\\\"c:\\\\windows\\\\system32\\\\dism.exe\\\"*\"\"*.xml\" AND Image!=\"c:\\\\users\\\\*\\\\appdata\\\\local\\\\temp\\\\*\\\\dismhost.exe\") OR ParentImage=c:\\\\windows\\\\system32\\\\fodhelper.exe OR (CommandLine=\"\\\"c:\\\\windows\\\\system32\\\\wusa.exe\\\"*/quiet*\" AND User!=NOT_TRANSLATED AND CurrentDirectory=c:\\\\windows\\\\system32\\\\ AND ParentImage!=c:\\\\windows\\\\explorer.exe) OR CommandLine=\"*.exe\\\"*cleanmgr.exe /autoclean*\" OR (ParentImage=\"c:\\\\windows\\\\*dccw.exe\" AND Image!=\"c:\\\\windows\\\\system32\\\\cttune.exe\") OR Image=\"c:\\\\program files\\\\windows media player\\\\osk.exe\" OR ParentImage=\"c:\\\\windows\\\\system32\\\\slui.exe\"|eval PossibleTechniques=case(like(lower(ParentCommandLine),\"%c:\\\\windows\\\\system32\\\\dism.exe%\"), \"UACME #23\", like(lower(Image),\"c:\\\\program files\\\\windows media player\\\\osk.exe\"), \"UACME #32\", like(lower(ParentImage),\"c:\\\\windows\\\\system32\\\\fodhelper.exe\"), \"UACME #33\", like(lower(CommandLine),\"%.exe\\\"%cleanmgr.exe /autoclean%\"), \"UACME #34\", like(lower(Image),\"c:\\\\windows\\\\system32\\\\wusa.exe\"), \"UACME #36\", like(lower(ParentImage),\"c:\\\\windows\\\\%dccw.exe\"), \"UACME #37\", like(lower(ParentImage),\"c:\\\\windows\\\\system32\\\\slui.exe\"), \"UACME #45\") 72- Generic Regsvr32 Regsvr32 can be used to execute arbitrary code in the context of a Windows signed binary, which can be used to bypass application whitelisting. This analytic looks for suspicious usage of the tool. It’s not likely that you’ll get millions of hits, but it does occur during normal activity so some form of baselining would be necessary for this to be an alerting analytic. Alternatively, it can be used for hunt by looking for new or anomalous DLLs manually.\nindex=__your_sysmon_data__ EventCode=1 regsvr32.exe | search ParentImage=\"*regsvr32.exe\" AND Image!=\"*regsvr32.exe*\" 73- Squiblydoo Squiblydoo is a specific usage of regsvr32.dll to load a COM scriptlet directly from the internet and execute it in a way that bypasses application whitelisting. It can be seen by looking for regsvr32.exe executions that load the scrobj.dll (which execute the COM scriptlet) or, if that is too noisy, those that also load content directly via HTTP or HTTPS.\nSquiblydoo was first written up by Casey Smith at Red Canary, though that blog post is no longer accessible.\nindex=__your_sysmon_events__ EventCode=1 regsvr32.exe scrobj.dll | search Image=\"*regsvr32.exe\" 74- Credential Dumping via Mimikatz Credential dumpers like Mimikatz can be loaded into memory and from there read data from another processes. This analytic looks for instances where processes are requesting specific permissions to read parts of the LSASS process in order to detect when credential dumping is occurring. One weakness is that all current implementations are “overtuned” to look for common access patterns used by Mimikatz.\nindex=__your_sysmon_data__ EventCode=10 TargetImage=\"C:\\\\WINDOWS\\\\system32\\\\lsass.exe\" (GrantedAccess=0x1410 OR GrantedAccess=0x1010 OR GrantedAccess=0x1438 OR GrantedAccess=0x143a OR GrantedAccess=0x1418) CallTrace=\"C:\\\\windows\\\\SYSTEM32\\\\ntdll.dll+*|C:\\\\windows\\\\System32\\\\KERNELBASE.dll+20edd|UNKNOWN(*)\" | table _time hostname user SourceImage GrantedAccess 75- Access Permission Modification Adversaries sometimes modify object access rights at the operating system level. There are varying motivations behind this action - they may not want some files/objects to be changed on systems for persistence reasons and therefore provide admin only rights; also, they may want files to be accessible with lower levels of permissions.\nindex=__your_windows_security_log_index__ EventCode=4670 Object_Type=\"File\" Security_ID!=\"NT AUTHORITY\\\\SYSTEM\" 76- Lsass Process Dump via Procdump ProcDump is a sysinternal command-line utility whose primary purpose is monitoring an application for CPU spikes and generating crash dumps during a spike that an administrator or developer can use to determine the cause of the spike.\nProcDump may be used to dump the memory space of lsass.exe to disk for processing with a credential access tool such as Mimikatz. This is performed by launching procdump.exe as a privileged user with command line options indicating that lsass.exe should be dumped to a file with an arbitrary name.\nindex=__your_sysmon_index__ EventCode=1 Image=\"*\\\\procdump*.exe\" CommandLine=\"*lsass*\" 77- Credential Dumping via Windows Task Manager The Windows Task Manager may be used to dump the memory space of lsass.exe to disk for processing with a credential access tool such as Mimikatz. This is performed by launching Task Manager as a privileged user, selecting lsass.exe, and clicking “Create dump file”. This saves a dump file to disk with a deterministic name that includes the name of the process being dumped.\nindex=__your_sysmon_index__ EventCode=11 TargetFilename=\"*lsass*.dmp\" Image=\"C:\\\\Windows\\\\*\\\\taskmgr.exe\" 78- Active Directory Dumping via NTDSUtil The NTDSUtil tool may be used to dump a Microsoft Active Directory database to disk for processing with a credential access tool such as Mimikatz. This is performed by launching ntdsutil.exe as a privileged user with command line arguments indicating that media should be created for offline Active Directory installation and specifying a folder path. This process will create a copy of the Active Directory database, ntds.dit, to the specified folder path.\nindex=__your_sysmon_index__ EventCode=11 TargetFilename=\"*ntds.dit\" Image=\"*ntdsutil.exe\" 79- Shadow Copy Deletion The Windows Volume Shadow Copy Service is a built-in OS feature that can be used to create backup copies of files and volumes.\nAdversaries may delete these shadow copies, typically through the usage of system utilities such as vssadmin.exe or wmic.exe, in order prevent file and data recovery. This technique is commonly employed for this purpose by ransomware.\nVssadmin.exe delete shadows\nindex=__your_sysmon_index__ EventCode=1 Image=\"C:\\\\Windows\\\\System32\\\\vssadmin.exe\" CommandLine=\"*delete shadows*\" WMIC shadowcopy delete\nindex=__your_sysmon_index__ EventCode=1 Image=\"C:\\\\Windows\\\\*\\\\wmic.exe\" CommandLine=\"*shadowcopy delete*\" 80- MiniDump of LSASS This analytic detects the minidump variant of credential dumping where a process opens lsass.exe in order to extract credentials using the Win32 API call MiniDumpWriteDump. Tools like SafetyKatz, SafetyDump, and Outflank-Dumpert default to this variant and may be detected by this analytic, though keep in mind that not all options for using those tools will result in this specific behavior.\nThe analytic is based on a Sigma analytic contributed by Samir Bousseaden and written up in a blog on MENASEC. It looks for a call trace that includes either dbghelp.dll or dbgcore.dll, which export the relevant functions/permissions to perform the dump. It also detects using the Windows Task Manager (taskmgr.exe) to dump lsass, which is described in CAR-2019-08-001. In this iteration of the Sigma analytic, the GrantedAccess filter isn’t included because it didn’t seem to filter out any false positives and introduces the potential for evasion.\nindex=__your_sysmon_index__ EventCode=10 TargetImage=\"C:\\\\windows\\\\system32\\\\lsass.exe\" (CallTrace=\"*dbghelp.dll*\" OR CallTrace=\"*dbgcore.dll*\")| table _time host SourceProcessId SourceImage 81- Rare LolBAS Command Lines LoLBAS are binaries and scripts that are built in to Windows, frequently are signed by Microsoft, and may be used by an attacker. Some LoLBAS are used very rarely and it might be possible to alert every time they’re used (this would depend on your environment), but many others are very common and can’t be simply alerted on.\nThis analytic takes all instances of LoLBAS execution and then looks for instances of command lines that are not normal in the environment. This can detect attackers (which will tend to need the binaries for something different than normal usage) but will also tend to have false positives.\nThe analytic needs to be tuned. The 1.5 in the query is the number of standard deviations away to look. It can be tuned up to filter out more noise and tuned down to get more results. This means it is probably best as a hunting analytic when you have analysts looking at the screen and able to tune the analytic up and down, because the threshold may not be stable for very long.\nindex=__your_sysmon_index__ EventCode=1 (OriginalFileName = At.exe OR OriginalFileName = Atbroker.exe OR OriginalFileName = Bash.exe OR OriginalFileName = Bitsadmin.exe OR OriginalFileName = Certutil.exe OR OriginalFileName = Cmd.exe OR OriginalFileName = Cmdkey.exe OR OriginalFileName = Cmstp.exe OR OriginalFileName = Control.exe OR OriginalFileName = Csc.exe OR OriginalFileName = Cscript.exe OR OriginalFileName = Dfsvc.exe OR OriginalFileName = Diskshadow.exe OR OriginalFileName = Dnscmd.exe OR OriginalFileName = Esentutl.exe OR OriginalFileName = Eventvwr.exe OR OriginalFileName = Expand.exe OR OriginalFileName = Extexport.exe OR OriginalFileName = Extrac32.exe OR OriginalFileName = Findstr.exe OR OriginalFileName = Forfiles.exe OR OriginalFileName = Ftp.exe OR OriginalFileName = Gpscript.exe OR OriginalFileName = Hh.exe OR OriginalFileName = Ie4uinit.exe OR OriginalFileName = Ieexec.exe OR OriginalFileName = Infdefaultinstall.exe OR OriginalFileName = Installutil.exe OR OriginalFileName = Jsc.exe OR OriginalFileName = Makecab.exe OR OriginalFileName = Mavinject.exe OR OriginalFileName = Microsoft.Workflow.r.exe OR OriginalFileName = Mmc.exe OR OriginalFileName = Msbuild.exe OR OriginalFileName = Msconfig.exe OR OriginalFileName = Msdt.exe OR OriginalFileName = Mshta.exe OR OriginalFileName = Msiexec.exe OR OriginalFileName = Odbcconf.exe OR OriginalFileName = Pcalua.exe OR OriginalFileName = Pcwrun.exe OR OriginalFileName = Presentationhost.exe OR OriginalFileName = Print.exe OR OriginalFileName = Reg.exe OR OriginalFileName = Regasm.exe OR OriginalFileName = Regedit.exe OR OriginalFileName = Register-cimprovider.exe OR OriginalFileName = Regsvcs.exe OR OriginalFileName = Regsvr32.exe OR OriginalFileName = Replace.exe OR OriginalFileName = Rpcping.exe OR OriginalFileName = Rundll32.exe OR OriginalFileName = Runonce.exe OR OriginalFileName = Runscripthelper.exe OR OriginalFileName = Sc.exe OR OriginalFileName = Schtasks.exe OR OriginalFileName = Scriptrunner.exe OR OriginalFileName = SyncAppvPublishingServer.exe OR OriginalFileName = Tttracer.exe OR OriginalFileName = Verclsid.exe OR OriginalFileName = Wab.exe OR OriginalFileName = Wmic.exe OR OriginalFileName = Wscript.exe OR OriginalFileName = Wsreset.exe OR OriginalFileName = Xwizard.exe OR OriginalFileName = Advpack.dll OR OriginalFileName = Comsvcs.dll OR OriginalFileName = Ieadvpack.dll OR OriginalFileName = Ieaframe.dll OR OriginalFileName = Mshtml.dll OR OriginalFileName = Pcwutl.dll OR OriginalFileName = Setupapi.dll OR OriginalFileName = Shdocvw.dll OR OriginalFileName = Shell32.dll OR OriginalFileName = Syssetup.dll OR OriginalFileName = Url.dll OR OriginalFileName = Zipfldr.dll OR OriginalFileName = Appvlp.exe OR OriginalFileName = Bginfo.exe OR OriginalFileName = Cdb.exe OR OriginalFileName = csi.exe OR OriginalFileName = Devtoolslauncher.exe OR OriginalFileName = dnx.exe OR OriginalFileName = Dxcap.exe OR OriginalFileName = Excel.exe OR OriginalFileName = Mftrace.exe OR OriginalFileName = Msdeploy.exe OR OriginalFileName = msxsl.exe OR OriginalFileName = Powerpnt.exe OR OriginalFileName = rcsi.exe OR OriginalFileName = Sqler.exe OR OriginalFileName = Sqlps.exe OR OriginalFileName = SQLToolsPS.exe OR OriginalFileName = Squirrel.exe OR OriginalFileName = te.exe OR OriginalFileName = Tracker.exe OR OriginalFileName = Update.exe OR OriginalFileName = vsjitdebugger.exe OR OriginalFileName = Winword.exe OR OriginalFileName = Wsl.exe OR OriginalFileName = CL_Mutexverifiers.ps1 OR OriginalFileName = CL_Invocation.ps1 OR OriginalFileName = Manage-bde.wsf OR OriginalFileName = Pubprn.vbs OR OriginalFileName = Slmgr.vbs OR OriginalFileName = Syncappvpublishingserver.vbs OR OriginalFileName = winrm.vbs OR OriginalFileName = Pester.bat)|eval CommandLine=lower(CommandLine)|eventstats count(process) as procCount by process|eventstats avg(procCount) as avg stdev(procCount) as stdev|eval lowerBound=(avg-stdev*1.5)|eval isOutlier=if((procCount \u003c lowerBound),1,0)|where isOutlier=1|table host, Image, ParentImage, CommandLine, ParentCommandLine, procCount References:\nSplunk How-To\ncar.mitre.org\nAnalytics\n","wordCount":"7190","inLanguage":"en","image":"https://classroom.anir0y.in/img/soc-101.png","datePublished":"2023-04-10T19:27:17+05:30","dateModified":"2023-04-10T19:27:17+05:30","author":{"@type":"Person","name":"Animesh Roy"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://classroom.anir0y.in/post/soc-splunk101/"},"publisher":{"@type":"Organization","name":"Classroom","logo":{"@type":"ImageObject","url":"https://classroom.anir0y.in/img/avatar.jpeg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://classroom.anir0y.in/ accesskey=h title="Classroom (Alt + H)"><img src=https://classroom.anir0y.in/img/avatar.jpeg alt aria-label=logo height=35>Classroom</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://classroom.anir0y.in/post/ title=Posts><span>Posts</span></a></li><li><a href=https://classroom.anir0y.in/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://classroom.anir0y.in/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://classroom.anir0y.in/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://classroom.anir0y.in/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://classroom.anir0y.in/about/me/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://classroom.anir0y.in/>Home</a>&nbsp;»&nbsp;<a href=https://classroom.anir0y.in/post/>Posts</a></div><h1 class="post-title entry-hint-parent">SOC Splunk101</h1><div class=post-description>More than 80 Use Cases for Splunk.</div><div class=post-meta><span title='2023-04-10 19:27:17 +0530 IST'>April 10, 2023</span>&nbsp;·&nbsp;<span>34 min</span>&nbsp;·&nbsp;<span>Animesh Roy</span>&nbsp;|&nbsp;<span>
<a href=https://github.com/anir0y/classroom/tree/master/content/post/soc-splunk101.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></span></div></header><figure class=entry-cover><img loading=eager src=https://classroom.anir0y.in/img/soc-101.png alt="cover image"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#some-use-cases-for-splunk>some Use Cases for Splunk.</a><ul><li><a href=#1--windows-audit-log-tampering>1- Windows Audit Log Tampering</a></li><li><a href=#2--finding-large-web-uploads>2- Finding Large Web Uploads</a></li><li><a href=#3--detecting-recurring-malware-on-host>3- Detecting Recurring Malware on Host</a></li><li><a href=#4-detecting-brute-force-attacks>4-Detecting Brute Force Attacks</a></li><li><a href=#5--detecting-unencrypted-web-communications>5- Detecting Unencrypted Web Communications</a></li><li><a href=#6--identifying-web-users-by-country>6- Identifying Web Users By Country</a></li><li><a href=#7--identifying-slow-web-content>7- Identifying Slow Web Content</a></li><li><a href=#8--finding-new-local-admin-accounts>8- Finding New Local Admin Accounts</a></li><li><a href=#9--finding-interactive-logins-from-service-accounts>9- Finding Interactive Logins From Service Accounts</a></li><li><a href=#10--log-volume-trending>10- Log Volume Trending</a></li><li><a href=#11--basic-tor-traffic-detection>11- Basic TOR Traffic Detection</a></li><li><a href=#12--measuring-storage-io-latency>12- Measuring Storage I/O Latency</a></li><li><a href=#13--measuring-storage-speed-io-utilization-by-host>13- Measuring Storage Speed I/O Utilization by Host</a></li><li><a href=#14--measuring-memory-utilization-by-host>14- Measuring Memory Utilization by Host</a></li><li><a href=#15--rogue-dns-detection>15- Rogue DNS detection</a></li><li><a href=#16--suspicious-powershell-commands>16- Suspicious PowerShell Commands</a></li><li><a href=#17--windows-audit-log-cleared>17- Windows audit log cleared</a></li><li><a href=#18--detecting-network-and-port-scanning>18- Detecting Network and Port Scanning</a></li><li><a href=#19--unusual-access>19- Unusual Access</a></li><li><a href=#20--malware-attack>20- Malware Attack</a></li><li><a href=#21-attempt-to-add-certificate-to-untrusted-store>21-Attempt To Add Certificate To Untrusted Store</a></li><li><a href=#22--batch-file-write-to-system32>22**- Batch File Write to System32**</a></li><li><a href=#23--bcdedit-failure-recovery-modification>23- BCDEdit Failure Recovery Modification</a></li><li><a href=#24--bits-job-persistence>24- BITS Job Persistence</a></li><li><a href=#25--bitsadmin-download-file>25- BITSAdmin Download File</a></li><li><a href=#26--certutil-download-with-urlcache-and-split-arguments>26- CertUtil Download With URLCache and Split Arguments</a></li><li><a href=#27--certutil-download-with-verifyctl-and-split-arguments>27- CertUtil Download With VerifyCtl and Split Arguments</a></li><li><a href=#28--certutil-exe-certificate-extraction>28- Certutil exe certificate extraction</a></li><li><a href=#29--certutil-with-decode-argument>29- CertUtil With Decode Argument</a></li><li><a href=#30--create-local-admin-accounts-using-net-exe>30- Create local admin accounts using net exe</a></li><li><a href=#31--create-remote-thread-into-lsass>31- Create Remote Thread into LSASS</a></li><li><a href=#32--create-service-in-suspicious-file-path>32- Create Service In Suspicious File Path</a></li><li><a href=#33--common-windows-process-masquerading>33- Common Windows Process Masquerading</a></li><li><a href=#34--unusual-child-process-spawned-using-dde-exploit>34- Unusual Child Process spawned using DDE exploit</a></li><li><a href=#35--detecting-tampering-of-windows-defender-command-prompt>35- Detecting Tampering of Windows Defender Command Prompt</a></li><li><a href=#36--disable-uac>36- Disable UAC</a></li><li><a href=#37--identifying-port-scanning-activity>37- Identifying Port Scanning Activity</a></li><li><a href=#38--unusually-long-command-line-strings>38- Unusually Long Command Line Strings</a></li><li><a href=#39--clearing-windows-logs-with-wevtutil>39- Clearing Windows Logs with Wevtutil</a></li><li><a href=#40--unusual-child-process-for-spoolsvexe-or-connhostexe>40- Unusual Child Process for Spoolsv.Exe or Connhost.Exe</a></li><li><a href=#41--detecting-shadow-copy-deletion-via-vssadminexe>41- Detecting Shadow Copy Deletion via Vssadmin.exe</a></li><li><a href=#42--webshell-indicative-process-tree>42- Webshell-Indicative Process Tree</a></li><li><a href=#43--get-system-elevation>43- Get System Elevation</a></li><li><a href=#44--boot-or-logon-initialization-scripts>44- Boot or Logon Initialization Scripts</a></li><li><a href=#45--local-network-sniffing>45- Local Network Sniffing</a></li><li><a href=#46--dll-injection-with-mavinject>46- DLL Injection with Mavinject</a></li><li><a href=#47--processes-started-from-irregular-parent>47- Processes Started From Irregular Parent</a></li><li><a href=#48--clear-powershell-console-command-history>48- Clear Powershell Console Command History</a></li><li><a href=#49--local-permission-group-discovery>49- Local Permission Group Discovery</a></li><li><a href=#50--network-share-connection-removal>50- Network Share Connection Removal</a></li><li><a href=#51--msbuild-and-msxsl>51- MSBuild and msxsl</a></li><li><a href=#52--compiled-html-access>52- Compiled HTML Access</a></li><li><a href=#53--cmstp>53- CMSTP</a></li><li><a href=#54--registry-edit-from-screensaver>54- Registry Edit from Screensaver</a></li><li><a href=#55--scheduled-task---file-access>55- Scheduled Task - File Access</a></li><li><a href=#56--component-object-model-hijacking>56- Component Object Model Hijacking</a></li><li><a href=#57--indicator-blocking---driver-unloaded>57- Indicator Blocking - Driver Unloaded</a></li><li><a href=#58--credentials-in-files--registry>58- Credentials in Files & Registry</a></li><li><a href=#59--appinit-dlls>59- AppInit DLLs</a></li><li><a href=#60--ntfs-alternate-data-stream-execution---system-utilities>60- NTFS Alternate Data Stream Execution - System Utilities</a></li><li><a href=#61--ntfs-alternate-data-stream-execution---lolbas>61- NTFS Alternate Data Stream Execution - LOLBAS</a></li><li><a href=#62--execution-with-at>62- Execution with AT</a></li><li><a href=#63--running-executables-with-same-hash-and-different-names>63- Running executables with same hash and different names</a></li><li><a href=#64--suspicious-arguments>64- Suspicious Arguments</a></li><li><a href=#65--user-login-activity-monitoring>65- User Login Activity Monitoring</a></li><li><a href=#66--powershell-execution>66- PowerShell Execution</a></li><li><a href=#67--services-launching-cmd>67- Services launching Cmd</a></li><li><a href=#68--command-launched-from-winlogon>68- Command Launched from WinLogon</a></li><li><a href=#69--host-discovery-commands>69- Host Discovery Commands</a></li><li><a href=#70--create-remote-process-via-wmic>70- Create Remote Process via WMIC</a></li><li><a href=#71--uac-bypass>71- UAC Bypass</a></li><li><a href=#72--generic-regsvr32>72- Generic Regsvr32</a></li><li><a href=#73--squiblydoo>73- Squiblydoo</a></li><li><a href=#74--credential-dumping-via-mimikatz>74- Credential Dumping via Mimikatz</a></li><li><a href=#75--access-permission-modification>75- Access Permission Modification</a></li><li><a href=#76--lsass-process-dump-via-procdump>76- Lsass Process Dump via Procdump</a></li><li><a href=#77--credential-dumping-via-windows-task-manager>77- Credential Dumping via Windows Task Manager</a></li><li><a href=#78--active-directory-dumping-via-ntdsutil>78- Active Directory Dumping via NTDSUtil</a></li><li><a href=#79--shadow-copy-deletion>79- Shadow Copy Deletion</a></li><li><a href=#80--minidump-of-lsass>80- MiniDump of LSASS</a></li><li><a href=#81--rare-lolbas-command-lines>81- Rare LolBAS Command Lines</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=some-use-cases-for-splunk>some Use Cases for Splunk.<a hidden class=anchor aria-hidden=true href=#some-use-cases-for-splunk>#</a></h2><h3 id=1--windows-audit-log-tampering>1- Windows Audit Log Tampering<a hidden class=anchor aria-hidden=true href=#1--windows-audit-log-tampering>#</a></h3><p>Check for any tampering done to Windows audit logs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=p>(</span><span class=n>sourcetype</span><span class=o>=</span><span class=n>wineventlog</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1102</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1100</span><span class=p>))</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>sourcetype</span><span class=o>=</span><span class=n>wineventlog</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>104</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=n>EventCode</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=n>sourcetype</span><span class=w> </span><span class=k>host</span><span class=w>
</span></span></span></code></pre></div><h3 id=2--finding-large-web-uploads>2- Finding Large Web Uploads<a hidden class=anchor aria-hidden=true href=#2--finding-large-web-uploads>#</a></h3><p>Find large file uploads that could point to data exfiltration in your network.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>websense</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>bytes_out</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>35000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=n>src_ip</span><span class=w> </span><span class=n>bytes</span><span class=o>*</span><span class=w> </span><span class=n>uri</span><span class=w>
</span></span></span></code></pre></div><h3 id=3--detecting-recurring-malware-on-host>3- Detecting Recurring Malware on Host<a hidden class=anchor aria-hidden=true href=#3--detecting-recurring-malware-on-host>#</a></h3><p>Using anti-virus logs to detect if malware is recurring on a host after being removed.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>symantec</span><span class=p>:</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=n>range</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>TimeRange</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Risk_Name</span><span class=p>,</span><span class=w> </span><span class=n>Computer_Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>TimeRange</span><span class=o>&gt;</span><span class=mi>1800</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>eval</span><span class=w> </span><span class=n>TimeRange_In_Hours</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>round</span><span class=p>(</span><span class=n>TimeRange</span><span class=o>/</span><span class=mi>3600</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=n>TimeRange_In_Days</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>round</span><span class=p>(</span><span class=n>TimeRange</span><span class=o>/</span><span class=mi>3600</span><span class=o>/</span><span class=mi>24</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=4-detecting-brute-force-attacks>4-Detecting Brute Force Attacks<a hidden class=anchor aria-hidden=true href=#4-detecting-brute-force-attacks>#</a></h3><p>A brute-force attack consists of a multiple login attempts using many passwords by an unauthorized user/attacker with the hope of eventually guessing the correct password.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>winxsecurity</span><span class=w> </span><span class=k>user</span><span class=o>=*</span><span class=w> </span><span class=k>user</span><span class=o>!</span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>eval</span><span class=p>(</span><span class=n>action</span><span class=o>=</span><span class=s2>&#34;success&#34;</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>successes</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>eval</span><span class=p>(</span><span class=n>action</span><span class=o>=</span><span class=s2>&#34;failure&#34;</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>failures</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>user</span><span class=p>,</span><span class=w> </span><span class=n>ComputerName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>successes</span><span class=o>&gt;</span><span class=mi>0</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>failures</span><span class=o>&gt;</span><span class=mi>100</span><span class=w>
</span></span></span></code></pre></div><p><strong>Windows</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>windows</span><span class=w> </span><span class=k>source</span><span class=o>=</span><span class=s2>&#34;WinEventLog:Security&#34;</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4625</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>bin</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=n>span</span><span class=o>=</span><span class=mi>5</span><span class=n>m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>_time</span><span class=p>,</span><span class=k>user</span><span class=p>,</span><span class=k>host</span><span class=p>,</span><span class=n>src</span><span class=p>,</span><span class=n>action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>5</span><span class=w>
</span></span></span></code></pre></div><p><strong>Linux</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>linux</span><span class=w> </span><span class=k>source</span><span class=o>=</span><span class=s2>&#34;/var/log/auth.log&#34;</span><span class=w> </span><span class=s2>&#34;Failed password&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>bin</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=n>span</span><span class=o>=</span><span class=mi>5</span><span class=n>m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>_time</span><span class=p>,</span><span class=k>user</span><span class=p>,</span><span class=k>host</span><span class=p>,</span><span class=n>src</span><span class=p>,</span><span class=n>action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>5</span><span class=w>
</span></span></span></code></pre></div><h3 id=5--detecting-unencrypted-web-communications>5- Detecting Unencrypted Web Communications<a hidden class=anchor aria-hidden=true href=#5--detecting-unencrypted-web-communications>#</a></h3><p>Find unencrypted web communications that could lead to a data breach.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>firewall_data</span><span class=w> </span><span class=n>dest_port</span><span class=o>!=</span><span class=mi>443</span><span class=w> </span><span class=n>app</span><span class=o>=</span><span class=n>workday</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=n>bytes</span><span class=o>*</span><span class=w> </span><span class=n>src_ip</span><span class=w> </span><span class=n>dest_ip</span><span class=w> </span><span class=n>dest_port</span><span class=w>
</span></span></span></code></pre></div><h3 id=6--identifying-web-users-by-country>6- Identifying Web Users By Country<a hidden class=anchor aria-hidden=true href=#6--identifying-web-users-by-country>#</a></h3><p>Use IPs in your data to report and visualize user locations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>web</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>access_combined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>iplocation</span><span class=w> </span><span class=n>clientip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>geostats</span><span class=w> </span><span class=n>dc</span><span class=p>(</span><span class=n>clientip</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Country</span><span class=w>
</span></span></span></code></pre></div><h3 id=7--identifying-slow-web-content>7- Identifying Slow Web Content<a hidden class=anchor aria-hidden=true href=#7--identifying-slow-web-content>#</a></h3><p>A slow loading web site can not only frustrate users, but can also hurt search rankings.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>web</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>ms</span><span class=p>:</span><span class=n>iis</span><span class=p>:</span><span class=n>auto</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>apache</span><span class=p>:</span><span class=w> </span><span class=k>access</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>avg</span><span class=p>(</span><span class=n>response_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>art</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>uri_path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>eval</span><span class=w> </span><span class=s2>&#34;Average Response Time&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>round</span><span class=p>(</span><span class=n>art</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>sort</span><span class=w> </span><span class=o>-</span><span class=s2>&#34;Average Response Time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>uri_path</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Average Response Time&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=8--finding-new-local-admin-accounts>8- Finding New Local Admin Accounts<a hidden class=anchor aria-hidden=true href=#8--finding-new-local-admin-accounts>#</a></h3><p>Often an attack will include the creation of a new user, followed by permissions being elevated to an admin level.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>win_servers</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>windows</span><span class=p>:</span><span class=k>security</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4720</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4732</span><span class=w> </span><span class=n>Administrators</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>transaction</span><span class=w> </span><span class=n>Security_ID</span><span class=w> </span><span class=n>maxspan</span><span class=o>=</span><span class=mi>180</span><span class=n>m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>search</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4720</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4732</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>_time</span><span class=p>,</span><span class=w> </span><span class=n>EventCode</span><span class=p>,</span><span class=w> </span><span class=n>Recurity_ID</span><span class=p>,</span><span class=w> </span><span class=n>SamAccountName</span><span class=w>
</span></span></span></code></pre></div><h3 id=9--finding-interactive-logins-from-service-accounts>9- Finding Interactive Logins From Service Accounts<a hidden class=anchor aria-hidden=true href=#9--finding-interactive-logins-from-service-accounts>#</a></h3><p>Most service accounts should never interactively log into servers.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>systems</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>audit_logs</span><span class=w> </span><span class=k>user</span><span class=o>=</span><span class=n>svc_</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=n>earliest</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>earliest</span><span class=w> </span><span class=n>latest</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>latest</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>user</span><span class=p>,</span><span class=w> </span><span class=n>dest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>eval</span><span class=w> </span><span class=n>isOutlier</span><span class=o>=</span><span class=k>if</span><span class=p>(</span><span class=n>earliest</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>relative_time</span><span class=p>(</span><span class=n>now</span><span class=p>(),</span><span class=w> </span><span class=s2>&#34;-1d@d&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>convert</span><span class=w> </span><span class=n>ctime</span><span class=p>(</span><span class=n>earliest</span><span class=p>)</span><span class=w> </span><span class=n>ctime</span><span class=p>(</span><span class=n>Latest</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=10--log-volume-trending>10- Log Volume Trending<a hidden class=anchor aria-hidden=true href=#10--log-volume-trending>#</a></h3><p>Visualizing the number of events being logged by an application can provide a simple, yet powerful indicator of the state of your application, or changes in the behavior of your code or environment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=n>tstats</span><span class=w> </span><span class=n>prestats</span><span class=o>=</span><span class=n>t</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>index</span><span class=o>=</span><span class=n>apps</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>host</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=n>span</span><span class=o>=</span><span class=mi>1</span><span class=n>m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=n>timechart</span><span class=w> </span><span class=k>partial</span><span class=o>=</span><span class=n>f</span><span class=w> </span><span class=n>span</span><span class=o>=</span><span class=mi>1</span><span class=n>m</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>host</span><span class=w> </span><span class=k>limit</span><span class=o>=</span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></div><h3 id=11--basic-tor-traffic-detection>11- Basic TOR Traffic Detection<a hidden class=anchor aria-hidden=true href=#11--basic-tor-traffic-detection>#</a></h3><p>Use firewall data to find TOR traffic on your network.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>network</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>firewall_data</span><span class=w> </span><span class=n>app</span><span class=o>=</span><span class=n>tor</span><span class=w> </span><span class=n>src_ip</span><span class=o>=*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=n>src_ip</span><span class=w> </span><span class=n>src_port</span><span class=w> </span><span class=n>dest_ip</span><span class=w> </span><span class=n>dest_port</span><span class=w> </span><span class=n>bytes</span><span class=w> </span><span class=n>app</span><span class=w>
</span></span></span></code></pre></div><h3 id=12--measuring-storage-io-latency>12- Measuring Storage I/O Latency<a hidden class=anchor aria-hidden=true href=#12--measuring-storage-io-latency>#</a></h3><p>Quickly find I/O bottlenecks across your systems.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>main</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>iostat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>timechart</span><span class=w> </span><span class=k>avg</span><span class=p>(</span><span class=n>latency</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>host</span><span class=w>
</span></span></span></code></pre></div><h3 id=13--measuring-storage-speed-io-utilization-by-host>13- Measuring Storage Speed I/O Utilization by Host<a hidden class=anchor aria-hidden=true href=#13--measuring-storage-speed-io-utilization-by-host>#</a></h3><p>It simple to track disk I/O, helping you quickly discover storage issues on your servers.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>main</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>iostat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>eval</span><span class=w> </span><span class=n>hostdevice</span><span class=o>=</span><span class=k>host</span><span class=o>+</span><span class=s2>&#34;:&#34;</span><span class=o>+</span><span class=n>Device</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>timechart</span><span class=w> </span><span class=k>avg</span><span class=p>(</span><span class=n>total_ops</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>hostdevice</span><span class=w>
</span></span></span></code></pre></div><h3 id=14--measuring-memory-utilization-by-host>14- Measuring Memory Utilization by Host<a hidden class=anchor aria-hidden=true href=#14--measuring-memory-utilization-by-host>#</a></h3><p>It&rsquo;s easy to track memory utilization of your systems using Splunk Enterprise.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>main</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>vmstat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>memUsedPct</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>memused</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>memused</span><span class=o>&gt;</span><span class=mi>80</span><span class=w>
</span></span></span></code></pre></div><h3 id=15--rogue-dns-detection>15- Rogue DNS detection<a hidden class=anchor aria-hidden=true href=#15--rogue-dns-detection>#</a></h3><p>Look for DNS requests that are not destined for the dedicated DNS server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=k>security</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>cp_log</span><span class=w> </span><span class=n>src_ip</span><span class=o>!=</span><span class=mi>192</span><span class=p>.</span><span class=mi>168</span><span class=p>.</span><span class=mi>14</span><span class=p>.</span><span class=mi>10</span><span class=w> </span><span class=n>dest_ip</span><span class=o>!=</span><span class=mi>192</span><span class=p>.</span><span class=mi>168</span><span class=p>.</span><span class=mi>14</span><span class=p>.</span><span class=mi>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>protocol</span><span class=o>=</span><span class=mi>53</span><span class=w> </span><span class=n>action</span><span class=o>!=</span><span class=k>Drop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>dest_ip</span><span class=o>=</span><span class=s2>&#34;192.168.0.0/16&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>src_ip</span><span class=o>=</span><span class=s2>&#34;192.168.0.0/16&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=p>,</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>dest_ip</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>src_ip</span><span class=w>
</span></span></span></code></pre></div><h3 id=16--suspicious-powershell-commands>16- Suspicious PowerShell Commands<a hidden class=anchor aria-hidden=true href=#16--suspicious-powershell-commands>#</a></h3><p>Look for logs with commands that try to download external scripts/content or bypass PowerShell.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>windows</span><span class=w> </span><span class=k>source</span><span class=o>=</span><span class=s2>&#34;WinEventLog:Microsoft-Windows-PowerShell/Operational&#34;</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4104</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>AND</span><span class=w> </span><span class=p>((</span><span class=n>ScriptBlockText</span><span class=o>=*-</span><span class=n>noni</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=n>iex</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=k>New</span><span class=o>-</span><span class=k>Object</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>ScriptBlockText</span><span class=o>=*-</span><span class=n>ep</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=n>bypass</span><span class=o>*</span><span class=w> </span><span class=o>*-</span><span class=n>Enc</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>ScriptBlockText</span><span class=o>=*</span><span class=n>powershell</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=n>reg</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=k>add</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>*</span><span class=n>HKCU</span><span class=err>\\</span><span class=n>software</span><span class=err>\\</span><span class=n>microsoft</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>currentversion</span><span class=err>\\</span><span class=n>run</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>ScriptBlockText</span><span class=o>=*</span><span class=n>bypass</span><span class=o>*</span><span class=w> </span><span class=o>*-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>noprofile</span><span class=o>*</span><span class=w> </span><span class=o>*-</span><span class=n>windowstyle</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=n>hidden</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=k>new</span><span class=o>-</span><span class=k>object</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=k>system</span><span class=p>.</span><span class=n>net</span><span class=p>.</span><span class=n>webclient</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=n>download</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>ScriptBlockText</span><span class=o>=*</span><span class=n>iex</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=k>New</span><span class=o>-</span><span class=k>Object</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=n>Net</span><span class=p>.</span><span class=n>WebClient</span><span class=o>*</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=n>Download</span><span class=o>*</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>Computer</span><span class=p>,</span><span class=w> </span><span class=n>ScriptBlockText</span><span class=p>,</span><span class=w> </span><span class=n>UserID</span><span class=w>
</span></span></span></code></pre></div><h3 id=17--windows-audit-log-cleared>17- Windows audit log cleared<a hidden class=anchor aria-hidden=true href=#17--windows-audit-log-cleared>#</a></h3><p>Look for security logs filtered with EventCode 1102.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>windows</span><span class=w> </span><span class=k>source</span><span class=o>=</span><span class=s2>&#34;WinEventLog:Security&#34;</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1102</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>_time</span><span class=p>,</span><span class=w> </span><span class=k>host</span><span class=p>,</span><span class=w> </span><span class=n>signature</span><span class=p>,</span><span class=w> </span><span class=k>user</span><span class=w>
</span></span></span></code></pre></div><h3 id=18--detecting-network-and-port-scanning>18- Detecting Network and Port Scanning<a hidden class=anchor aria-hidden=true href=#18--detecting-network-and-port-scanning>#</a></h3><p>Look for distinct count of destination ports within a short span of time.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=p>:</span><span class=s2>&#34;Network_Traffic&#34;</span><span class=p>.</span><span class=s2>&#34;All_Traffic&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=n>dc</span><span class=p>(</span><span class=n>dest_port</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>dc_dest_port</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>src</span><span class=p>,</span><span class=w> </span><span class=n>dest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>dc_dest_port</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span></code></pre></div><p>OR</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=n>firewall</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=n>dc</span><span class=p>(</span><span class=n>dest_port</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>num_dest_port</span><span class=w> </span><span class=n>dc</span><span class=p>(</span><span class=n>dest_ip</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>num_dest_ip</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>src_ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>num_dest_port</span><span class=w> </span><span class=o>&gt;</span><span class=mi>500</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>num_dest_ip</span><span class=w> </span><span class=o>&gt;</span><span class=mi>500</span><span class=w>
</span></span></span></code></pre></div><h3 id=19--unusual-access>19- Unusual Access<a hidden class=anchor aria-hidden=true href=#19--unusual-access>#</a></h3><p>Look for count of multiple failed login attempts where successful login is true.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=p>:</span><span class=s2>&#34;Authentication&#34;</span><span class=p>.</span><span class=s2>&#34;Authentication&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=k>like</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=s2>&#34;ssh&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=n>list</span><span class=p>(</span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>Attempts</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>eval</span><span class=p>(</span><span class=k>match</span><span class=p>(</span><span class=n>action</span><span class=p>,</span><span class=s2>&#34;failure&#34;</span><span class=p>)))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>Failed</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>count</span><span class=p>(</span><span class=n>eval</span><span class=p>(</span><span class=k>match</span><span class=p>(</span><span class=n>action</span><span class=p>,</span><span class=s2>&#34;success&#34;</span><span class=p>)))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>Success</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>user</span><span class=p>,</span><span class=n>src</span><span class=p>,</span><span class=n>dest</span><span class=p>,</span><span class=n>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>mvcount</span><span class=p>(</span><span class=n>Attempts</span><span class=p>)</span><span class=o>&gt;=</span><span class=mi>6</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>Success</span><span class=o>&gt;</span><span class=mi>0</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>Failed</span><span class=o>&gt;=</span><span class=mi>5</span><span class=w>
</span></span></span></code></pre></div><h3 id=20--malware-attack>20- Malware Attack<a hidden class=anchor aria-hidden=true href=#20--malware-attack>#</a></h3><p>Look for infection count of malware attack.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=p>:</span><span class=s2>&#34;Malware&#34;</span><span class=p>.</span><span class=s2>&#34;Malware_Attacks&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=n>dc</span><span class=p>(</span><span class=s2>&#34;signature&#34;</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s2>&#34;infection_count&#34;</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=s2>&#34;dest&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=s1>&#39;infection_count&#39;</span><span class=o>&gt;</span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></div><h3 id=21-attempt-to-add-certificate-to-untrusted-store>21-Attempt To Add Certificate To Untrusted Store<a hidden class=anchor aria-hidden=true href=#21-attempt-to-add-certificate-to-untrusted-store>#</a></h3><p>Adversaries may add their own root certificate to the certificate store, to cause the web browser to trust that certificate and not display a security warning when it encounters the previously unseen certificate. This action may be the precursor to malicious activity.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=*</span><span class=n>certutil</span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*-</span><span class=n>addstore</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=w>
</span></span></span></code></pre></div><h3 id=22--batch-file-write-to-system32>22**- Batch File Write to System32**<a hidden class=anchor aria-hidden=true href=#22--batch-file-write-to-system32>#</a></h3><p>While batch files are not inherently malicious, it is uncommon to see them created after OS installation, especially in the Windows directory. This analytic looks for the suspicious activity of a batch file being created within the C:\Windows\System32 directory tree. There will be only occasional false positives due to administrator actions.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Filesystem</span><span class=p>.</span><span class=n>dest</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>dest</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Filesystem</span><span class=p>.</span><span class=n>file_name</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>file_name</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Filesystem</span><span class=p>.</span><span class=k>user</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Filesystem</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Filesystem</span><span class=p>.</span><span class=n>file_path</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>rex</span><span class=w> </span><span class=n>field</span><span class=o>=</span><span class=n>file_name</span><span class=w> </span><span class=s2>&#34;(?&lt;file_extension&gt;\.[^\.]+)$&#34;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>search</span><span class=w> </span><span class=n>file_path</span><span class=o>=*</span><span class=n>system32</span><span class=o>*</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>file_extension</span><span class=o>=</span><span class=p>.</span><span class=n>bat</span><span class=w>
</span></span></span></code></pre></div><h3 id=23--bcdedit-failure-recovery-modification>23- BCDEdit Failure Recovery Modification<a hidden class=anchor aria-hidden=true href=#23--bcdedit-failure-recovery-modification>#</a></h3><p>This search looks for flags passed to bcdedit.exe modifications to the built-in Windows error recovery boot configurations. This is typically used by ransomware to prevent recovery.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcdedit</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=</span><span class=s2>&#34;*recoveryenabled*&#34;</span><span class=w> </span><span class=p>(</span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=</span><span class=s2>&#34;* no*&#34;</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>dest</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=w>
</span></span></span></code></pre></div><h3 id=24--bits-job-persistence>24- BITS Job Persistence<a hidden class=anchor aria-hidden=true href=#24--bits-job-persistence>#</a></h3><p>The following query identifies Microsoft Background Intelligent Transfer Service utility <code>bitsadmin.exe</code> scheduling a BITS job to persist on an endpoint. The query identifies the parameters used to create, resume or add a file to a BITS job. Typically seen combined in a oneliner or ran in sequence. If identified, review the BITS job created and capture any files written to disk. It is possible for BITS to be used to upload files and this may require further network data analysis to identify. You can use <code>bitsadmin /list /verbose</code> to list out the jobs during investigation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=</span><span class=n>bitsadmin</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=k>create</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>addfile</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>setnotifyflags</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>setnotifycmdline</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>setminretrydelay</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>setcustomheaders</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>resume</span><span class=o>*</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>dest</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_id</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process_id</span><span class=w>
</span></span></span></code></pre></div><h3 id=25--bitsadmin-download-file>25- BITSAdmin Download File<a hidden class=anchor aria-hidden=true href=#25--bitsadmin-download-file>#</a></h3><p>The following query identifies Microsoft Background Intelligent Transfer Service utility <code>bitsadmin.exe</code> using the <code>transfer</code> parameter to download a remote object. In addition, look for <code>download</code> or <code>upload</code> on the command-line, the switches are not required to perform a transfer. Capture any files downloaded. Review the reputation of the IP or domain used. Typically once executed, a follow on command will be used to execute the dropped file. Note that the network connection or file modification events related will not spawn or create from <code>bitsadmin.exe</code>, but the artifacts will appear in a parallel process of <code>svchost.exe</code> with a command-line similar to <code>svchost.exe -k netsvcs -s BITS</code>. It’s important to review all parallel and child processes to capture any behaviors and artifacts. In some suspicious and malicious instances, BITS jobs will be created. You can use <code>bitsadmin /list /verbose</code> to list out the jobs during investigation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=</span><span class=n>bitsadmin</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*</span><span class=n>transfer</span><span class=o>*</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>dest</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_id</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process_id</span><span class=w>
</span></span></span></code></pre></div><h3 id=26--certutil-download-with-urlcache-and-split-arguments>26- CertUtil Download With URLCache and Split Arguments<a hidden class=anchor aria-hidden=true href=#26--certutil-download-with-urlcache-and-split-arguments>#</a></h3><p>Certutil.exe may download a file from a remote destination using <code>urlcache</code>. This behavior does require a URL to be passed on the command-line. In addition, <code>f</code> (force) and <code>split</code> (Split embedded ASN.1 elements, and save to files) will be used. It is not entirely common for <code>certutil.exe</code> to contact public IP space. However, it is uncommon for <code>certutil.exe</code> to write files to world writeable paths.\ During triage, capture any files on disk and review. Review the reputation of the remote IP or domain in question.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=</span><span class=n>certutil</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*</span><span class=n>urlcache</span><span class=o>*</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*</span><span class=n>split</span><span class=o>*</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>dest</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_id</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process_id</span><span class=w>
</span></span></span></code></pre></div><h3 id=27--certutil-download-with-verifyctl-and-split-arguments>27- CertUtil Download With VerifyCtl and Split Arguments<a hidden class=anchor aria-hidden=true href=#27--certutil-download-with-verifyctl-and-split-arguments>#</a></h3><p>Certutil.exe may download a file from a remote destination using <code>VerifyCtl</code>. This behavior does require a URL to be passed on the command-line. In addition, <code>f</code> (force) and <code>split</code> (Split embedded ASN.1 elements, and save to files) will be used. It is not entirely common for <code>certutil.exe</code> to contact public IP space. \ During triage, capture any files on disk and review. Review the reputation of the remote IP or domain in question. Using <code>VerifyCtl</code>, the file will either be written to the current working directory or <code>%APPDATA%\..\LocalLow\Microsoft\CryptnetUrlCache\Content\&lt;hash></code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=</span><span class=n>certutil</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*</span><span class=n>verifyctl</span><span class=o>*</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*</span><span class=n>split</span><span class=o>*</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>dest</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_id</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process_id</span><span class=w>
</span></span></span></code></pre></div><h3 id=28--certutil-exe-certificate-extraction>28- Certutil exe certificate extraction<a hidden class=anchor aria-hidden=true href=#28--certutil-exe-certificate-extraction>#</a></h3><p>This search looks for arguments to certutil.exe indicating the manipulation or extraction of Certificate. This certificate can then be used to sign new authentication tokens specially inside Federated environments such as Windows ADFS.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=</span><span class=n>certutil</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;* -exportPFX *&#34;</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=w>
</span></span></span></code></pre></div><h3 id=29--certutil-with-decode-argument>29- CertUtil With Decode Argument<a hidden class=anchor aria-hidden=true href=#29--certutil-with-decode-argument>#</a></h3><p>CertUtil.exe may be used to <code>encode</code> and <code>decode</code> a file, including PE and script code. Encoding will convert a file to base64 with <code>----BEGIN CERTIFICATE-----</code> and <code>----END CERTIFICATE-----</code> tags. Malicious usage will include decoding a encoded file that was downloaded. Once decoded, it will be loaded by a parallel process. Note that there are two additional command switches that may be used - <code>encodehex</code> and <code>decodehex</code>. Similarly, the file will be encoded in HEX and later decoded for further execution. During triage, identify the source of the file being decoded. Review its contents or execution behavior for further analysis.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=</span><span class=n>certutil</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*</span><span class=n>decode</span><span class=o>*</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>dest</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_id</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process_id</span><span class=w>
</span></span></span></code></pre></div><h3 id=30--create-local-admin-accounts-using-net-exe>30- Create local admin accounts using net exe<a hidden class=anchor aria-hidden=true href=#30--create-local-admin-accounts-using-net-exe>#</a></h3><p>This search looks for the creation of local administrator accounts using net.exe.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=n>tstats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Processes</span><span class=p>.</span><span class=k>user</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Processes</span><span class=p>.</span><span class=n>parent_process</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parent_process</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>datamodel</span><span class=o>=</span><span class=n>Endpoint</span><span class=p>.</span><span class=n>Processes</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=p>(</span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=</span><span class=n>net</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=o>=</span><span class=n>net1</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*</span><span class=n>localgroup</span><span class=o>*</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*/</span><span class=k>add</span><span class=o>*</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=o>=*</span><span class=k>user</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>process_name</span><span class=w> </span><span class=n>Processes</span><span class=p>.</span><span class=n>dest</span><span class=w>   </span><span class=o>|`</span><span class=n>create_local_admin_accounts_using_net_exe_filter</span><span class=o>`</span><span class=w>
</span></span></span></code></pre></div><h3 id=31--create-remote-thread-into-lsass>31- Create Remote Thread into LSASS<a hidden class=anchor aria-hidden=true href=#31--create-remote-thread-into-lsass>#</a></h3><p>Actors may create a remote thread into the LSASS service as part of a workflow to dump credentials.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>`</span><span class=n>sysmon</span><span class=o>`</span><span class=w> </span><span class=n>EventID</span><span class=o>=</span><span class=mi>8</span><span class=w> </span><span class=n>TargetImage</span><span class=o>=*</span><span class=n>lsass</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Computer</span><span class=p>,</span><span class=w> </span><span class=n>EventCode</span><span class=p>,</span><span class=w> </span><span class=n>TargetImage</span><span class=p>,</span><span class=w> </span><span class=n>TargetProcessId</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>rename</span><span class=w> </span><span class=n>Computer</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>dest</span><span class=w>
</span></span></span></code></pre></div><h3 id=32--create-service-in-suspicious-file-path>32- Create Service In Suspicious File Path<a hidden class=anchor aria-hidden=true href=#32--create-service-in-suspicious-file-path>#</a></h3><p>This detection is to identify a creation of “user mode service” where the service file path is located in non-common service folder in windows.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>`</span><span class=n>wineventlog_system</span><span class=o>`</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>7045</span><span class=w>  </span><span class=n>Service_File_Name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;*\.exe&#34;</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=p>(</span><span class=n>Service_File_Name</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;C:\\Windows\\*&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;C:\\Program File*&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;C:\\Programdata\\*&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;%systemroot%\\*&#34;</span><span class=p>))</span><span class=w> </span><span class=n>Service_Type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;user mode service&#34;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=k>min</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>firstTime</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>lastTime</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>EventCode</span><span class=w> </span><span class=n>Service_File_Name</span><span class=w> </span><span class=n>Service_Name</span><span class=w> </span><span class=n>Service_Start_Type</span><span class=w> </span><span class=n>Service_Type</span><span class=w>
</span></span></span></code></pre></div><h3 id=33--common-windows-process-masquerading>33- Common Windows Process Masquerading<a hidden class=anchor aria-hidden=true href=#33--common-windows-process-masquerading>#</a></h3><p>“Masquerading occurs when the name or location of an object, legitimate or malicious, is manipulated or abused for the sake of evading defenses and observation. This may include manipulating file metadata, tricking users into misidentifying the file type, and giving legitimate task or service names.”</p><p>Malware authors often use this technique to hide malicious executables behind legitimate Windows executable names (e.g. <code>lsass.exe</code>, <code>svchost.exe</code>, etc).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=k>source</span><span class=o>=</span><span class=s2>&#34;XmlWinEventLog:Microsoft-Windows-Sysmon/Operational&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>svchost</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=p>(</span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\svchost.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\SysWow64\\svchost.exe&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>smss</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\smss.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>wininit</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>taskhost</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\taskhost.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>lasass</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\lsass.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>winlogon</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\winlogon.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>csrss</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\csrss.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>services</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\services.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>lsm</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\lsm.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>process_name</span><span class=o>=</span><span class=n>explorer</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>process_path</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\explorer.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=34--unusual-child-process-spawned-using-dde-exploit>34- Unusual Child Process spawned using DDE exploit<a hidden class=anchor aria-hidden=true href=#34--unusual-child-process-spawned-using-dde-exploit>#</a></h3><p>Adversaries may use Windows Dynamic Data Exchange (DDE) to execute arbitrary commands. DDE is a client-server protocol for one-time and/or continuous inter-process communication (IPC) between applications. Once a link is established, applications can autonomously exchange transactions consisting of strings, warm data links (notifications when a data item changes), hot data links (duplications of changes to a data item), and requests for command execution.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>__your_sysmon__index__</span><span class=w> </span><span class=p>(</span><span class=n>ParentImage</span><span class=o>=</span><span class=s2>&#34;*excel.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>ParentImage</span><span class=o>=</span><span class=s2>&#34;*word.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>ParentImage</span><span class=o>=</span><span class=s2>&#34;*outlook.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*.exe&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=35--detecting-tampering-of-windows-defender-command-prompt>35- Detecting Tampering of Windows Defender Command Prompt<a hidden class=anchor aria-hidden=true href=#35--detecting-tampering-of-windows-defender-command-prompt>#</a></h3><p>In an attempt to avoid detection after compromising a machine, threat actors often try to disable Windows Defender. This is often done using “sc” [service control], a legitimate tool provided by Microsoft for managing services. This action interferes with event detection and may lead to a security event going undetected, thereby potentially leading to further compromise of the network.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=w> </span><span class=n>__your_sysmon__index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;C:\\Windows\\System32\\sc.exe&#34;</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;^sc\s*(config|stop|query)\sWinDefend$&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=36--disable-uac>36- Disable UAC<a hidden class=anchor aria-hidden=true href=#36--disable-uac>#</a></h3><p>Threat actors often, after compromising a machine, try to disable User Access Control (UAC) to escalate privileges. This is often done by changing the registry key for system policies using “reg.exe”, a legitimate tool provided by Microsoft for modifying the registry via command prompt or scripts. This action interferes with UAC and may enable a threat actor to escalate privileges on the compromised system, thereby allowing further exploitation of the system.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>sourcetype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>ParentImage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=k>like</span><span class=p>(</span><span class=n>CommandLine</span><span class=p>,</span><span class=s2>&#34;reg.exe%HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System%REG_DWORD /d 0%&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=37--identifying-port-scanning-activity>37- Identifying Port Scanning Activity<a hidden class=anchor aria-hidden=true href=#37--identifying-port-scanning-activity>#</a></h3><p>After compromising an initial machine, adversaries commonly attempt to laterally move across the network. The first step to attempt the lateral movement often involves conducting host identification, port and service scans on the internal network via the compromised machine using tools such as Nmap, Cobalt Strike, etc.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>sourcetype</span><span class=o>=</span><span class=s1>&#39;firewall_logs&#39;</span><span class=w> </span><span class=n>dest_ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;internal_subnet&#39;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=n>dc</span><span class=p>(</span><span class=n>dest_port</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>pcount</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>src_ip</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>pcount</span><span class=w> </span><span class=o>&gt;</span><span class=mi>5</span><span class=w>
</span></span></span></code></pre></div><h3 id=38--unusually-long-command-line-strings>38- Unusually Long Command Line Strings<a hidden class=anchor aria-hidden=true href=#38--unusually-long-command-line-strings>#</a></h3><p>Often, after a threat actor gains access to a system, they will attempt to run some kind of malware to further infect the victim machine. These malware often have long command line strings, which could be a possible indicator of attack. Here, we use sysmon and Splunk to first find the average command string length and search for command strings that stretch over multiple lines, thus identifying anomalies and possibly malicious commands.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=s2>&#34;xmlwineventlog&#34;</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4688</span><span class=w>  </span><span class=o>|</span><span class=n>eval</span><span class=w> </span><span class=n>cmd_len</span><span class=o>=</span><span class=n>len</span><span class=p>(</span><span class=n>CommandLine</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>eventstats</span><span class=w> </span><span class=k>avg</span><span class=p>(</span><span class=n>cmd_len</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>avg</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>host</span><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>cmd_len</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>maxlen</span><span class=p>,</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=k>avg</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avgperhost</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>host</span><span class=p>,</span><span class=w> </span><span class=n>CommandLine</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>maxlen</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10</span><span class=o>*</span><span class=n>avgperhost</span><span class=w>
</span></span></span></code></pre></div><h3 id=39--clearing-windows-logs-with-wevtutil>39- Clearing Windows Logs with Wevtutil<a hidden class=anchor aria-hidden=true href=#39--clearing-windows-logs-with-wevtutil>#</a></h3><p>In an attempt to clear traces after compromising a machine, threat actors often try to clear Windows Event logs. This is often done using “wevtutil”, a legitimate tool provided by Microsoft. This action interferes with event collection and notification, and may lead to a security event going undetected, thereby potentially leading to further compromise of the network.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>sourcetype</span><span class=o>=</span><span class=w> </span><span class=n>__your__windows__sysmon__sourcetype</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=*</span><span class=n>wevtutil</span><span class=o>*</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=*</span><span class=n>cl</span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>CommandLine</span><span class=o>=*</span><span class=k>System</span><span class=o>*</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=*</span><span class=k>Security</span><span class=o>*</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=*</span><span class=n>Setup</span><span class=o>*</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=*</span><span class=n>Application</span><span class=o>*</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><hr><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-3526678290068011 data-ad-slot=7160066188></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h3 id=40--unusual-child-process-for-spoolsvexe-or-connhostexe>40- Unusual Child Process for Spoolsv.Exe or Connhost.Exe<a hidden class=anchor aria-hidden=true href=#40--unusual-child-process-for-spoolsvexe-or-connhostexe>#</a></h3><p>After gaining initial access to a system, threat actors attempt to escalate privileges as they may be operating within a lower privileged process which does not allow them to access protected information or carry out tasks which require higher permissions. A common way of escalating privileges in a system is by externally invoking and exploiting spoolsv or connhost executables, both of which are legitimate Windows applications. This query searches for an invocation of either of these executables by a user, thus alerting us of any potentially malicious activity.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>System32</span><span class=err>\\</span><span class=n>spoolsv</span><span class=p>.</span><span class=n>exe</span><span class=o>*</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>System32</span><span class=err>\\</span><span class=n>conhost</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=n>ParentImage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=41--detecting-shadow-copy-deletion-via-vssadminexe>41- Detecting Shadow Copy Deletion via Vssadmin.exe<a hidden class=anchor aria-hidden=true href=#41--detecting-shadow-copy-deletion-via-vssadminexe>#</a></h3><p>After compromising a network of systems, threat actors often try to delete Shadow Copy in an attempt to prevent administrators from restoring the systems to versions present before the attack. This is often done via vssadmin, a legitimate Windows tool to interact with shadow copies. This non-detection of this technique, which is often employed by ransomware strains such as “Olympic Destroyer”, may lead to a failure in recovering systems after an attack.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_win_event_log_index__</span><span class=w> </span><span class=n>EventType</span><span class=o>=</span><span class=mi>4688</span><span class=w> </span><span class=n>CommandLine</span><span class=p>:</span><span class=s2>&#34;delete&#34;</span><span class=w> </span><span class=n>OriginalFileName</span><span class=p>:</span><span class=s2>&#34;VSSADMIN.EXE&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=42--webshell-indicative-process-tree>42- Webshell-Indicative Process Tree<a hidden class=anchor aria-hidden=true href=#42--webshell-indicative-process-tree>#</a></h3><p>A web shell is a web script placed on an openly accessible web server to allow an adversary to use the server as a gatway in a network. As the shell operates, commands will be issued from within the web application into the broader server operating system. This analytic looks for host enumeration executables initiated by any web service that would not normally be executed within that environment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=p>(</span><span class=n>ParentImage</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\services.exe&#34;</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span><span class=w> </span><span class=p>(</span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*echo*&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*\\pipe\\*&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\rundll32.exe&#34;</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*,a /p:*&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=43--get-system-elevation>43- Get System Elevation<a hidden class=anchor aria-hidden=true href=#43--get-system-elevation>#</a></h3><p>Cyber actors frequently escalate to the SYSTEM account after gaining entry to a Windows host, to enable them to carry out various attacks more effectively. Tools such as Meterpreter, Cobalt Strike, and Empire carry out automated steps to “Get System”, which is the same as switching over to the System user account. Most of these tools utilize multiple techniques to try and attain SYSTEM: in the first technique, they create a named pipe and connects an instance of cmd.exe to it, which allows them to impersonate the security context of cmd.exe, which is SYSTEM. In the second technique, a malicious DLL is injected into a process that is running as SYSTEM; the injected DLL steals the SYSTEM token and applies it where necessary to escalate privileges. This analytic looks for both of these techniques.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>index</span><span class=o>=</span>__your_sysmon_index__ <span class=o>(</span><span class=nv>ParentImage</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\services.exe&#34;</span> <span class=nv>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span> <span class=o>(</span><span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*echo*&#34;</span> AND <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*\\pipe\\*&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>OR <span class=o>(</span><span class=nv>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\rundll32.exe&#34;</span> <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*,a /p:*&#34;</span><span class=o>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*%COMSPEC%*&#34;</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*echo*&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*\pipe\*&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=44--boot-or-logon-initialization-scripts>44- Boot or Logon Initialization Scripts<a hidden class=anchor aria-hidden=true href=#44--boot-or-logon-initialization-scripts>#</a></h3><p>Adversaries may schedule software to run whenever a user logs into the system; this is done to establish persistence and sometimes for lateral movement. This trigger is established through the registry key HKEY_CURRENT_USER\Environment<em>UserInitMprLogonScript</em>. This signature looks edits to existing keys or creation of new keys in that path. Users purposefully adding benign scripts to this path will result in false positives; that case is rare, however. There are other ways of running a script at startup or login that are not covered in this signature. Note that this signature overlaps with the Windows Sysinternals Autoruns tool, which would also show changes to this registry path.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\reg.exe&#34;</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*add*\\Environment*UserInitMprLogonScript&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=p>(</span><span class=n>EventCode</span><span class=o>=</span><span class=mi>12</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>14</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>13</span><span class=p>)</span><span class=w> </span><span class=n>TargetObject</span><span class=o>=</span><span class=s2>&#34;*\\Environment*UserInitMprLogonScript&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=45--local-network-sniffing>45- Local Network Sniffing<a hidden class=anchor aria-hidden=true href=#45--local-network-sniffing>#</a></h3><p>Adversaries may use a variety of tools to gain visibility on the current status of things on the network: which processes are listening on which ports, which services are running on other hosts, etc. This analytic looks for the names of the most common network sniffing tools. While this may be noisy on networks where sysadmins are using any of these tools on a regular basis, in most networks their use is noteworthy.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*tshark.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*windump.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*logman.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;?&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Program Files\\Windows Event Reporting\\Core\\EventReporting.AgentService.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*tcpdump.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*wprui.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*wpr.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=46--dll-injection-with-mavinject>46- DLL Injection with Mavinject<a hidden class=anchor aria-hidden=true href=#46--dll-injection-with-mavinject>#</a></h3><p>Injecting a malicious DLL into a process is a common adversary TTP. Although the ways of doing this are numerous, mavinject.exe is a commonly used tool for doing so because it roles up many of the necessary steps into one, and is available within Windows. Attackers may rename the executable, so we also use the common argument “INJECTRUNNING” as a related signature here. Whitelisting certain applications may be necessary to reduce noise for this analytic.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\SysWOW64\\mavinject.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\mavinject.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*\INJECTRUNNING*&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=47--processes-started-from-irregular-parent>47- Processes Started From Irregular Parent<a hidden class=anchor aria-hidden=true href=#47--processes-started-from-irregular-parent>#</a></h3><p>Adversaries may start legitimate processes and then use their memory space to run malicious code. This analytic looks for common Windows processes that have been abused this way in the past; when the processes are started for this purpose they may not have the standard parent that we would expect. This list is not exhaustive, and it is possible for cyber actors to avoid this discepency. These signatures only work if Sysmon reports the parent process, which may not always be the case if the parent dies before sysmon processes the event.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;?&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Program Files\\SplunkUniversalForwarder\\bin\\splunk-regmon.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Program Files\\SplunkUniversalForwarder\\bin\\splunk-powershell.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>((</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\System32\\smss.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\smss.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;System&#34;</span><span class=p>))</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\csrss.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\smss.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\svchost.exe&#34;</span><span class=p>))</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\smss.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\winlogon.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\smss.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\lsass.exe&#34;</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\LogonUI.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\winlogon.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span><span class=p>))</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\services.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\spoolsv.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\services.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\taskhost.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\services.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\svchost.exe&#34;</span><span class=p>))</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\taskhostw.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\services.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\svchost.exe&#34;</span><span class=p>))</span><span class=w> </span><span class=k>OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\System32\\userinit.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\dwm.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\System32\\winlogon.exe&#34;</span><span class=p>)))</span><span class=w>
</span></span></span></code></pre></div><h3 id=48--clear-powershell-console-command-history>48- Clear Powershell Console Command History<a hidden class=anchor aria-hidden=true href=#48--clear-powershell-console-command-history>#</a></h3><p>Adversaries may attempt to conceal their tracks by deleting the history of commands run within the Powershell console, or turning off history saving to begin with. This analytic looks for several commands that would do this. This does not capture the event if it is done within the console itself; only commandline-based commands are detected. Note that the command to remove the history file directly may very a bit if the history file is not saved in the default path on a particular system.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span><span class=nv>index</span><span class=o>=</span>__your_sysmon_index__ <span class=nv>EventCode</span><span class=o>=</span>1<span class=o>)</span> <span class=o>(</span><span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*rm (Get-PSReadlineOption).HistorySavePath*&#34;</span> OR <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*del (Get-PSReadlineOption).HistorySavePath*&#34;</span> OR <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Set-PSReadlineOption –HistorySaveStyle SaveNothing*&#34;</span> OR <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Remove-Item (Get-PSReadlineOption).HistorySavePath*&#34;</span> OR <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;del*Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt&#34;</span><span class=o>)</span>
</span></span></code></pre></div><h3 id=49--local-permission-group-discovery>49- Local Permission Group Discovery<a hidden class=anchor aria-hidden=true href=#49--local-permission-group-discovery>#</a></h3><p>Cyber actors frequently enumerate local or domain permissions groups. The net utility is usually used for this purpose. This analytic looks for any instances of net.exe, which is not normally used for benign purposes, although system administrator actions may trigger false positives.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span><span class=nv>index</span><span class=o>=</span>__your_sysmon_index__ <span class=nv>EventCode</span><span class=o>=</span>1<span class=o>)</span> <span class=nv>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\net.exe&#34;</span> AND <span class=o>(</span><span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;* user*&#34;</span> OR <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;* group*&#34;</span> OR <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;* localgroup*&#34;</span> OR <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*get-localgroup*&#34;</span> OR <span class=nv>CommandLine</span><span class=o>=</span><span class=s2>&#34;*get-ADPrincipalGroupMembership*&#34;</span><span class=o>)</span>
</span></span></code></pre></div><h3 id=50--network-share-connection-removal>50- Network Share Connection Removal<a hidden class=anchor aria-hidden=true href=#50--network-share-connection-removal>#</a></h3><p>Adversaries may use network shares to exfliltrate date; they will then remove the shares to cover their tracks. This analytic looks for the removal of network shares via commandline, which is otherwise a rare event.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>((</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\net.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*delete*&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Remove-SmbShare*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Remove-FileShare*&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=51--msbuild-and-msxsl>51- MSBuild and msxsl<a hidden class=anchor aria-hidden=true href=#51--msbuild-and-msxsl>#</a></h3><p>Trusted developer utilities such as MSBuild may be leveraged to run malicious code with elevated privileges. This analytic looks for any instances of msbuild.exe, which will execute any C# code placed within a given XML document; and msxsl.exe, which processes xsl transformation specifications for XML files and will execute a variaty of scripting languages contained within the XSL file. Both of these executables are rarely used outside of Visual Studio.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Program Files (x86)\\Microsoft Visual Studio\\*\\bin\\MSBuild.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\Microsoft.NET\\Framework*\\msbuild.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\users\\*\\appdata\\roaming\\microsoft\\msxsl.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;*\\Microsoft Visual Studio*&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=52--compiled-html-access>52- Compiled HTML Access<a hidden class=anchor aria-hidden=true href=#52--compiled-html-access>#</a></h3><p>Adversaries may hide malicious code in .chm compiled HTML files. When these files are read, Windows uses the HTML help executable named hh.exe, which is the signature for this analytic.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\syswow64\\hh.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\system32\\hh.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=53--cmstp>53- CMSTP<a hidden class=anchor aria-hidden=true href=#53--cmstp>#</a></h3><p>CMSTP.exe is the Microsoft Connection Manager Profile Installer, which can be leveraged to setup listeners that will receive and install malware from remote sources in trusted fashion. When CMSTP.exe is seen in combination with an external connection, it is a good indication of this TTP.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\CMSTP.exe&#34;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=p>((</span><span class=o>!</span><span class=n>cidrmatch</span><span class=p>(</span><span class=s2>&#34;10.0.0.0/8&#34;</span><span class=p>,</span><span class=w> </span><span class=n>SourceIp</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>!</span><span class=n>cidrmatch</span><span class=p>(</span><span class=s2>&#34;192.168.0.0/16&#34;</span><span class=p>,</span><span class=w> </span><span class=n>SourceIp</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>!</span><span class=n>cidrmatch</span><span class=p>(</span><span class=s2>&#34;172.16.0.0/12&#34;</span><span class=p>,</span><span class=w> </span><span class=n>SourceIp</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></div><h3 id=54--registry-edit-from-screensaver>54- Registry Edit from Screensaver<a hidden class=anchor aria-hidden=true href=#54--registry-edit-from-screensaver>#</a></h3><p>Adversaries may use screensaver files to run malicious code. This analytic triggers on suspicious edits to the screensaver registry keys, which dictate which .scr file the screensaver runs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>your_sysmon_index</span><span class=w> </span><span class=p>(</span><span class=n>EventCode</span><span class=o>=</span><span class=mi>12</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>13</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span><span class=w> </span><span class=n>TargetObject</span><span class=o>=</span><span class=s2>&#34;*\\Software\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\SCRNSAVE.EXE&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=55--scheduled-task---file-access>55- Scheduled Task - File Access<a hidden class=anchor aria-hidden=true href=#55--scheduled-task---file-access>#</a></h3><p>In order to gain persistence, privilege escalation, or remote execution, an adversary may use the Windows Task Scheduler to schedule a command to be run at a specified time, date, and even host. Task Scheduler stores tasks as files in two locations - C:\Windows\Tasks (legacy) or C:\Windows\System32\Tasks. Accordingly, this analytic looks for the creation of task files in these two locations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>11</span><span class=w> </span><span class=n>Image</span><span class=o>!=</span><span class=s2>&#34;C:\\WINDOWS\\system32\\svchost.exe&#34;</span><span class=w> </span><span class=p>(</span><span class=n>TargetFilename</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\Tasks\\*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>TargetFilename</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\Tasks\\*&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=56--component-object-model-hijacking>56- Component Object Model Hijacking<a hidden class=anchor aria-hidden=true href=#56--component-object-model-hijacking>#</a></h3><p>Adversaries may establish persistence or escalate privileges by executing malicious content triggered by hijacked references to Component Object Model (COM) objects. This is typically done by replacing COM object registry entries under the HKEY_CURRENT_USER\Software\Classes\CLSID or HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID keys. Accordingly, this analytic looks for any changes under these keys.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=p>(</span><span class=n>EventCode</span><span class=o>=</span><span class=mi>12</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>13</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span><span class=w> </span><span class=n>TargetObject</span><span class=o>=</span><span class=s2>&#34;*\\Software\\Classes\\CLSID\\*&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=57--indicator-blocking---driver-unloaded>57- Indicator Blocking - Driver Unloaded<a hidden class=anchor aria-hidden=true href=#57--indicator-blocking---driver-unloaded>#</a></h3><p>Adversaries may attempt to evade system defenses by unloading minifilter drivers used by host-based sensors such as Sysmon through the use of the fltmc command-line utility. Accordingly, this analytic looks for command-line invocations of this utility when used to unload minifilter drivers.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>client</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*unload*&#34;</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\SysWOW64\\fltMC.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\fltMC.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=58--credentials-in-files--registry>58- Credentials in Files & Registry<a hidden class=anchor aria-hidden=true href=#58--credentials-in-files--registry>#</a></h3><p>Adversaries may search the Windows Registry on compromised systems for insecurely stored credentials for credential access. This can be accomplished using the query functionality of the reg.exe system utility, by looking for keys and values that contain strings such as “password”. In addition, adversaries may use toolkits such as <a href=https://powersploit.readthedocs.io/en/latest/>PowerSploit</a> in order to dump credentials from various applications such as IIS.Accordingly, this analytic looks for invocations of reg.exe in this capacity as well as that of several powersploit modules with similar functionality.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>((</span><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=k>index</span><span class=o>=</span><span class=n>__your_win_syslog_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4688</span><span class=p>))</span><span class=w> </span><span class=p>(</span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*reg* query HKLM /f password /t REG_SZ /s*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;reg* query HKCU /f password /t REG_SZ /s&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Get-UnattendedInstallFile*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Get-Webconfig*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Get-ApplicationHost*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Get-SiteListPassword*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Get-CachedGPPPassword*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*Get-RegistryAutoLogon*&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=59--appinit-dlls>59- AppInit DLLs<a hidden class=anchor aria-hidden=true href=#59--appinit-dlls>#</a></h3><p>Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by AppInit DLLs loaded into processes. Dynamic-link libraries (DLLs) that are specified in the AppInit_DLLs value in the Registry keys <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows</code> or <code>HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows</code> are loaded by user32.dll into every process that loads user32.dll. These values can be abused to obtain elevated privileges by causing a malicious DLL to be loaded and run in the context of separate processes. Accordingly, this analytic looks for modifications to these registry keys that may be indicative of this type of abuse.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=p>(</span><span class=n>EventCode</span><span class=o>=</span><span class=mi>12</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>13</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>TargetObject</span><span class=o>=</span><span class=s2>&#34;*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Appinit_Dlls\\*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>TargetObject</span><span class=o>=</span><span class=s2>&#34;*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Appinit_Dlls\\*&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=60--ntfs-alternate-data-stream-execution---system-utilities>60- NTFS Alternate Data Stream Execution - System Utilities<a hidden class=anchor aria-hidden=true href=#60--ntfs-alternate-data-stream-execution---system-utilities>#</a></h3><p>NTFS Alternate Data Streams (ADSs) may be used by adversaries as a means of evading security tools by storing malicious data or binaries in file attribute metadata. ADSs are also powerful because they can be directly executed by various Windows tools; accordingly, this analytic looks at common ways of executing ADSs using system utilities such as powershell.</p><p><strong>NTFS ADS - PowerShell</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=o>*</span><span class=err>\\</span><span class=n>powershell</span><span class=p>.</span><span class=n>exe</span><span class=o>|</span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;Invoke-CimMethod\s+-ClassName\s+Win32_Process\s+-MethodName\s+Create.*\b(\w+(\.\w+)?):(\w+(\.\w+)?)|-ep bypass\s+-\s+&lt;.*\b(\w+(\.\w+)?):(\w+(\.\w+)?)|-command.*Get-Content.*-Stream.*Set-Content.*start-process .*(\w+(\.\w+)?)&#34;</span><span class=n>NTFS</span><span class=w> </span><span class=n>ADS</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>wmic</span><span class=w>
</span></span></span></code></pre></div><p><strong>NTFS ADS - wmic</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=o>*</span><span class=err>\\</span><span class=n>wmic</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;process call create.*\&#34;</span><span class=p>(</span><span class=err>\</span><span class=n>w</span><span class=o>+</span><span class=p>(</span><span class=err>\</span><span class=p>.</span><span class=err>\</span><span class=n>w</span><span class=o>+</span><span class=p>)</span><span class=o>?</span><span class=p>):(</span><span class=err>\</span><span class=n>w</span><span class=o>+</span><span class=p>(</span><span class=err>\</span><span class=p>.</span><span class=err>\</span><span class=n>w</span><span class=o>+</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=s2>&#34;
</span></span></span></code></pre></div><p><strong>NTFS ADS - rundll32</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w>  </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=o>*</span><span class=err>\\</span><span class=n>rundll32</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;\&#34;</span><span class=o>?</span><span class=p>(</span><span class=err>\</span><span class=n>w</span><span class=o>+</span><span class=p>(</span><span class=err>\</span><span class=p>.</span><span class=err>\</span><span class=n>w</span><span class=o>+</span><span class=p>)</span><span class=o>?</span><span class=p>):(</span><span class=err>\</span><span class=n>w</span><span class=o>+</span><span class=p>(</span><span class=err>\</span><span class=p>.</span><span class=err>\</span><span class=n>w</span><span class=o>+</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=o>?</span><span class=err>\</span><span class=s2>&#34;?,\w+\|(advpack\.dll\|ieadvpack\.dll),RegisterOCX\s+(\w+\.\w+):(\w+(\.\w+)?)\|(shdocvw\.dll\|ieframe\.dll),OpenURL.*(\w+\.\w+):(\w+(\.\w+)?)&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>NTFS ADS - wscript/cscript</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=o>*</span><span class=err>\\</span><span class=n>wscript</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=o>*</span><span class=err>\\</span><span class=n>cscript</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;(?&lt;!\/)\b\w+(\.\w+)?:\w+(\.\w+)?$&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=61--ntfs-alternate-data-stream-execution---lolbas>61- NTFS Alternate Data Stream Execution - LOLBAS<a hidden class=anchor aria-hidden=true href=#61--ntfs-alternate-data-stream-execution---lolbas>#</a></h3><p>NTFS Alternate Data Streams (ADSs) may be used by adversaries as a means of evading security tools by storing malicious data or binaries in file attribute metadata. ADSs are also powerful because their contents can be directly executed by various Windows tools; accordingly, this analytic looks at common ways of executing ADSs using Living off the Land Binaries and Scripts (LOLBAS).</p><p><strong>NTFS ADS - control</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\</span><span class=n>System32</span><span class=err>\\</span><span class=n>control</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\</span><span class=n>SysWOW64</span><span class=err>\\</span><span class=n>control</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;(\w+(\.\w+)?):(\w+\.dll)&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>NTFS ADS - appvlp</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Program Files\\Microsoft Office\\root\\Client\\AppVLP.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Program Files (x86)\\Microsoft Office\\root\\Client\\AppVLP.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>NTFS ADS - cmd</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>System32</span><span class=err>\\</span><span class=n>cmd</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>SysWOW64</span><span class=err>\\</span><span class=n>cmd</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;-\s+&lt;.*\b(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>NTFS ADS - ftp</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>System32</span><span class=err>\\</span><span class=n>ftp</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>SysWOW64</span><span class=err>\\</span><span class=n>ftp</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;-s:(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>NTFS ADS - bash</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>System32</span><span class=err>\\</span><span class=n>bash</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>SysWOW64</span><span class=err>\\</span><span class=n>bash</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;-c.*(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>NTFS ADS - mavinject</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>System32</span><span class=err>\\</span><span class=n>mavinject</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>SysWOW64</span><span class=err>\\</span><span class=n>mavinject</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;\d+\s+\/INJECTRUNNING.*\b(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>NTFS ADS - bitsadmin</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>System32</span><span class=err>\\</span><span class=n>bitsadmin</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>SysWOW64</span><span class=err>\\</span><span class=n>bitsadmin</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>regex</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;\/create.*\/addfile.*\/SetNotifyCmdLine.*\b(\w+\.\w+):(\w+(\.\w+)?)&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=62--execution-with-at>62- Execution with AT<a hidden class=anchor aria-hidden=true href=#62--execution-with-at>#</a></h3><p>In order to gain <a href=https://attack.mitre.org/tactics/TA0003/>persistence</a>, <a href=https://attack.mitre.org/tactics/TA0004/>privilege escalation</a>, or <a href=https://attack.mitre.org/tactics/TA0002/>remote execution</a>, an adversary may use the Windows built-in command AT (at.exe) to <a href=https://attack.mitre.org/techniques/T1053/002>schedule a command</a> to be run at a specified time, date, and even host. This method has been used by adversaries and administrators alike. Its use may lead to detection of compromised hosts and compromised users if it is used to move laterally. The built-in Windows tool schtasks.exe (<a href=https://car.mitre.org/analytics/CAR-2013-08-001>CAR-2013-08-001</a>) offers greater flexibility when creating, modifying, and enumerating tasks. For these reasons, schtasks.exe is more commonly used by administrators, tools/scripts, and power users.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\at.exe&#34;</span><span class=o>|</span><span class=n>stats</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>CommandLine</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s2>&#34;Command Lines&#34;</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>ComputerName</span><span class=w>
</span></span></span></code></pre></div><h3 id=63--running-executables-with-same-hash-and-different-names>63- Running executables with same hash and different names<a hidden class=anchor aria-hidden=true href=#63--running-executables-with-same-hash-and-different-names>#</a></h3><p>Executables are generally not renamed, thus a given hash of an executable should only have ever one name. Identifying instances where multiple process names share the same hash may find cases where tools are copied by attackers to different folders or hosts to <a href=https://attack.mitre.org/tactics/TA0005>avoid detection</a>.</p><p>Although this analytic was initially based on MD5 hashes, it is equally applicable to any hashing convention.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=o>|</span><span class=n>stats</span><span class=w> </span><span class=n>dc</span><span class=p>(</span><span class=n>Hashes</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>Num_Hashes</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Hashes</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s2>&#34;Hashes&#34;</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Image</span><span class=o>|</span><span class=k>where</span><span class=w> </span><span class=n>Num_Hashes</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></div><h3 id=64--suspicious-arguments>64- Suspicious Arguments<a hidden class=anchor aria-hidden=true href=#64--suspicious-arguments>#</a></h3><p>Malicious actors may rename built-in commands or external tools, such as those provided by SysInternals, to better <a href=https://attack.mitre.org/tactics/TA0005>blend in</a> with the environment. In those cases, the file path name is arbitrary and may blend in well with the background. If the arguments are closely inspected, it may be possible to infer what tools are running and understand what an adversary is doing. When any legitimate software shares the same command lines, it must be whitelisted according to the expected parameters.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;* -R * -pw*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;* -pw * *@*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*sekurlsa*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;* -hp *&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;* a *&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=65--user-login-activity-monitoring>65- User Login Activity Monitoring<a hidden class=anchor aria-hidden=true href=#65--user-login-activity-monitoring>#</a></h3><p>Monitoring logon and logoff events for hosts on the network is very important for situational awareness. This information can be used as an indicator of unusual activity as well as to corroborate activity seen elsewhere.</p><p>Could be applied to a number of different types of monitoring depending on what information is desired. Some use cases include monitoring for all remote connections and building login timelines for users. Logon events are Windows Event Code 4624 for Windows Vista and above, 518 for pre-Vista. Logoff events are 4634 for Windows Vista and above, 538 for pre-Vista.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_win_event_log_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4624</span><span class=o>|</span><span class=k>search</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=p>[</span><span class=k>search</span><span class=w> </span><span class=k>index</span><span class=o>=</span><span class=n>__your_win_event_log_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4624</span><span class=o>|</span><span class=n>top</span><span class=w> </span><span class=mi>30</span><span class=w> </span><span class=n>Account_Name</span><span class=o>|</span><span class=k>table</span><span class=w> </span><span class=n>Account_Name</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><h3 id=66--powershell-execution>66- PowerShell Execution<a hidden class=anchor aria-hidden=true href=#66--powershell-execution>#</a></h3><p><a href=https://attack.mitre.org/techniques/T1059/001/>PowerShell</a> is a scripting environment included with Windows that is used by both attackers and administrators. Execution of PowerShell scripts in most Windows versions is opaque and not typically secured by antivirus which makes using PowerShell an easy way to circumvent security measures. This analytic detects execution of PowerShell scripts.</p><p>Powershell can be used to hide monitored command line execution such as:</p><ul><li><code>net use</code></li><li><code>sc start</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\powershell.exe&#34;</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=s2>&#34;C:\\Windows\\explorer.exe&#34;</span><span class=o>|</span><span class=n>stats</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>CommandLine</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s2>&#34;Command Lines&#34;</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>ParentImage</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s2>&#34;Parent Images&#34;</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>ComputerName</span><span class=w>
</span></span></span></code></pre></div><h3 id=67--services-launching-cmd>67- Services launching Cmd<a hidden class=anchor aria-hidden=true href=#67--services-launching-cmd>#</a></h3><p>Windows runs the <a href=https://en.wikipedia.org/wiki/Service_Control_Manager>Service Control Manager</a> (SCM) within the process <code>services.exe</code>. Windows launches services as independent processes or DLL loads within a <a href=https://en.wikipedia.org/wiki/svchost.exe>svchost.exe</a> group. To be a legitimate service, a process (or DLL) must have the appropriate service entry point <a href=https://msdn.microsoft.com/en-us/library/windows/desktop/ms687414.aspx>SvcMain</a>. If an application does not have the entry point, then it will timeout (default is 30 seconds) and the process will be killed.</p><p>To survive the timeout, <a href=https://www.operationblockbuster.com/wp-content/uploads/2016/02/Operation-Blockbuster-RAT-and-Staging-Report.pdf>adversaries and red teams</a> can create services that direct to <code>cmd.exe</code> with the flag <code>/c</code>, followed by the desired command. The <code>/c</code> flag causes the command shell to run a command and immediately exit. As a result, the desired program will remain running and it will report an error starting the service. This analytic will catch that command prompt instance that is used to launch the actual malicious executable. Additionally, the children and descendants of services.exe will run as a SYSTEM user by default. Thus, services are a convenient way for an adversary to gain <a href=https://attack.mitre.org/tactics/TA0003>Persistence</a> and <a href=https://attack.mitre.org/tactics/TA0004>Privilege Escalation</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\cmd.exe&#34;</span><span class=w> </span><span class=n>ParentImage</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\services.exe&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=68--command-launched-from-winlogon>68- Command Launched from WinLogon<a hidden class=anchor aria-hidden=true href=#68--command-launched-from-winlogon>#</a></h3><p>An adversary can use <a href=https://attack.mitre.org/techniques/T1546/008>accessibility features</a> (Ease of Access), such as StickyKeys or Utilman, to launch a command shell from the logon screen and gain SYSTEM access. Since an adversary does not have physical access to the machine, this technique must be run within <a href=https://attack.mitre.org/techniques/T1021/001>Remote Desktop</a>. To prevent an adversary from getting to the login screen without first authenticating, Network-Level Authentication (NLA) must be enabled. If a debugger is set up for one of the accessibility features, then it will intercept the process launch of the feature and instead execute a new command line. This analytic looks for instances of <code>cmd.exe</code> or <code>powershell.exe</code> launched directly from the logon process, <code>winlogon.exe</code>. It should be used in tandem with <a href=https://car.mitre.org/analytics/CAR-2014-11-003>CAR-2014-11-003</a>, which detects the accessibility programs in the command line.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>ParentImage</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\winlogon.exe&#34;</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\cmd.exe&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=69--host-discovery-commands>69- Host Discovery Commands<a hidden class=anchor aria-hidden=true href=#69--host-discovery-commands>#</a></h3><p>When entering on a host for the first time, an adversary may try to <a href=https://attack.mitre.org/tactics/TA0007>discover</a> information about the host. There are several built-in Windows commands that can be used to learn about the software configurations, active users, administrators, and networking configuration. These commands should be monitored to identify when an adversary is learning information about the system and environment. The information returned may impact choices an adversary can make when <a href=https://attack.mitre.org/tactics/TA0003>establishing persistence</a>, <a href=https://attack.mitre.org/tactics/TA0004>escalating privileges</a>, or <a href=https://attack.mitre.org/tactics/TA0008>moving laterally</a>.</p><p>Because these commands are built in, they may be run frequently by power users or even by normal users. Thus, an analytic looking at this information should have well-defined white- or blacklists, and should consider looking at an anomaly detection approach, so that this information can be learned dynamically.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\hostname.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\ipconfig.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\net.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\quser.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\qwinsta.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\sc.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;* query *&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;* qc *&#34;</span><span class=p>))</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\systeminfo.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\tasklist.exe&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\whoami.exe&#34;</span><span class=p>)</span><span class=o>|</span><span class=n>stats</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>Image</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s2>&#34;Images&#34;</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>CommandLine</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s2>&#34;Command Lines&#34;</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>ComputerName</span><span class=w>
</span></span></span></code></pre></div><h3 id=70--create-remote-process-via-wmic>70- Create Remote Process via WMIC<a hidden class=anchor aria-hidden=true href=#70--create-remote-process-via-wmic>#</a></h3><p>Adversaries may use <a href=https://attack.mitre.org/techniques/T1047>Windows Management Instrumentation</a> (WMI) to move laterally, by launching executables remotely.The analytic <a href=https://car.mitre.org/analytics/CAR-2014-12-001>CAR-2014-12-001</a> describes how to detect these processes with network traffic monitoring and process monitoring on the target host. However, if the command line utility <code>wmic.exe</code> is used on the source host, then it can additionally be detected on an analytic. The command line on the source host is constructed into something like <code>wmic.exe /node:"\&lt;hostname\>" process call create "\&lt;command line\>"</code>. It is possible to also connect via IP address, in which case the string <code>"\&lt;hostname\>"</code> would instead look like <code>IP Address</code>.</p><p>Although this analytic was created after <a href=https://car.mitre.org/analytics/CAR-2014-12-001>CAR-2014-12-001</a>, it is a much simpler (although more limited) approach. Processes can be created remotely via WMI in a few other ways, such as more direct API access or the built-in utility</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\wmic.exe&#34;</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;* process call create *&#34;</span><span class=o>|</span><span class=k>search</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;* /node:*&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=71--uac-bypass>71- UAC Bypass<a hidden class=anchor aria-hidden=true href=#71--uac-bypass>#</a></h3><p>Bypassing user account control (UAC Bypass) is generally done by piggybacking on a system process that has auto-escalate privileges. This analytic looks to detect those cases as described by the open-source <a href=https://github.com/hfiref0x/UACME>UACME</a> tool.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>_your_sysmon_index_</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>IntegrityLevel</span><span class=o>=</span><span class=n>High</span><span class=o>|</span><span class=k>search</span><span class=w> </span><span class=p>(</span><span class=n>ParentCommandLine</span><span class=o>=</span><span class=s2>&#34;\&#34;</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>system32</span><span class=err>\\</span><span class=n>dism</span><span class=p>.</span><span class=n>exe</span><span class=err>\</span><span class=s2>&#34;*&#34;&#34;*.xml&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>Image</span><span class=o>!=</span><span class=s2>&#34;c:\\users\\*\\appdata\\local\\temp\\*\\dismhost.exe&#34;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>ParentImage</span><span class=o>=</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>system32</span><span class=err>\\</span><span class=n>fodhelper</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;\&#34;</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>system32</span><span class=err>\\</span><span class=n>wusa</span><span class=p>.</span><span class=n>exe</span><span class=err>\</span><span class=s2>&#34;*/quiet*&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>User</span><span class=o>!=</span><span class=n>NOT_TRANSLATED</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>CurrentDirectory</span><span class=o>=</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>system32</span><span class=err>\\</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>ParentImage</span><span class=o>!=</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>explorer</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*.exe\&#34;</span><span class=o>*</span><span class=n>cleanmgr</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=o>/</span><span class=n>autoclean</span><span class=o>*</span><span class=s2>&#34; OR (ParentImage=&#34;</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=o>*</span><span class=n>dccw</span><span class=p>.</span><span class=n>exe</span><span class=s2>&#34; AND Image!=&#34;</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>system32</span><span class=err>\\</span><span class=n>cttune</span><span class=p>.</span><span class=n>exe</span><span class=s2>&#34;) OR Image=&#34;</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>program</span><span class=w> </span><span class=n>files</span><span class=err>\\</span><span class=n>windows</span><span class=w> </span><span class=n>media</span><span class=w> </span><span class=n>player</span><span class=err>\\</span><span class=n>osk</span><span class=p>.</span><span class=n>exe</span><span class=s2>&#34; OR ParentImage=&#34;</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>system32</span><span class=err>\\</span><span class=n>slui</span><span class=p>.</span><span class=n>exe</span><span class=s2>&#34;|eval PossibleTechniques=case(like(lower(ParentCommandLine),&#34;</span><span class=o>%</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>system32</span><span class=err>\\</span><span class=n>dism</span><span class=p>.</span><span class=n>exe</span><span class=o>%</span><span class=s2>&#34;), &#34;</span><span class=n>UACME</span><span class=w> </span><span class=o>#</span><span class=mi>23</span><span class=s2>&#34;, like(lower(Image),&#34;</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>program</span><span class=w> </span><span class=n>files</span><span class=err>\\</span><span class=n>windows</span><span class=w> </span><span class=n>media</span><span class=w> </span><span class=n>player</span><span class=err>\\</span><span class=n>osk</span><span class=p>.</span><span class=n>exe</span><span class=s2>&#34;), &#34;</span><span class=n>UACME</span><span class=w> </span><span class=o>#</span><span class=mi>32</span><span class=s2>&#34;, like(lower(ParentImage),&#34;</span><span class=k>c</span><span class=p>:</span><span class=err>\\</span><span class=n>windows</span><span class=err>\\</span><span class=n>system32</span><span class=err>\\</span><span class=n>fodhelper</span><span class=p>.</span><span class=n>exe</span><span class=s2>&#34;),  &#34;</span><span class=n>UACME</span><span class=w> </span><span class=o>#</span><span class=mi>33</span><span class=s2>&#34;, like(lower(CommandLine),&#34;</span><span class=o>%</span><span class=p>.</span><span class=n>exe</span><span class=err>\</span><span class=s2>&#34;%cleanmgr.exe /autoclean%&#34;</span><span class=p>),</span><span class=w> </span><span class=s2>&#34;UACME #34&#34;</span><span class=p>,</span><span class=w> </span><span class=k>like</span><span class=p>(</span><span class=k>lower</span><span class=p>(</span><span class=n>Image</span><span class=p>),</span><span class=s2>&#34;c:\\windows\\system32\\wusa.exe&#34;</span><span class=p>),</span><span class=w> </span><span class=s2>&#34;UACME #36&#34;</span><span class=p>,</span><span class=w> </span><span class=k>like</span><span class=p>(</span><span class=k>lower</span><span class=p>(</span><span class=n>ParentImage</span><span class=p>),</span><span class=s2>&#34;c:\\windows\\%dccw.exe&#34;</span><span class=p>),</span><span class=w> </span><span class=s2>&#34;UACME #37&#34;</span><span class=p>,</span><span class=w> </span><span class=k>like</span><span class=p>(</span><span class=k>lower</span><span class=p>(</span><span class=n>ParentImage</span><span class=p>),</span><span class=s2>&#34;c:\\windows\\system32\\slui.exe&#34;</span><span class=p>),</span><span class=w> </span><span class=s2>&#34;UACME #45&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=72--generic-regsvr32>72- Generic Regsvr32<a hidden class=anchor aria-hidden=true href=#72--generic-regsvr32>#</a></h3><p>Regsvr32 can be used to execute arbitrary code in the context of a Windows signed binary, which can be used to bypass application whitelisting. This analytic looks for suspicious usage of the tool. It’s not likely that you’ll get millions of hits, but it does occur during normal activity so some form of baselining would be necessary for this to be an alerting analytic. Alternatively, it can be used for hunt by looking for new or anomalous DLLs manually.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_data__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>regsvr32</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>search</span><span class=w> </span><span class=n>ParentImage</span><span class=o>=</span><span class=s2>&#34;*regsvr32.exe&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>Image</span><span class=o>!=</span><span class=s2>&#34;*regsvr32.exe*&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=73--squiblydoo>73- Squiblydoo<a hidden class=anchor aria-hidden=true href=#73--squiblydoo>#</a></h3><p>Squiblydoo is a specific usage of regsvr32.dll to load a COM scriptlet directly from the internet and execute it in a way that bypasses application whitelisting. It can be seen by looking for regsvr32.exe executions that load the scrobj.dll (which execute the COM scriptlet) or, if that is too noisy, those that also load content directly via HTTP or HTTPS.</p><p>Squiblydoo was first written up by Casey Smith at Red Canary, though that blog post is no longer accessible.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_events__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>regsvr32</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=n>scrobj</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>search</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*regsvr32.exe&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=74--credential-dumping-via-mimikatz>74- Credential Dumping via Mimikatz<a hidden class=anchor aria-hidden=true href=#74--credential-dumping-via-mimikatz>#</a></h3><p>Credential dumpers like Mimikatz can be loaded into memory and from there read data from another processes. This analytic looks for instances where processes are requesting specific permissions to read parts of the LSASS process in order to detect when credential dumping is occurring. One weakness is that all current implementations are “overtuned” to look for common access patterns used by Mimikatz.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_data__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>10</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=n>TargetImage</span><span class=o>=</span><span class=s2>&#34;C:\\WINDOWS\\system32\\lsass.exe&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=n>GrantedAccess</span><span class=o>=</span><span class=mi>0</span><span class=n>x1410</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>GrantedAccess</span><span class=o>=</span><span class=mi>0</span><span class=n>x1010</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>GrantedAccess</span><span class=o>=</span><span class=mi>0</span><span class=n>x1438</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>GrantedAccess</span><span class=o>=</span><span class=mi>0</span><span class=n>x143a</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>GrantedAccess</span><span class=o>=</span><span class=mi>0</span><span class=n>x1418</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>CallTrace</span><span class=o>=</span><span class=s2>&#34;C:\\windows\\SYSTEM32\\ntdll.dll+*|C:\\windows\\System32\\KERNELBASE.dll+20edd|UNKNOWN(*)&#34;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=n>hostname</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=n>SourceImage</span><span class=w> </span><span class=n>GrantedAccess</span><span class=w>
</span></span></span></code></pre></div><h3 id=75--access-permission-modification>75- Access Permission Modification<a hidden class=anchor aria-hidden=true href=#75--access-permission-modification>#</a></h3><p>Adversaries sometimes modify object access rights at the operating system level. There are varying motivations behind this action - they may not want some files/objects to be changed on systems for persistence reasons and therefore provide admin only rights; also, they may want files to be accessible with lower levels of permissions.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_windows_security_log_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>4670</span><span class=w> </span><span class=n>Object_Type</span><span class=o>=</span><span class=s2>&#34;File&#34;</span><span class=w> </span><span class=n>Security_ID</span><span class=o>!=</span><span class=s2>&#34;NT AUTHORITY\\SYSTEM&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=76--lsass-process-dump-via-procdump>76- Lsass Process Dump via Procdump<a hidden class=anchor aria-hidden=true href=#76--lsass-process-dump-via-procdump>#</a></h3><p><a href=https://docs.microsoft.com/en-us/sysinternals/downloads/procdump>ProcDump</a> is a sysinternal command-line utility whose primary purpose is monitoring an application for CPU spikes and generating crash dumps during a spike that an administrator or developer can use to determine the cause of the spike.</p><p>ProcDump may be used to dump the memory space of lsass.exe to disk for processing with a credential access tool such as Mimikatz. This is performed by launching procdump.exe as a privileged user with command line options indicating that lsass.exe should be dumped to a file with an arbitrary name.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*\\procdump*.exe&#34;</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*lsass*&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=77--credential-dumping-via-windows-task-manager>77- Credential Dumping via Windows Task Manager<a hidden class=anchor aria-hidden=true href=#77--credential-dumping-via-windows-task-manager>#</a></h3><p>The Windows Task Manager may be used to dump the memory space of <code>lsass.exe</code> to disk for processing with a credential access tool such as Mimikatz. This is performed by launching Task Manager as a privileged user, selecting <code>lsass.exe</code>, and clicking “Create dump file”. This saves a dump file to disk with a deterministic name that includes the name of the process being dumped.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>11</span><span class=w> </span><span class=n>TargetFilename</span><span class=o>=</span><span class=s2>&#34;*lsass*.dmp&#34;</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\taskmgr.exe&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=78--active-directory-dumping-via-ntdsutil>78- Active Directory Dumping via NTDSUtil<a hidden class=anchor aria-hidden=true href=#78--active-directory-dumping-via-ntdsutil>#</a></h3><p>The NTDSUtil tool may be used to dump a Microsoft Active Directory database to disk for processing with a credential access tool such as Mimikatz. This is performed by launching <code>ntdsutil.exe</code> as a privileged user with command line arguments indicating that media should be created for offline Active Directory installation and specifying a folder path. This process will create a copy of the Active Directory database, <code>ntds.dit</code>, to the specified folder path.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>11</span><span class=w> </span><span class=n>TargetFilename</span><span class=o>=</span><span class=s2>&#34;*ntds.dit&#34;</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;*ntdsutil.exe&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=79--shadow-copy-deletion>79- Shadow Copy Deletion<a hidden class=anchor aria-hidden=true href=#79--shadow-copy-deletion>#</a></h3><p>The Windows <a href=https://docs.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service>Volume Shadow Copy Service</a> is a built-in OS feature that can be used to create backup copies of files and volumes.</p><p>Adversaries may delete these shadow copies, typically through the usage of system utilities such as vssadmin.exe or wmic.exe, in order prevent file and data recovery. This technique is commonly employed for this purpose by ransomware.</p><p><strong>Vssadmin.exe delete shadows</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\System32\\vssadmin.exe&#34;</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*delete shadows*&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>WMIC shadowcopy delete</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>Image</span><span class=o>=</span><span class=s2>&#34;C:\\Windows\\*\\wmic.exe&#34;</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=s2>&#34;*shadowcopy delete*&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=80--minidump-of-lsass>80- MiniDump of LSASS<a hidden class=anchor aria-hidden=true href=#80--minidump-of-lsass>#</a></h3><p>This analytic detects the minidump variant of credential dumping where a process opens lsass.exe in order to extract credentials using the Win32 API call <a href=https://docs.microsoft.com/en-us/windows/win32/api/minidumpapiset/nf-minidumpapiset-minidumpwritedump>MiniDumpWriteDump</a>. Tools like <a href=https://github.com/GhostPack/SafetyKatz>SafetyKatz</a>, <a href=https://github.com/m0rv4i/SafetyDump>SafetyDump</a>, and <a href=https://github.com/outflanknl/Dumpert>Outflank-Dumpert</a> default to this variant and may be detected by this analytic, though keep in mind that not all options for using those tools will result in this specific behavior.</p><p>The analytic is based on a <a href=https://github.com/NVISO-BE/sigma-public/blob/master/rules/windows/sysmon/sysmon_lsass_memdump.yml>Sigma analytic</a> contributed by Samir Bousseaden and written up in a <a href=https://blog.menasec.net/2019/02/threat-hunting-21-procdump-or-taskmgr.html>blog on MENASEC</a>. It looks for a call trace that includes either dbghelp.dll or dbgcore.dll, which export the relevant functions/permissions to perform the dump. It also detects using the Windows Task Manager (taskmgr.exe) to dump lsass, which is described in <a href=https://car.mitre.org/analytics/CAR-2019-08-001/>CAR-2019-08-001</a>. In this iteration of the Sigma analytic, the <code>GrantedAccess</code> filter isn’t included because it didn’t seem to filter out any false positives and introduces the potential for evasion.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>10</span><span class=w> </span><span class=n>TargetImage</span><span class=o>=</span><span class=s2>&#34;C:\\windows\\system32\\lsass.exe&#34;</span><span class=w> </span><span class=p>(</span><span class=n>CallTrace</span><span class=o>=</span><span class=s2>&#34;*dbghelp.dll*&#34;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>CallTrace</span><span class=o>=</span><span class=s2>&#34;*dbgcore.dll*&#34;</span><span class=p>)</span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>_time</span><span class=w> </span><span class=k>host</span><span class=w> </span><span class=n>SourceProcessId</span><span class=w> </span><span class=n>SourceImage</span><span class=w>
</span></span></span></code></pre></div><h3 id=81--rare-lolbas-command-lines>81- Rare LolBAS Command Lines<a hidden class=anchor aria-hidden=true href=#81--rare-lolbas-command-lines>#</a></h3><p><a href=https://lolbas-project.github.io/>LoLBAS</a> are binaries and scripts that are built in to Windows, frequently are signed by Microsoft, and may be used by an attacker. Some LoLBAS are used very rarely and it might be possible to alert every time they’re used (this would depend on your environment), but many others are very common and can’t be simply alerted on.</p><p>This analytic takes all instances of LoLBAS execution and then looks for instances of command lines that are not normal in the environment. This can detect attackers (which will tend to need the binaries for something different than normal usage) but will also tend to have false positives.</p><p>The analytic needs to be tuned. The <code>1.5</code> in the query is the number of standard deviations away to look. It can be tuned up to filter out more noise and tuned down to get more results. This means it is probably best as a hunting analytic when you have analysts looking at the screen and able to tune the analytic up and down, because the threshold may not be stable for very long.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>index</span><span class=o>=</span><span class=n>__your_sysmon_index__</span><span class=w> </span><span class=n>EventCode</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>At</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Atbroker</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Bash</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Bitsadmin</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Certutil</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cmd</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cmdkey</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cmstp</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Control</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Csc</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cscript</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Dfsvc</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Diskshadow</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Dnscmd</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Esentutl</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Eventvwr</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expand</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Extexport</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Extrac32</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Findstr</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Forfiles</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Ftp</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Gpscript</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Hh</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Ie4uinit</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Ieexec</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Infdefaultinstall</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Installutil</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Jsc</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Makecab</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mavinject</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>Workflow</span><span class=p>.</span><span class=n>r</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mmc</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Msbuild</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Msconfig</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Msdt</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mshta</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Msiexec</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Odbcconf</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pcalua</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pcwrun</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Presentationhost</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Print</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reg</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Regasm</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Regedit</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Register</span><span class=o>-</span><span class=n>cimprovider</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Regsvcs</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Regsvr32</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>Replace</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Rpcping</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Rundll32</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runonce</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runscripthelper</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Sc</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Schtasks</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Scriptrunner</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SyncAppvPublishingServer</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Tttracer</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Verclsid</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Wab</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Wmic</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Wscript</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Wsreset</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Xwizard</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Advpack</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Comsvcs</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Ieadvpack</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Ieaframe</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mshtml</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pcwutl</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Setupapi</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Shdocvw</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Shell32</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Syssetup</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Url</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Zipfldr</span><span class=p>.</span><span class=n>dll</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Appvlp</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Bginfo</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cdb</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>csi</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Devtoolslauncher</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dnx</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Dxcap</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Excel</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mftrace</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Msdeploy</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msxsl</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Powerpnt</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rcsi</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Sqler</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Sqlps</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SQLToolsPS</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Squirrel</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>te</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Tracker</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>Update</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vsjitdebugger</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Winword</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Wsl</span><span class=p>.</span><span class=n>exe</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CL_Mutexverifiers</span><span class=p>.</span><span class=n>ps1</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CL_Invocation</span><span class=p>.</span><span class=n>ps1</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Manage</span><span class=o>-</span><span class=n>bde</span><span class=p>.</span><span class=n>wsf</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubprn</span><span class=p>.</span><span class=n>vbs</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Slmgr</span><span class=p>.</span><span class=n>vbs</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Syncappvpublishingserver</span><span class=p>.</span><span class=n>vbs</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>winrm</span><span class=p>.</span><span class=n>vbs</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>OriginalFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pester</span><span class=p>.</span><span class=n>bat</span><span class=p>)</span><span class=o>|</span><span class=n>eval</span><span class=w> </span><span class=n>CommandLine</span><span class=o>=</span><span class=k>lower</span><span class=p>(</span><span class=n>CommandLine</span><span class=p>)</span><span class=o>|</span><span class=n>eventstats</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>process</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>procCount</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>process</span><span class=o>|</span><span class=n>eventstats</span><span class=w> </span><span class=k>avg</span><span class=p>(</span><span class=n>procCount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>avg</span><span class=w> </span><span class=n>stdev</span><span class=p>(</span><span class=n>procCount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>stdev</span><span class=o>|</span><span class=n>eval</span><span class=w> </span><span class=n>lowerBound</span><span class=o>=</span><span class=p>(</span><span class=k>avg</span><span class=o>-</span><span class=n>stdev</span><span class=o>*</span><span class=mi>1</span><span class=p>.</span><span class=mi>5</span><span class=p>)</span><span class=o>|</span><span class=n>eval</span><span class=w> </span><span class=n>isOutlier</span><span class=o>=</span><span class=k>if</span><span class=p>((</span><span class=n>procCount</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>lowerBound</span><span class=p>),</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=k>where</span><span class=w> </span><span class=n>isOutlier</span><span class=o>=</span><span class=mi>1</span><span class=o>|</span><span class=k>table</span><span class=w> </span><span class=k>host</span><span class=p>,</span><span class=w> </span><span class=n>Image</span><span class=p>,</span><span class=w> </span><span class=n>ParentImage</span><span class=p>,</span><span class=w> </span><span class=n>CommandLine</span><span class=p>,</span><span class=w> </span><span class=n>ParentCommandLine</span><span class=p>,</span><span class=w> </span><span class=n>procCount</span><span class=w>
</span></span></span></code></pre></div><p><strong>References:</strong></p><p><a href=https://www.youtube.com/c/SplunkHowTo/videos>Splunk How-To</a></p><p><a href=https://car.mitre.org/>car.mitre.org</a></p><p><a href=https://car.mitre.org/analytics/>Analytics</a></p><hr><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-3526678290068011 data-ad-slot=7160066188></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=anir0y data-description="Support me on Buy me a coffee!" data-message data-color=#5F7FFF data-position=Right data-x_margin=18 data-y_margin=18></script></div><footer class=post-footer><ul class=post-tags><li><a href=https://classroom.anir0y.in/tags/splunk/>Splunk</a></li><li><a href=https://classroom.anir0y.in/tags/soc/>Soc</a></li></ul><nav class=paginav><a class=prev href=https://classroom.anir0y.in/post/blog-autohackos/><span class=title>« Prev</span><br><span>AutoHackOS A New Operating System for Automobile Pentesting</span>
</a><a class=next href=https://classroom.anir0y.in/post/blog-optimizing-web-application-performance-and-security-with-azure-front-door-and-application-gateway/><span class=title>Next »</span><br><span>Optimizing Web Application Performance and Security With Azure Front Door and Application Gateway</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share SOC Splunk101 on x" href="https://x.com/intent/tweet/?text=SOC%20Splunk101&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f&amp;hashtags=splunk%2csoc"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SOC Splunk101 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f&amp;title=SOC%20Splunk101&amp;summary=SOC%20Splunk101&amp;source=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SOC Splunk101 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f&title=SOC%20Splunk101"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SOC Splunk101 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SOC Splunk101 on whatsapp" href="https://api.whatsapp.com/send?text=SOC%20Splunk101%20-%20https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SOC Splunk101 on telegram" href="https://telegram.me/share/url?text=SOC%20Splunk101&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SOC Splunk101 on ycombinator" href="https://news.ycombinator.com/submitlink?t=SOC%20Splunk101&u=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>YOU CAN REUSE MY CONTENT</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>