<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Try Hack Me Room Osquery | Classroom</title><meta name=keywords content="notes,tryhackme,rooms"><meta name=description content="Try Hack Me Room Osquery solved by Animesh Roy"><meta name=author content="Animesh Roy"><link rel=canonical href=https://classroom.anir0y.in/post/thm-room-osquery/><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=icon type=image/png sizes=16x16 href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=icon type=image/png sizes=32x32 href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=apple-touch-icon href=https://classroom.anir0y.in/img/avatar.jpeg><link rel=mask-icon href=https://classroom.anir0y.in/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://classroom.anir0y.in/post/thm-room-osquery/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://classroom.anir0y.in/post/thm-room-osquery/"><meta property="og:site_name" content="Classroom"><meta property="og:title" content="Try Hack Me Room Osquery"><meta property="og:description" content="Try Hack Me Room Osquery solved by Animesh Roy"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-05-16T23:54:39+05:30"><meta property="article:modified_time" content="2021-05-16T23:54:39+05:30"><meta property="article:tag" content="Notes"><meta property="article:tag" content="Tryhackme"><meta property="article:tag" content="Rooms"><meta property="og:image" content="https://classroom.anir0y.in/img/thm.gif"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://classroom.anir0y.in/img/thm.gif"><meta name=twitter:title content="Try Hack Me Room Osquery"><meta name=twitter:description content="Try Hack Me Room Osquery solved by Animesh Roy"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://classroom.anir0y.in/post/"},{"@type":"ListItem","position":2,"name":"Try Hack Me Room Osquery","item":"https://classroom.anir0y.in/post/thm-room-osquery/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Try Hack Me Room Osquery","name":"Try Hack Me Room Osquery","description":"Try Hack Me Room Osquery solved by Animesh Roy","keywords":["notes","tryhackme","rooms"],"articleBody":"Osquery Profile Support TASK 1 : Introduction Osquery is an open-source tool created by Facebook. With Osquery, Security Analysts, Incident Responders, Threat Hunters, etc., can query an endpoint (or multiple endpoints) using SQL syntax. Osquery can be installed on multiple platforms: Windows, Linux, macOS, and FreeBSD.\nMany well-known companies, besides Facebook, either use Osquery, utilize osquery within their tools, and/or look for individuals who know Osquery.\nAs of today (March 2021), Github and AT\u0026T seek individuals who have experience with Osquery.\nGithub: AT\u0026T:\nSome of the tools (open-source and commercial) that utilize Osquery are listed below.\nAlienvault: The AlienVault agent is based on Osquery. Cisco: Cisco AMP (Advanced Malware Protection) for endpoints utilize Osquery in Cisco Orbital. Learning Osquery will be beneficial if you are looking to enter into this field or if you‚Äôre already in the field and you‚Äôre looking to level up your skills.\nTASK 2 : Installation Install Osquery on your local machine or local virtual machine, please refer to the installation instructions.\nWindows Linux MacOS FreeBSD Refer to the documentation on the Osquery daemon (osqueryd) information and all the command-line flags here. Schema is here\nTASK 3 : Interacting with the Osquery Shell To interact with the Osquery interactive console/shell, open CMD (or PowerShell) and run osqueryi.\nAs per the documentation, osqueryi is a modified version of the SQLite shell.\nYou‚Äôll know that you‚Äôve successfully entered into the interactive shell by the new command prompt. One way to familiarize yourself with the Osquery interactive shell, as with any new tool, is to check its help menu.\nIn Osquery, the help command (or meta-command) is .help. Note: As per the documentation, meta-commands are prefixed with a '.'.\nTo list all the available tables that can be queried, use the .tables meta-command.\nFor example, if you wish to check what tables are associated with processes, you can use .tables process.\nIn the above image, 3 tables are returned that contain the word ‚Äòprocess.‚Äô\nNote: Depending on the operating system, different tables will be returned when the .tables meta-command is executed.\nTable names are not enough to know exactly what information is contained in any given table without actually querying it.\nKnowing what columns and types, known as a schema, for each table are also useful.\nYou can list a table‚Äôs schema with the following meta-command: .schema table_name Looking at the above image, pid is the column, and BIGINT is the type.\nNote: Any user on a system can run and interact with osqueryi, but some tables might return limited results compared to running osqueryi from an elevated shell.\nIf you which to check the schema for another operating system, you‚Äôll need to use the --enable_foreign command-line flag.\nTo read more about command-line flags, refer to this page, https://osquery.readthedocs.io/en/latest/installation/cli-flags/.\nInteracting with the shell to get quick schema information for a table is good but not ideal when you want schema information for multiple tables.\nFor that, the schema API online documentation can be used to view a complete list of tables, columns, types, and column descriptions.\nFlag 3.1 What is the Osquery version run .version to get the flag\nFlag 3.2 What is the SQLite version? run .version to get the flag\nFlag 3.3 What is the default output mode? run the .show command to get the answer\nFlag 3.4 What is the meta-command to set the output to show one value per line? run .help command to find out the .mode args.\nFlag 3.5 What are the 2 meta-commands to exit osqueryi? not a rocket science, figure it out by yourself.\nHint: Don‚Äôt quit ;)\nTASK 4 : Schema Documentation Head over to the schema documentation here. The above image is a resemblance to what you‚Äôll see when you navigate to the page.\nNote: At the time of this writing, the current version for Osquery is 4.7.0.\nA breakdown of the information listed on the schema API page is explained below.\nA dropdown listing various versions of Osquery. Choose the version of Osquery you wish to see schema tables for. The number of tables within the selected version of Osquery. (In the above image, 271 tables exist for Osquery 4.7.0) The list of the tables is listed in alphabetical order for the selected version of Osquery. The name of the table and a brief description. A detailed chart listing the column, type, and column description for each table. Information to which operating system the table applies to. (In the above image, the account_policy_data table is available only for macOS) You have enough information to confidently navigate this resource to retrieve any information you‚Äôll need.\nFlag 4.1 What table would you query to get the version of Osquery installed on the Windows endpoint? search for osquery_* tables and find out which one have vesion column.\nFlag 4.2 How many tables are there for this version of Osquery? just open the website here you‚Äôll see it in left corner.\nFlag 4.3 How many of the tables for this version are compatible with Windows? just open the website here filter for windows. Flag 4.4 How many tables is compatible with Linux? just open the website here filter for Linux. Flag 4.5 What is the first table listed that is compatible with both Linux and Windows? just open the website here filter for windows \u0026 Linux type the first table name. TASK 5 : Creating queries The SQL language implemented in Osquery is not an entire SQL language that you might be accustomed to, but rather it‚Äôs a superset of SQLite‚Äôs.\nRealistically all your queries will start with a SELECT statement. This makes sense because, with Osquery, you are only querying information on an endpoint or endpoints. You won‚Äôt be updating or deleting any information/data on the endpoint.\nThe exception to the rule: The use of other SQL statements, such as UPDATE and DELETE, is possible, but only if you‚Äôre creating run-time tables (views) or using an extension if the extension supports them.\nYour queries will also include a FROM clause and end with a semicolon.\nIf you wish to retrieve all the information about the running processes on the endpoint: SELECT * FROM processes; Note: The results for you will be different if you run this query in the attached VM or your local machine (if Osquery is installed).\nThe number of columns returned might be more than what you need. You can select specific columns rather than retrieving every column in the table.\nQuery: SELECT pid, name, path FROM processes;\nThe above query will list the process id, the process‚Äôs name, and the path for all running processes on the endpoint.\nThis will still return a large number of results, depending on how busy the endpoint is.\nThe count() function can be used to get exactly how many.\nQuery: SELECT count(*) from processes; The output can be limited to the first 3 in ascending order by process name, as shown below. Optionally, you can use a WHERE clause to narrow down the list of results returned based on specified criteria.\nQuery: SELECT pid, name, path FROM processes WHERE name='lsass.exe'; The equal sign is not the only filtering option available in a WHERE clause.\nBelow are filtering operators that can be used in a WHERE clause:\n= [equal] \u003c\u003e [not equal] \u003e, \u003e= [greater than, greater than or equal to] \u003c, \u003c=[less than or less than or equal to] BETWEEN [between a range] LIKE [pattern wildcard searches] %[wildcard, multiple characters] _ [wildcard, one character] Below is a screenshot from the Osquery documentation showing examples of using wildcards when used in folder structures. Some tables will require a WHERE clause, such as the file table, to return a value. If the required WHERE clause is not included in the query, then you will get an error. The last concept to cover is JOIN. To join 2 or more tables, each table needs to share a column in common.\nLet‚Äôs look at 2 tables to demonstrate this further. Below is the schema for the osquery_info table and the processes table.\nThe common column in both tables is pid. A query can be constructed to use the JOIN clause to join these 2 tables USING the PID column.\nQuery: SELECT pid, name, path FROM osquery_info JOIN processes USING (pid); Flags 5.1 What is the query to show the username field from the users table where the username is 3 characters long and ends with ‚Äôen‚Äô? (use single quotes in your answer) Query: select username from users where username like '%nt';\nModify the query Smarty Pants!\nTASK 6 : Using Kolide Fleet In this task, we will look at an open-source Osquery Fleet Manager known as Kolide Fleet.\nWith Kolide Fleet, instead of using Osquery locally to query an endpoint, you can query multiple endpoints from the Kolide Fleet UI.\nNote: The open-source repo of Kolide Fleet is no longer supported and was retired on November 4th, 2020. A commercial version, known as Kolide K2, is available. You can view more about it here. There is a more recent repo called fleet, a fork of the original Kolide Fleet, and as per the creators of Kolide Fleet, ‚Äúit appears to be the first of many promising forks.‚Äù\nFeel free to explore Query Packs at your own leisure. You can read more about this here and here.\nFlags 6.1 What is the Osquery Enroll Secret? When you click on add host you can copy the secret from there\nFlags 6.2 What is the Osquery version? read it on added host, it‚Äôs in details\nFlags 6.3 What is the path for the running osqueryd.exe process? the launcher path. hint: C:\\Users\\?????????????\\Desktop\\????????\\???????\\osqueryd.exe\nTASK 7 : Osquery extensions Extensions add functionality/features (i.e., additional tables) that are not included in the core Osquery. Anyone can create extensions for Osquery. The official documentation on this subject is here.\nIf you perform a search, you‚Äôll find some interesting ones that can be downloaded and implemented with Osquery with little hassle. Others might require extra steps, such as setting up additional dependencies and compiling the extension before use.\nBelow are 2 repos of Osquery extensions that you can play with.\nhttps://github.com/trailofbits/osquery-extensions https://github.com/polylogyx/osq-ext-bin Flags 7.1 According to the polylogyx readme, how many ‚Äòfeatures‚Äô does the plug-in add to the Osquery core? answer is in readme page: https://github.com/polylogyx/osq-ext-bin/blob/master/README.md\nTASK 8 : Linux and Osquery Review the On-Demand YARA scanning here to answer some of the questions below.\nFlags 8.1 What is the ‚Äòcurrent_value‚Äô for kernel.osrelease? osquery\u003e SELECT * FROM kernel_info;\nFlags 8.2 What is the uid for the bravo user? Query: osquery\u003e SELECT username,uid from users where username= \"bravo\" ;\nFlags 8.3 One of the users performed a ‚ÄòBinary Padding‚Äô attack. What was the target file in the attack? I gave up on real way of finding answer, I guess my way isn‚Äôt intended. correct me if I‚Äôm wrong here. I found the ans by running this: select * from shell_history; and looking into file names.\nFlags 8.4 What is the hash value for this file? Exit from OSQuery, find the file name, run md5sum Flags 8.5 Check all file hashes in the home directory for each user. One file will not show any hashes. Which file is that? it;s the zip. I just bruteforeced it. I guess my way isn‚Äôt intended. correct me here.\nsolution provided by Georg osquery\u003e select path,filename,md5 from file join hash using (path) where path like \"/home/%%/%\" ;\nFlags 8.6 There is a file that is categorized as malicious in one of the home directories. Query the Yara table to find this file. Use the sigfile which is saved in ‚Äò/var/osquery/yara/scanner.yara‚Äô. Which file is it? being a lame person I ran yara directly. query: yara /var/osquery/yara/scanner.yara /home/charlie/\nquery: osquery\u003e SELECT * FROM yara WHERE path=\"/path/filename\" and sigfile=\"/var/osquery/yara/scanner.yara\"; Flags 8.7 What were the ‚Äòmatches‚Äô? ans is on same query run Flags 8.8 Scan the file from Q#3 with the same Yara file. What is the entry for ‚Äòstrings‚Äô? run the same command by changing the file name get the strings.\nQuery: osquery\u003e SELECT * FROM yara WHERE path=\"/home/tryhackme/filename\" and sigfile=\"/var/osquery/yara/scanner.yara\";\nTASK 9 : Windows and Osquery For this exercise, use either Kolide Fleet or the Windows CMD/PowerShell.\nNote: For the questions which involve the Polylogyx osq-ext-bin extension, you‚Äôll need to interact with Osquery via the command line.\nTo load the extension: osqueryi --allow-unsafe --extension \"C:\\Program Files\\osquery\\extensions\\osq-ext-bin\\plgx_win_extension.ext.exe\"\nWait for the command prompt to reflect the phrase Done StartDriver. This will indicate that the extension is fully loaded into the session.\nTip: If the phrase doesn‚Äôt appear after a minute or so, hit the ENTER key. It should appear right after.\nResources for Polylogx osq-ext-bin:\nhttps://github.com/polylogyx/osq-ext-bin/blob/master/README.md https://github.com/polylogyx/osq-ext-bin/tree/master/tables-schema Flags 9.1 What is the description for the Windows Defender Service? Query: select name,description from services where name like \"WinD%\";\nFlags 9.2 There is another security agent on the Windows endpoint. What is the name of this agent? Query:: select name,publisher from programs; Flags 9.3 What is required with win_event_log_data? Well the ‚ÄòOrigin‚Äô from where you get the data (hint: S****E )\nFlags 9.4 How many sources are returned for win_event_log_channels? Query:: osquery\u003e select count (*) from win_event_log_channels; Flags 9.5 What is the schema for win_event_log_data? Query:: osquery\u003e .schema win_event_log_data\nFlags 9.6 previous file scanned on the Linux endpoint with Yara is on the Windows endpoint. What date/time was this file first detected? (Answer format: YYYY-MM-DD HH:MM:SS) Query: osquery\u003e select eventid,datetime from win_event_log_data where source = \"Microsoft-Windows-Windows Defender/Operational\" and eventid like '1116' ; Flags 9.7 What is the query to find the first Sysmon event? Select only the event id, order by date/time, and limit the output to only 1 entry. Query 1: find the sysmon Source select * from win_event_log_channels where source like '%sysmon%';\nQuery 2: select eventid from win_event_log_data where source=\"Microsoft-Windows-Sysmon/Operational\" order by datetime limit 1;\nFlags 9.8 What is the Sysmon event id? TASK 10 : This was a high-level overview of Osquery. This room‚Äôs goal was to introduce you to this alternate method of interacting with endpoints to extract information. There is more to Osquery than what was covered in this room.\nFile Integrity Monitoring: https://osquery.readthedocs.io/en/latest/deployment/file-integrity-monitoring/ Process Auditing: https://osquery.readthedocs.io/en/latest/deployment/process-auditing/ Syslog Consumption: https://osquery.readthedocs.io/en/latest/deployment/syslog/ SIEMs like ELK and Splunk can ingest Osquery logs. If you completed some of the Splunk rooms, specifically Splunk 2 and Splunk 3, you should recall that Osquery logs (osquery:info, osquery:results, and osquery:warning) were part of the various queried sources to extract information. If looking at the log data seemed foreign, now you have a better understanding of the displayed in the results.\nLastly, look at other community projects for Osquery listed at https://osquery.io/.\nThe repo on enterprise threat hunting with Osquery + MITRE ATT\u0026CK is definitely worth your attention.\n","wordCount":"2439","inLanguage":"en","image":"https://classroom.anir0y.in/img/thm.gif","datePublished":"2021-05-16T23:54:39+05:30","dateModified":"2021-05-16T23:54:39+05:30","author":{"@type":"Person","name":"Animesh Roy"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://classroom.anir0y.in/post/thm-room-osquery/"},"publisher":{"@type":"Organization","name":"Classroom","logo":{"@type":"ImageObject","url":"https://classroom.anir0y.in/img/avatar.jpeg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://classroom.anir0y.in/ accesskey=h title="Classroom (Alt + H)"><img src=https://classroom.anir0y.in/img/avatar.jpeg alt aria-label=logo height=35>Classroom</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://classroom.anir0y.in/post/ title=Posts><span>Posts</span></a></li><li><a href=https://classroom.anir0y.in/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://classroom.anir0y.in/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://classroom.anir0y.in/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://classroom.anir0y.in/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://classroom.anir0y.in/about/me/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://classroom.anir0y.in/>Home</a>&nbsp;¬ª&nbsp;<a href=https://classroom.anir0y.in/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Try Hack Me Room Osquery</h1><div class=post-description>Try Hack Me Room Osquery solved by Animesh Roy</div><div class=post-meta><span title='2021-05-16 23:54:39 +0530 IST'>May 16, 2021</span>&nbsp;¬∑&nbsp;<span>12 min</span>&nbsp;¬∑&nbsp;<span>Animesh Roy</span>&nbsp;|&nbsp;<span>
<a href=https://github.com/anir0y/classroom/tree/master/content/post/thm-room-osquery.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></span></div></header><figure class=entry-cover><img loading=eager src=https://classroom.anir0y.in/img/thm.gif alt="cover image"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#osquery>Osquery</a></li><li><a href=#task-1--introduction>TASK 1 : Introduction</a></li><li><a href=#task-2--installation>TASK 2 : Installation</a></li><li><a href=#task-3--interacting-with-the-osquery-shell>TASK 3 : Interacting with the Osquery Shell</a><ul><li><a href=#flag-31>Flag 3.1</a></li><li><a href=#flag-32>Flag 3.2</a></li><li><a href=#flag-33>Flag 3.3</a></li><li><a href=#flag-34>Flag 3.4</a></li><li><a href=#flag-35>Flag 3.5</a></li></ul></li><li><a href=#task-4--schema-documentation>TASK 4 : Schema Documentation</a><ul><li><a href=#flag-41>Flag 4.1</a></li><li><a href=#flag-42>Flag 4.2</a></li><li><a href=#flag-43>Flag 4.3</a></li><li><a href=#flag-44>Flag 4.4</a></li><li><a href=#flag-45>Flag 4.5</a></li></ul></li><li><a href=#task-5--creating-queries>TASK 5 : Creating queries</a><ul><li><a href=#flags-51>Flags 5.1</a></li></ul></li><li><a href=#task-6--using-kolide-fleet>TASK 6 : Using Kolide Fleet</a><ul><li><a href=#flags-61>Flags 6.1</a></li><li><a href=#flags-62>Flags 6.2</a></li><li><a href=#flags-63>Flags 6.3</a></li></ul></li><li><a href=#task-7--osquery-extensions>TASK 7 : Osquery extensions</a><ul><li><a href=#flags-71>Flags 7.1</a></li></ul></li><li><a href=#task-8--linux-and-osquery>TASK 8 : Linux and Osquery</a><ul><li><a href=#flags-81>Flags 8.1</a></li><li><a href=#flags-82>Flags 8.2</a></li><li><a href=#flags-83>Flags 8.3</a></li><li><a href=#flags-84>Flags 8.4</a></li><li><a href=#flags-85>Flags 8.5</a></li><li><a href=#flags-86>Flags 8.6</a></li><li><a href=#flags-87>Flags 8.7</a></li><li><a href=#flags-88>Flags 8.8</a></li></ul></li><li><a href=#task-9--windows-and-osquery>TASK 9 : Windows and Osquery</a><ul><li><a href=#flags-91>Flags 9.1</a></li><li><a href=#flags-92>Flags 9.2</a></li><li><a href=#flags-93>Flags 9.3</a></li><li><a href=#flags-94>Flags 9.4</a></li><li><a href=#flags-95>Flags 9.5</a></li><li><a href=#flags-96>Flags 9.6</a></li><li><a href=#flags-97>Flags 9.7</a></li><li><a href=#flags-98>Flags 9.8</a></li></ul></li><li><a href=#task-10->TASK 10 :</a></li></ul></nav></div></details></div><div class=post-content><h2 id=osquery>Osquery<a hidden class=anchor aria-hidden=true href=#osquery>#</a></h2><table><thead><tr><th style=text-align:left>Profile</th><th style=text-align:right>Support</th></tr></thead><tbody><tr><td style=text-align:left><script src=https://tryhackme.com/badge/434937></script></td><td style=text-align:right><a href=https://www.buymeacoffee.com/anir0y><img src="https://img.buymeacoffee.com/button-api/?text=Cheers!!!&emoji=üç∫&slug=anir0y&button_colour=BD5FFF&font_colour=ffffff&font_family=Lato&outline_colour=000000&coffee_colour=FFDD00"></a></td></tr></tbody></table><hr><h2 id=task-1--introduction>TASK 1 : Introduction<a hidden class=anchor aria-hidden=true href=#task-1--introduction>#</a></h2><p><a href=https://osquery.io/>Osquery</a> is an <a href=https://github.com/osquery/osquery>open-source</a> tool created by Facebook. With Osquery, Security Analysts, Incident Responders, Threat Hunters, etc., can query an endpoint (or multiple endpoints) using SQL syntax. Osquery can be installed on multiple platforms: Windows, Linux, macOS, and FreeBSD.</p><p>Many well-known companies, besides Facebook, either use Osquery, utilize osquery within their tools, and/or look for individuals who know Osquery.</p><p>As of today (March 2021), Github and AT&amp;T seek individuals who have experience with Osquery.</p><p>Github:
<img loading=lazy src=https://assets.tryhackme.com/additional/osquery/github-posting.png><br>AT&amp;T:<br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/att-posting.png></p><p>Some of the tools (open-source and commercial) that utilize Osquery are listed below.</p><ul><li>Alienvault: The <a href=https://otx.alienvault.com/endpoint-security/welcome>AlienVault agent</a> is based on Osquery.</li><li>Cisco: Cisco AMP (Advanced Malware Protection) for endpoints utilize Osquery in Cisco Orbital.</li></ul><p>Learning Osquery will be beneficial if you are looking to enter into this field or if you&rsquo;re already in the field and you&rsquo;re looking to level up your skills.</p><hr><h2 id=task-2--installation>TASK 2 : Installation<a hidden class=anchor aria-hidden=true href=#task-2--installation>#</a></h2><p>Install Osquery on your local machine or local virtual machine, please refer to the installation instructions.</p><ul><li><a href=https://osquery.readthedocs.io/en/stable/installation/install-windows/>Windows</a></li><li><a href=https://osquery.readthedocs.io/en/stable/installation/install-linux/>Linux</a></li><li><a href=https://osquery.readthedocs.io/en/stable/installation/install-macos/>MacOS</a></li><li><a href=https://osquery.readthedocs.io/en/stable/installation/install-freebsd/>FreeBSD</a></li></ul><p>Refer to the documentation on the Osquery daemon (osqueryd) information and all the <a href=https://osquery.readthedocs.io/en/latest/installation/cli-flags/>command-line flags here</a>.<br>Schema is <a href=https://osquery.io/schema/>here</a></p><hr><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-3526678290068011 data-ad-slot=1939553774></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=task-3--interacting-with-the-osquery-shell>TASK 3 : Interacting with the Osquery Shell<a hidden class=anchor aria-hidden=true href=#task-3--interacting-with-the-osquery-shell>#</a></h2><p>To interact with the Osquery interactive console/shell, open CMD (or PowerShell) and run <code>osqueryi</code>.</p><p>As per the documentation, osqueryi is a modified version of the SQLite shell.</p><p>You&rsquo;ll know that you&rsquo;ve successfully entered into the interactive shell by the new command prompt.
<img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_prompt.png><br>One way to familiarize yourself with the Osquery interactive shell, as with any new tool, is to check its help menu.</p><p>In Osquery, the help command (or meta-command) is <code>.help</code>.<br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_help.png><br>Note: As per the documentation, meta-commands are prefixed with a <code>'.'</code>.</p><p>To list all the available tables that can be queried, use the .<code>tables</code> meta-command.</p><p>For example, if you wish to check what tables are associated with processes, you can use <code>.tables</code> process.<br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_tables.png><br>In the above image, 3 tables are returned that contain the word &lsquo;process.&rsquo;</p><p>Note: Depending on the operating system, different tables will be returned when the .tables meta-command is executed.</p><p>Table names are not enough to know exactly what information is contained in any given table without actually querying it.</p><p>Knowing what columns and types, known as a schema, for each table are also useful.</p><p>You can list a table&rsquo;s schema with the following meta-command: <code>.schema table_name</code>
<img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_schema.png><br>Looking at the above image, <strong>pid</strong> is the <strong>column</strong>, and <strong>BIGINT</strong> is the type.</p><p><strong>Note</strong>: Any user on a system can run and interact with osqueryi, but some tables might return limited results compared to running osqueryi from an elevated shell.</p><p>If you which to check the schema for another operating system, you&rsquo;ll need to use the <code>--enable_foreign</code> command-line flag.</p><p>To read more about command-line flags, refer to this page, <a href=https://osquery.readthedocs.io/en/latest/installation/cli-flags/>https://osquery.readthedocs.io/en/latest/installation/cli-flags/</a>.</p><p>Interacting with the shell to get quick schema information for a table is good but not ideal when you want schema information for multiple tables.</p><p>For that, the schema API online documentation can be used to view a complete list of tables, columns, types, and column descriptions.</p><h3 id=flag-31>Flag 3.1<a hidden class=anchor aria-hidden=true href=#flag-31>#</a></h3><h4 id=what-is-the-osquery-version>What is the Osquery version<a hidden class=anchor aria-hidden=true href=#what-is-the-osquery-version>#</a></h4><p>run <code>.version</code> to get the flag</p><p><img loading=lazy src=https://i.imgur.com/IEJciiE.png></p><h3 id=flag-32>Flag 3.2<a hidden class=anchor aria-hidden=true href=#flag-32>#</a></h3><h4 id=what-is-the-sqlite-version>What is the SQLite version?<a hidden class=anchor aria-hidden=true href=#what-is-the-sqlite-version>#</a></h4><p>run <code>.version</code> to get the flag</p><p><img loading=lazy src=https://i.imgur.com/IEJciiE.png></p><h3 id=flag-33>Flag 3.3<a hidden class=anchor aria-hidden=true href=#flag-33>#</a></h3><h4 id=what-is-the-default-output-mode>What is the default output mode?<a hidden class=anchor aria-hidden=true href=#what-is-the-default-output-mode>#</a></h4><p>run the <code>.show</code> command to get the answer</p><p><img loading=lazy src=https://i.imgur.com/dAlkh6g.png></p><h3 id=flag-34>Flag 3.4<a hidden class=anchor aria-hidden=true href=#flag-34>#</a></h3><h4 id=what-is-the-meta-command-to-set-the-output-to-show-one-value-per-line>What is the meta-command to set the output to show one value per line?<a hidden class=anchor aria-hidden=true href=#what-is-the-meta-command-to-set-the-output-to-show-one-value-per-line>#</a></h4><p>run <code>.help</code> command to find out the <code>.mode</code> args.</p><p><img loading=lazy src=https://i.imgur.com/9aPv10t.png></p><h3 id=flag-35>Flag 3.5<a hidden class=anchor aria-hidden=true href=#flag-35>#</a></h3><h4 id=what-are-the-2-meta-commands-to-exit-osqueryi>What are the 2 meta-commands to exit osqueryi?<a hidden class=anchor aria-hidden=true href=#what-are-the-2-meta-commands-to-exit-osqueryi>#</a></h4><p>not a rocket science, figure it out by yourself.</p><blockquote><p>Hint: Don&rsquo;t <code>quit</code> ;)</p></blockquote><hr><h2 id=task-4--schema-documentation>TASK 4 : Schema Documentation<a hidden class=anchor aria-hidden=true href=#task-4--schema-documentation>#</a></h2><p>Head over to the schema documentation <a href=https://osquery.io/schema/4.7.0/>here</a>.<br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_apischema-1.png></p><p>The above image is a resemblance to what you&rsquo;ll see when you navigate to the page.</p><p><strong>Note</strong>: At the time of this writing, the current version for Osquery is 4.7.0.</p><p>A breakdown of the information listed on the schema API page is explained below.</p><ol><li>A dropdown listing various versions of Osquery. Choose the version of Osquery you wish to see schema tables for.</li><li>The number of tables within the selected version of Osquery. (In the above image, 271 tables exist for Osquery 4.7.0)</li><li>The list of the tables is listed in alphabetical order for the selected version of Osquery.</li><li>The name of the table and a brief description.</li><li>A detailed chart listing the column, type, and column description for each table.</li><li>Information to which operating system the table applies to. (In the above image, the account_policy_data table is available only for macOS)</li></ol><p>You have enough information to confidently navigate this resource to retrieve any information you&rsquo;ll need.</p><h3 id=flag-41>Flag 4.1<a hidden class=anchor aria-hidden=true href=#flag-41>#</a></h3><h4 id=what-table-would-you-query-to-get-the-version-of-osquery-installed-on-the-windows-endpoint>What table would you query to get the version of Osquery installed on the Windows endpoint?<a hidden class=anchor aria-hidden=true href=#what-table-would-you-query-to-get-the-version-of-osquery-installed-on-the-windows-endpoint>#</a></h4><p>search for <code>osquery_*</code> tables and find out which one have <code>vesion</code> column.</p><h3 id=flag-42>Flag 4.2<a hidden class=anchor aria-hidden=true href=#flag-42>#</a></h3><h4 id=how-many-tables-are-there-for-this-version-of-osquery>How many tables are there for this version of Osquery?<a hidden class=anchor aria-hidden=true href=#how-many-tables-are-there-for-this-version-of-osquery>#</a></h4><p>just open the website <a href=https://osquery.io/schema/4.6.0/>here</a> you&rsquo;ll see it in left corner.</p><h3 id=flag-43>Flag 4.3<a hidden class=anchor aria-hidden=true href=#flag-43>#</a></h3><h4 id=how-many-of-the-tables-for-this-version-are-compatible-with-windows>How many of the tables for this version are compatible with Windows?<a hidden class=anchor aria-hidden=true href=#how-many-of-the-tables-for-this-version-are-compatible-with-windows>#</a></h4><p>just open the website <a href=https://osquery.io/schema/4.6.0/>here</a> filter for windows.
<img loading=lazy src=https://i.imgur.com/a9NrNKv.png></p><h3 id=flag-44>Flag 4.4<a hidden class=anchor aria-hidden=true href=#flag-44>#</a></h3><h4 id=how-many-tables-is-compatible-with-linux>How many tables is compatible with Linux?<a hidden class=anchor aria-hidden=true href=#how-many-tables-is-compatible-with-linux>#</a></h4><p>just open the website <a href=https://osquery.io/schema/4.6.0/>here</a> filter for Linux.
<img loading=lazy src=https://i.imgur.com/AJtMIKt.png></p><h3 id=flag-45>Flag 4.5<a hidden class=anchor aria-hidden=true href=#flag-45>#</a></h3><h4 id=what-is-the-first-table-listed-that-is-compatible-with-both-linux-and-windows>What is the first table listed that is compatible with both Linux and Windows?<a hidden class=anchor aria-hidden=true href=#what-is-the-first-table-listed-that-is-compatible-with-both-linux-and-windows>#</a></h4><p>just open the website <a href=https://osquery.io/schema/4.6.0/>here</a> filter for windows & Linux type the first table name.
<img loading=lazy src=https://i.imgur.com/AJtMIKt.png></p><hr><h2 id=task-5--creating-queries>TASK 5 : Creating queries<a hidden class=anchor aria-hidden=true href=#task-5--creating-queries>#</a></h2><p>The SQL language implemented in Osquery is not an entire SQL language that you might be accustomed to, but rather it&rsquo;s a superset of SQLite&rsquo;s.</p><p>Realistically all your queries will start with a SELECT statement. This makes sense because, with Osquery, you are only querying information on an endpoint or endpoints. You won&rsquo;t be updating or deleting any information/data on the endpoint.</p><p>The exception to the rule: The use of other SQL statements, such as UPDATE and DELETE, is possible, but only if you&rsquo;re creating run-time tables (views) or using an extension if the extension supports them.</p><p>Your queries will also include a FROM clause and end with a semicolon.</p><p>If you wish to retrieve all the information about the running processes on the endpoint: <code>SELECT * FROM processes;</code><br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_selectall.png></p><p><strong>Note</strong>: The results for you will be different if you run this query in the attached VM or your local machine (if Osquery is installed).</p><p>The number of columns returned might be more than what you need. You can select specific columns rather than retrieving every column in the table.</p><p>Query: <code>SELECT pid, name, path FROM processes;</code><br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_notselectall.png><br>The above query will list the process id, the process&rsquo;s name, and the path for all running processes on the endpoint.</p><p>This will still return a large number of results, depending on how busy the endpoint is.</p><p>The count() function can be used to get exactly how many.</p><p>Query: <code>SELECT count(*) from processes;</code>
<img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_count.png><br>The output can be limited to the first 3 in ascending order by process name, as shown below.
<img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_orderby_limit.png><br>Optionally, you can use a WHERE clause to narrow down the list of results returned based on specified criteria.</p><p>Query: <code>SELECT pid, name, path FROM processes WHERE name='lsass.exe';</code><br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_where.png></p><p>The equal sign is not the only filtering option available in a WHERE clause.</p><p>Below are filtering operators that can be used in a WHERE clause:</p><ul><li><code>= </code>[equal]</li><li><code>&lt;></code> [not equal]</li><li><code>></code>, <code>>=</code> [greater than, greater than or equal to]</li><li><code>&lt;</code>, <code>&lt;=</code>[less than or less than or equal to]</li><li><code>BETWEEN</code> [between a range]</li><li><code>LIKE</code> [pattern wildcard searches]</li><li><code>%</code>[wildcard, multiple characters]</li><li><code>_</code> [wildcard, one character]</li></ul><p>Below is a screenshot from the Osquery <a href=https://osquery.readthedocs.io/en/stable/deployment/file-integrity-monitoring/>documentation</a> showing examples of using wildcards when used in folder structures.<br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_wildcard.png></p><p>Some tables will require a WHERE clause, such as the file table, to return a value. If the required WHERE clause is not included in the query, then you will get an error.
<img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_fileerror.png></p><p>The last concept to cover is JOIN. To join 2 or more tables, each table needs to share a column in common.</p><p>Let&rsquo;s look at 2 tables to demonstrate this further. Below is the schema for the <strong>osquery_info</strong> table and the <strong>processes</strong> table.<br><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_join_example.png><br>The common column in both tables is pid. A query can be constructed to use the JOIN clause to join these 2 tables USING the PID column.</p><p>Query: <code>SELECT pid, name, path FROM osquery_info JOIN processes USING (pid);</code>
<img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_join.png></p><h3 id=flags-51>Flags 5.1<a hidden class=anchor aria-hidden=true href=#flags-51>#</a></h3><h4 id=what-is-the-query-to-show-the-username-field-from-the-users-table-where-the-username-is-3-characters-long-and-ends-with-en-use-single-quotes-in-your-answer>What is the query to show the username field from the users table where the username is 3 characters long and ends with &rsquo;en&rsquo;? (use single quotes in your answer)<a hidden class=anchor aria-hidden=true href=#what-is-the-query-to-show-the-username-field-from-the-users-table-where-the-username-is-3-characters-long-and-ends-with-en-use-single-quotes-in-your-answer>#</a></h4><p>Query: <code>select username from users where username like '%nt';</code><br>Modify the query Smarty Pants!</p><hr><h2 id=task-6--using-kolide-fleet>TASK 6 : Using Kolide Fleet<a hidden class=anchor aria-hidden=true href=#task-6--using-kolide-fleet>#</a></h2><p>In this task, we will look at an open-source Osquery Fleet Manager known as <a href=https://github.com/kolide/fleet>Kolide Fleet</a>.</p><p>With Kolide Fleet, instead of using Osquery locally to query an endpoint, you can query multiple endpoints from the Kolide Fleet UI.</p><p>Note: The open-source repo of Kolide Fleet is no longer supported and was retired on November 4th, 2020. A commercial version, known as Kolide K2, is available. You can view more about it <a href=https://www.kolide.com/launcher>here</a>. There is a more recent repo called <a href=https://github.com/fleetdm/fleet>fleet</a>, a fork of the original Kolide Fleet, and as per the creators of Kolide Fleet, &ldquo;it appears to be the first of many promising forks.&rdquo;</p><p>Feel free to explore Query Packs at your own leisure. You can read more about this <a href=https://osquery.readthedocs.io/en/stable/deployment/configuration/>here</a> and <a href=https://osquery.readthedocs.io/en/stable/deployment/log-aggregation/>here</a>.</p><h3 id=flags-61>Flags 6.1<a hidden class=anchor aria-hidden=true href=#flags-61>#</a></h3><h4 id=what-is-the-osquery-enroll-secret>What is the Osquery Enroll Secret?<a hidden class=anchor aria-hidden=true href=#what-is-the-osquery-enroll-secret>#</a></h4><p>When you click on add host you can copy the secret from there<br><img loading=lazy src=https://i.imgur.com/N8w9xqd.png></p><h3 id=flags-62>Flags 6.2<a hidden class=anchor aria-hidden=true href=#flags-62>#</a></h3><h4 id=what-is-the-osquery-version-1>What is the Osquery version?<a hidden class=anchor aria-hidden=true href=#what-is-the-osquery-version-1>#</a></h4><p>read it on added host, it&rsquo;s in details<br><img loading=lazy src=https://i.imgur.com/PwnlQ4h.png></p><h3 id=flags-63>Flags 6.3<a hidden class=anchor aria-hidden=true href=#flags-63>#</a></h3><h4 id=what-is-the-path-for-the-running-osquerydexe-process>What is the path for the running osqueryd.exe process?<a hidden class=anchor aria-hidden=true href=#what-is-the-path-for-the-running-osquerydexe-process>#</a></h4><p>the launcher path.
hint: <code>C:\Users\?????????????\Desktop\????????\???????\osqueryd.exe</code></p><hr><h2 id=task-7--osquery-extensions>TASK 7 : Osquery extensions<a hidden class=anchor aria-hidden=true href=#task-7--osquery-extensions>#</a></h2><p>Extensions add functionality/features (i.e., additional tables) that are not included in the core Osquery. Anyone can create extensions for Osquery. The official documentation on this subject is <a href=https://osquery.readthedocs.io/en/latest/deployment/extensions/>here</a>.</p><p>If you perform a search, you&rsquo;ll find some interesting ones that can be downloaded and implemented with Osquery with little hassle. Others might require extra steps, such as setting up additional dependencies and compiling the extension before use.</p><p>Below are 2 repos of Osquery extensions that you can play with.</p><ul><li><a href=https://github.com/trailofbits/osquery-extensions>https://github.com/trailofbits/osquery-extensions</a></li><li><a href=https://github.com/polylogyx/osq-ext-bin>https://github.com/polylogyx/osq-ext-bin</a></li></ul><h3 id=flags-71>Flags 7.1<a hidden class=anchor aria-hidden=true href=#flags-71>#</a></h3><h4 id=according-to-the-polylogyx-readme-how-many-features-does-the-plug-in-add-to-the-osquery-core>According to the polylogyx readme, how many &lsquo;features&rsquo; does the plug-in add to the Osquery core?<a hidden class=anchor aria-hidden=true href=#according-to-the-polylogyx-readme-how-many-features-does-the-plug-in-add-to-the-osquery-core>#</a></h4><p>answer is in readme page: <a href=https://github.com/polylogyx/osq-ext-bin/blob/master/README.md>https://github.com/polylogyx/osq-ext-bin/blob/master/README.md</a></p><hr><h2 id=task-8--linux-and-osquery>TASK 8 : Linux and Osquery<a hidden class=anchor aria-hidden=true href=#task-8--linux-and-osquery>#</a></h2><p>Review the On-Demand YARA scanning <a href=https://osquery.readthedocs.io/en/stable/deployment/yara/>here</a> to answer some of the questions below.</p><h3 id=flags-81>Flags 8.1<a hidden class=anchor aria-hidden=true href=#flags-81>#</a></h3><h4 id=what-is-the-current_value-for-kernelosrelease>What is the &lsquo;current_value&rsquo; for kernel.osrelease?<a hidden class=anchor aria-hidden=true href=#what-is-the-current_value-for-kernelosrelease>#</a></h4><p><code>osquery> SELECT * FROM kernel_info;</code></p><h3 id=flags-82>Flags 8.2<a hidden class=anchor aria-hidden=true href=#flags-82>#</a></h3><h4 id=what-is-the-uid-for-the-bravo-user>What is the uid for the bravo user?<a hidden class=anchor aria-hidden=true href=#what-is-the-uid-for-the-bravo-user>#</a></h4><p>Query: <code>osquery> SELECT username,uid from users where username= "bravo" ;</code></p><h3 id=flags-83>Flags 8.3<a hidden class=anchor aria-hidden=true href=#flags-83>#</a></h3><h4 id=one-of-the-users-performed-a-binary-padding-attack-what-was-the-target-file-in-the-attack>One of the users performed a &lsquo;Binary Padding&rsquo; attack. What was the target file in the attack?<a hidden class=anchor aria-hidden=true href=#one-of-the-users-performed-a-binary-padding-attack-what-was-the-target-file-in-the-attack>#</a></h4><p>I gave up on real way of finding answer, I guess my way isn&rsquo;t intended. correct me if I&rsquo;m wrong <a href=mailto:classroom@anir0y.in>here</a>.<br>I found the ans by running this: <code>select * from shell_history;</code> and looking into file names.</p><h3 id=flags-84>Flags 8.4<a hidden class=anchor aria-hidden=true href=#flags-84>#</a></h3><h4 id=what-is-the-hash-value-for-this-file>What is the hash value for this file?<a hidden class=anchor aria-hidden=true href=#what-is-the-hash-value-for-this-file>#</a></h4><p>Exit from OSQuery, find the file name, run md5sum
<img loading=lazy src=https://i.imgur.com/0ZSrZxW.png></p><h3 id=flags-85>Flags 8.5<a hidden class=anchor aria-hidden=true href=#flags-85>#</a></h3><h4 id=check-all-file-hashes-in-the-home-directory-for-each-user-one-file-will-not-show-any-hashes-which-file-is-that>Check all file hashes in the home directory for each user. One file will not show any hashes. Which file is that?<a hidden class=anchor aria-hidden=true href=#check-all-file-hashes-in-the-home-directory-for-each-user-one-file-will-not-show-any-hashes-which-file-is-that>#</a></h4><p>it;s the zip. I just bruteforeced it.<br>I guess my way isn&rsquo;t intended. correct me <a href=mailto:classroom@anir0y.in>here</a>.</p><p><img loading=lazy src=https://i.imgur.com/6dlQi2d.png></p><h4 id=solution-provided-by-georg>solution provided by <strong>Georg</strong><a hidden class=anchor aria-hidden=true href=#solution-provided-by-georg>#</a></h4><p><code>osquery> select path,filename,md5 from file join hash using (path) where path like "/home/%%/%" ;</code></p><h3 id=flags-86>Flags 8.6<a hidden class=anchor aria-hidden=true href=#flags-86>#</a></h3><h4 id=there-is-a-file-that-is-categorized-as-malicious-in-one-of-the-home-directories-query-the-yara-table-to-find-this-file-use-the-sigfile-which-is-saved-in-varosqueryyarascanneryara-which-file-is-it>There is a file that is categorized as malicious in one of the home directories. Query the Yara table to find this file. Use the sigfile which is saved in &lsquo;/var/osquery/yara/scanner.yara&rsquo;. Which file is it?<a hidden class=anchor aria-hidden=true href=#there-is-a-file-that-is-categorized-as-malicious-in-one-of-the-home-directories-query-the-yara-table-to-find-this-file-use-the-sigfile-which-is-saved-in-varosqueryyarascanneryara-which-file-is-it>#</a></h4><p>being a lame person I ran yara directly.
query: <code>yara /var/osquery/yara/scanner.yara /home/charlie/</code></p><p><img loading=lazy src=https://i.imgur.com/TJI9YbY.png></p><p>query: <code>osquery> SELECT * FROM yara WHERE path="/path/filename" and sigfile="/var/osquery/yara/scanner.yara";</code>
<img loading=lazy src=https://i.imgur.com/rvVBDwa.png></p><h3 id=flags-87>Flags 8.7<a hidden class=anchor aria-hidden=true href=#flags-87>#</a></h3><h4 id=what-were-the-matches>What were the &lsquo;matches&rsquo;?<a hidden class=anchor aria-hidden=true href=#what-were-the-matches>#</a></h4><p>ans is on same query run
<img loading=lazy src=https://i.imgur.com/TJI9YbY.png></p><h3 id=flags-88>Flags 8.8<a hidden class=anchor aria-hidden=true href=#flags-88>#</a></h3><h4 id=scan-the-file-from-q3-with-the-same-yara-file-what-is-the-entry-for-strings>Scan the file from Q#3 with the same Yara file. What is the entry for &lsquo;strings&rsquo;?<a hidden class=anchor aria-hidden=true href=#scan-the-file-from-q3-with-the-same-yara-file-what-is-the-entry-for-strings>#</a></h4><p>run the same command by changing the file name get the strings.</p><p><strong>Query</strong>: <code>osquery> SELECT * FROM yara WHERE path="/home/tryhackme/filename" and sigfile="/var/osquery/yara/scanner.yara";</code></p><p><img loading=lazy src=https://i.imgur.com/G6Yy6Ks.png></p><hr><h2 id=task-9--windows-and-osquery>TASK 9 : Windows and Osquery<a hidden class=anchor aria-hidden=true href=#task-9--windows-and-osquery>#</a></h2><p>For this exercise, use either Kolide Fleet or the Windows CMD/PowerShell.</p><p>Note: For the questions which involve the Polylogyx osq-ext-bin extension, you&rsquo;ll need to interact with Osquery via the command line.</p><p>To load the extension: <code>osqueryi --allow-unsafe --extension "C:\Program Files\osquery\extensions\osq-ext-bin\plgx_win_extension.ext.exe"</code></p><p>Wait for the command prompt to reflect the phrase <code>Done StartDriver</code>. This will indicate that the extension is fully loaded into the session.</p><p>Tip: If the phrase doesn&rsquo;t appear after a minute or so, hit the ENTER key. It should appear right after.</p><p>Resources for Polylogx osq-ext-bin:</p><ul><li><a href=https://github.com/polylogyx/osq-ext-bin/blob/master/README.md>https://github.com/polylogyx/osq-ext-bin/blob/master/README.md</a></li><li><a href=https://github.com/polylogyx/osq-ext-bin/tree/master/tables-schema>https://github.com/polylogyx/osq-ext-bin/tree/master/tables-schema</a></li></ul><h3 id=flags-91>Flags 9.1<a hidden class=anchor aria-hidden=true href=#flags-91>#</a></h3><h4 id=what-is-the-description-for-the-windows-defender-service>What is the description for the Windows Defender Service?<a hidden class=anchor aria-hidden=true href=#what-is-the-description-for-the-windows-defender-service>#</a></h4><p>Query: <code>select name,description from services where name like "WinD%";</code><br><img loading=lazy src=https://i.imgur.com/kYRGFD3.png></p><h3 id=flags-92>Flags 9.2<a hidden class=anchor aria-hidden=true href=#flags-92>#</a></h3><h4 id=there-is-another-security-agent-on-the-windows-endpoint-what-is-the-name-of-this-agent>There is another security agent on the Windows endpoint. What is the name of this agent?<a hidden class=anchor aria-hidden=true href=#there-is-another-security-agent-on-the-windows-endpoint-what-is-the-name-of-this-agent>#</a></h4><p><strong>Query:</strong>: <code>select name,publisher from programs;</code><br><img loading=lazy src=https://i.imgur.com/VBAQZ9C.png></p><h3 id=flags-93>Flags 9.3<a hidden class=anchor aria-hidden=true href=#flags-93>#</a></h3><h4 id=what-is-required-with-win_event_log_data>What is required with win_event_log_data?<a hidden class=anchor aria-hidden=true href=#what-is-required-with-win_event_log_data>#</a></h4><p>Well the &lsquo;Origin&rsquo; from where you get the data (hint: S****E )</p><h3 id=flags-94>Flags 9.4<a hidden class=anchor aria-hidden=true href=#flags-94>#</a></h3><h4 id=how-many-sources-are-returned-for-win_event_log_channels>How many sources are returned for win_event_log_channels?<a hidden class=anchor aria-hidden=true href=#how-many-sources-are-returned-for-win_event_log_channels>#</a></h4><p><strong>Query:</strong>: <code>osquery> select count (*) from win_event_log_channels;</code><br><img loading=lazy src=https://i.imgur.com/nP2cI5j.png></p><h3 id=flags-95>Flags 9.5<a hidden class=anchor aria-hidden=true href=#flags-95>#</a></h3><h4 id=what-is-the-schema-for-win_event_log_data>What is the schema for win_event_log_data?<a hidden class=anchor aria-hidden=true href=#what-is-the-schema-for-win_event_log_data>#</a></h4><p><strong>Query:</strong>: <code>osquery> .schema win_event_log_data</code><br><img loading=lazy src=https://i.imgur.com/3b25Pxn.png></p><h3 id=flags-96>Flags 9.6<a hidden class=anchor aria-hidden=true href=#flags-96>#</a></h3><h4 id=previous-file-scanned-on-the-linux-endpoint-with-yara-is-on-the-windows-endpoint--what-datetime-was-this-file-first-detected-answer-format-yyyy-mm-dd-hhmmss>previous file scanned on the Linux endpoint with Yara is on the Windows endpoint. What date/time was this file first detected? (Answer format: YYYY-MM-DD HH:MM:SS)<a hidden class=anchor aria-hidden=true href=#previous-file-scanned-on-the-linux-endpoint-with-yara-is-on-the-windows-endpoint--what-datetime-was-this-file-first-detected-answer-format-yyyy-mm-dd-hhmmss>#</a></h4><p>Query: <code>osquery> select eventid,datetime from win_event_log_data where source = "Microsoft-Windows-Windows Defender/Operational" and eventid like '1116' ;</code><br><img loading=lazy src=https://i.imgur.com/oz9YRJ8.png></p><h3 id=flags-97>Flags 9.7<a hidden class=anchor aria-hidden=true href=#flags-97>#</a></h3><h4 id=what-is-the-query-to-find-the-first-sysmon-event-select-only-the-event-id-order-by-datetime-and-limit-the-output-to-only-1-entry>What is the query to find the first Sysmon event? Select only the event id, order by date/time, and limit the output to only 1 entry.<a hidden class=anchor aria-hidden=true href=#what-is-the-query-to-find-the-first-sysmon-event-select-only-the-event-id-order-by-datetime-and-limit-the-output-to-only-1-entry>#</a></h4><p>Query 1: find the sysmon Source
<code>select * from win_event_log_channels where source like '%sysmon%';</code></p><p>Query 2: <code>select eventid from win_event_log_data where source="Microsoft-Windows-Sysmon/Operational" order by datetime limit 1;</code></p><p><img loading=lazy src=https://i.imgur.com/hmBZb7L.png></p><h3 id=flags-98>Flags 9.8<a hidden class=anchor aria-hidden=true href=#flags-98>#</a></h3><h4 id=what-is-the-sysmon-event-id>What is the Sysmon event id?<a hidden class=anchor aria-hidden=true href=#what-is-the-sysmon-event-id>#</a></h4><p><img loading=lazy src=https://i.imgur.com/hmBZb7L.png></p><hr><h2 id=task-10->TASK 10 :<a hidden class=anchor aria-hidden=true href=#task-10->#</a></h2><p>This was a high-level overview of Osquery. This room&rsquo;s goal was to introduce you to this alternate method of interacting with endpoints to extract information. There is more to Osquery than what was covered in this room.</p><ul><li>File Integrity Monitoring: <a href=https://osquery.readthedocs.io/en/latest/deployment/file-integrity-monitoring/>https://osquery.readthedocs.io/en/latest/deployment/file-integrity-monitoring/</a></li><li>Process Auditing: <a href=https://osquery.readthedocs.io/en/latest/deployment/process-auditing/>https://osquery.readthedocs.io/en/latest/deployment/process-auditing/</a></li><li>Syslog Consumption: <a href=https://osquery.readthedocs.io/en/latest/deployment/syslog/>https://osquery.readthedocs.io/en/latest/deployment/syslog/</a></li></ul><p>SIEMs like ELK and Splunk can ingest Osquery logs. If you completed some of the Splunk rooms, specifically Splunk 2 and Splunk 3, you should recall that Osquery logs (osquery:info, osquery:results, and osquery:warning) were part of the various queried sources to extract information. If looking at the log data seemed foreign, now you have a better understanding of the displayed in the results.</p><p>Lastly, look at other community projects for Osquery listed at <a href=https://osquery.io/>https://osquery.io/</a>.</p><p><img loading=lazy src=https://assets.tryhackme.com/additional/osquery/osquery_comm_projs.png></p><p>The repo on enterprise threat hunting with <a href=https://github.com/teoseller/osquery-attck>Osquery + MITRE ATT&amp;CK</a> is definitely worth your attention.</p><hr><script type=text/javascript language=javascript>var aax_size="728x90",aax_pubname="anir0y-21",aax_src="302"</script><script type=text/javascript language=javascript src=https://c.amazon-adsystem.com/aax2/assoc.js></script></div><footer class=post-footer><ul class=post-tags><li><a href=https://classroom.anir0y.in/tags/notes/>Notes</a></li><li><a href=https://classroom.anir0y.in/tags/tryhackme/>Tryhackme</a></li><li><a href=https://classroom.anir0y.in/tags/rooms/>Rooms</a></li></ul><nav class=paginav><a class=prev href=https://classroom.anir0y.in/post/thm-room-attacktivedirectory/><span class=title>¬´ Prev</span><br><span>Try Hack Me Room Attacktivedirectory</span>
</a><a class=next href=https://classroom.anir0y.in/post/thm-room-openvas/><span class=title>Next ¬ª</span><br><span>Try Hack Me Room Room Openvas</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me Room Osquery on x" href="https://x.com/intent/tweet/?text=Try%20Hack%20Me%20Room%20Osquery&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-osquery%2f&amp;hashtags=notes%2ctryhackme%2crooms"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me Room Osquery on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-osquery%2f&amp;title=Try%20Hack%20Me%20Room%20Osquery&amp;summary=Try%20Hack%20Me%20Room%20Osquery&amp;source=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-osquery%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me Room Osquery on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-osquery%2f&title=Try%20Hack%20Me%20Room%20Osquery"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me Room Osquery on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-osquery%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me Room Osquery on whatsapp" href="https://api.whatsapp.com/send?text=Try%20Hack%20Me%20Room%20Osquery%20-%20https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-osquery%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me Room Osquery on telegram" href="https://telegram.me/share/url?text=Try%20Hack%20Me%20Room%20Osquery&amp;url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-osquery%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me Room Osquery on ycombinator" href="https://news.ycombinator.com/submitlink?t=Try%20Hack%20Me%20Room%20Osquery&u=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fthm-room-osquery%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>YOU CAN REUSE MY CONTENT</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>