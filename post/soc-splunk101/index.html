<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>SOC Splunk101 | Classroom</title><link href=/img/avatar.jpeg rel="shortcut icon" type=image/x-icon><meta name=author content="Animesh Roy @anir0y  "><meta name=description content="More than 80 Use Cases for Splunk."><title>Animesh Roy | Classroom Posts</title><meta name=title content="Animesh Roy | Blogs & Writeups"><meta name=description content="Animesh Roy has more than a decade worth experience working in cyber security domain. He has worked with governments, corporates, colleges and universities, defence, and the community. He also running a community “Arishti Live” to help everyone who wants to, or work in cyber security domain. His expertise on training & consulting are the best of both the world. He uses his real-life case studies in trainings, to help candidates to understand the job in better ways."><script async src="https://www.googletagmanager.com/gtag/js?id=G-SPD6BXK0P5"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SPD6BXK0P5")</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","it10lq8bk1")</script><meta property="og:type" content="website"><meta property="og:url" content="https://classroom.anir0y.in/"><meta property="og:title" content="Animesh Roy | Blogs & Writeups"><meta property="og:description" content="This blog contents writeups from CTFs and other infosec related posts also some task related to Classroom training"><meta property="og:image" content="https://i.imgur.com/Ji5C41H.png"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://classroom.anir0y.in/post/soc-splunk101/"><meta property="twitter:title" content="Animesh Roy | Blogs & Writeups"><meta property="twitter:description" content="This blog contents writeups from CTFs and other infosec related posts also some task related to Classroom training"><meta property="twitter:image" content="https://i.imgur.com/Ji5C41H.png"><script data-ad-client=ca-pub-3526678290068011 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script data-ad-client=ca-pub-3526678290068011 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<link rel=canonical href=https://classroom.anir0y.in/post/soc-splunk101/><meta property="og:title" content="SOC Splunk101"><meta property="og:description" content="More than 80 Use Cases for Splunk."><meta property="og:type" content="article"><meta property="og:url" content="https://classroom.anir0y.in/post/soc-splunk101/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-04-10T19:27:17+05:30"><meta property="article:modified_time" content="2023-04-10T19:27:17+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="SOC Splunk101"><meta name=twitter:description content="More than 80 Use Cases for Splunk."><link rel=stylesheet href=/css/semantic.min.css><link rel=stylesheet href=/css/icomoon.css><link rel=stylesheet href=/css/OverlayScrollbars.min.css><link rel=stylesheet href=/css/github-markdown.css><link rel=stylesheet href=/css/site.css><link rel=stylesheet href=/css/custom.css><style>a:not(.ui.button):hover{text-decoration:underline}a:not(.ui.button){color:#2e8b57!important}.inverted a:not(.ui.button),.inverted a:not(.ui.button):hover{color:#8fbc8f!important}body.default{background-color:#fff}body.dark{background-color:#000}</style><link rel=stylesheet data-highlight href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/tomorrow.min.css><link rel=stylesheet href=/css/custom.css></head><body class=default><nav class="ui secondary menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title="Flip it!"></i></div><div class=item><i class="large link home icon" title=Home onclick='window.location.href="https://classroom.anir0y.in"'></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div><div class=item><i class="large link search icon" onclick=toggleSearch()></i></div></nav><div class=flip-container><div class=flipper><section class=front><div class=dream-max-width><div class="ui relaxed grid dream-grid dream-grid-single" style=flex-direction:row-reverse><aside class="sixteen wide mobile sixteen wide tablet four wide computer column dream-single-aside"><div class="ui segment toc"><nav id=TableOfContents><ul><li><a href=#some-use-cases-for-splunk>some Use Cases for Splunk.</a><ul><li><a href=#1--windows-audit-log-tampering>1- Windows Audit Log Tampering</a></li><li><a href=#2--finding-large-web-uploads>2- Finding Large Web Uploads</a></li><li><a href=#3--detecting-recurring-malware-on-host>3- Detecting Recurring Malware on Host</a></li><li><a href=#4-detecting-brute-force-attacks>4-Detecting Brute Force Attacks</a></li><li><a href=#5--detecting-unencrypted-web-communications>5- Detecting Unencrypted Web Communications</a></li><li><a href=#6--identifying-web-users-by-country>6- Identifying Web Users By Country</a></li><li><a href=#7--identifying-slow-web-content>7- Identifying Slow Web Content</a></li><li><a href=#8--finding-new-local-admin-accounts>8- Finding New Local Admin Accounts</a></li><li><a href=#9--finding-interactive-logins-from-service-accounts>9- Finding Interactive Logins From Service Accounts</a></li><li><a href=#10--log-volume-trending>10- Log Volume Trending</a></li><li><a href=#11--basic-tor-traffic-detection>11- Basic TOR Traffic Detection</a></li><li><a href=#12--measuring-storage-io-latency>12- Measuring Storage I/O Latency</a></li><li><a href=#13--measuring-storage-speed-io-utilization-by-host>13- Measuring Storage Speed I/O Utilization by Host</a></li><li><a href=#14--measuring-memory-utilization-by-host>14- Measuring Memory Utilization by Host</a></li><li><a href=#15--rogue-dns-detection>15- Rogue DNS detection</a></li><li><a href=#16--suspicious-powershell-commands>16- Suspicious PowerShell Commands</a></li><li><a href=#17--windows-audit-log-cleared>17- Windows audit log cleared</a></li><li><a href=#18--detecting-network-and-port-scanning>18- Detecting Network and Port Scanning</a></li><li><a href=#19--unusual-access>19- Unusual Access</a></li><li><a href=#20--malware-attack>20- Malware Attack</a></li><li><a href=#21-attempt-to-add-certificate-to-untrusted-store>21-Attempt To Add Certificate To Untrusted Store</a></li><li><a href=#22--batch-file-write-to-system32>22**- Batch File Write to System32**</a></li><li><a href=#23--bcdedit-failure-recovery-modification>23- BCDEdit Failure Recovery Modification</a></li><li><a href=#24--bits-job-persistence>24- BITS Job Persistence</a></li><li><a href=#25--bitsadmin-download-file>25- BITSAdmin Download File</a></li><li><a href=#26--certutil-download-with-urlcache-and-split-arguments>26- CertUtil Download With URLCache and Split Arguments</a></li><li><a href=#27--certutil-download-with-verifyctl-and-split-arguments>27- CertUtil Download With VerifyCtl and Split Arguments</a></li><li><a href=#28--certutil-exe-certificate-extraction>28- Certutil exe certificate extraction</a></li><li><a href=#29--certutil-with-decode-argument>29- CertUtil With Decode Argument</a></li><li><a href=#30--create-local-admin-accounts-using-net-exe>30- Create local admin accounts using net exe</a></li><li><a href=#31--create-remote-thread-into-lsass>31- Create Remote Thread into LSASS</a></li><li><a href=#32--create-service-in-suspicious-file-path>32- Create Service In Suspicious File Path</a></li><li><a href=#33--common-windows-process-masquerading>33- Common Windows Process Masquerading</a></li><li><a href=#34--unusual-child-process-spawned-using-dde-exploit>34- Unusual Child Process spawned using DDE exploit</a></li><li><a href=#35--detecting-tampering-of-windows-defender-command-prompt>35- Detecting Tampering of Windows Defender Command Prompt</a></li><li><a href=#36--disable-uac>36- Disable UAC</a></li><li><a href=#37--identifying-port-scanning-activity>37- Identifying Port Scanning Activity</a></li><li><a href=#38--unusually-long-command-line-strings>38- Unusually Long Command Line Strings</a></li><li><a href=#39--clearing-windows-logs-with-wevtutil>39- Clearing Windows Logs with Wevtutil</a></li><li><a href=#40--unusual-child-process-for-spoolsvexe-or-connhostexe>40- Unusual Child Process for Spoolsv.Exe or Connhost.Exe</a></li><li><a href=#41--detecting-shadow-copy-deletion-via-vssadminexe>41- Detecting Shadow Copy Deletion via Vssadmin.exe</a></li><li><a href=#42--webshell-indicative-process-tree>42- Webshell-Indicative Process Tree</a></li><li><a href=#43--get-system-elevation>43- Get System Elevation</a></li><li><a href=#44--boot-or-logon-initialization-scripts>44- Boot or Logon Initialization Scripts</a></li><li><a href=#45--local-network-sniffing>45- Local Network Sniffing</a></li><li><a href=#46--dll-injection-with-mavinject>46- DLL Injection with Mavinject</a></li><li><a href=#47--processes-started-from-irregular-parent>47- Processes Started From Irregular Parent</a></li><li><a href=#48--clear-powershell-console-command-history>48- Clear Powershell Console Command History</a></li><li><a href=#49--local-permission-group-discovery>49- Local Permission Group Discovery</a></li><li><a href=#50--network-share-connection-removal>50- Network Share Connection Removal</a></li><li><a href=#51--msbuild-and-msxsl>51- MSBuild and msxsl</a></li><li><a href=#52--compiled-html-access>52- Compiled HTML Access</a></li><li><a href=#53--cmstp>53- CMSTP</a></li><li><a href=#54--registry-edit-from-screensaver>54- Registry Edit from Screensaver</a></li><li><a href=#55--scheduled-task---file-access>55- Scheduled Task - File Access</a></li><li><a href=#56--component-object-model-hijacking>56- Component Object Model Hijacking</a></li><li><a href=#57--indicator-blocking---driver-unloaded>57- Indicator Blocking - Driver Unloaded</a></li><li><a href=#58--credentials-in-files--registry>58- Credentials in Files & Registry</a></li><li><a href=#59--appinit-dlls>59- AppInit DLLs</a></li><li><a href=#60--ntfs-alternate-data-stream-execution---system-utilities>60- NTFS Alternate Data Stream Execution - System Utilities</a></li><li><a href=#61--ntfs-alternate-data-stream-execution---lolbas>61- NTFS Alternate Data Stream Execution - LOLBAS</a></li><li><a href=#62--execution-with-at>62- Execution with AT</a></li><li><a href=#63--running-executables-with-same-hash-and-different-names>63- Running executables with same hash and different names</a></li><li><a href=#64--suspicious-arguments>64- Suspicious Arguments</a></li><li><a href=#65--user-login-activity-monitoring>65- User Login Activity Monitoring</a></li><li><a href=#66--powershell-execution>66- PowerShell Execution</a></li><li><a href=#67--services-launching-cmd>67- Services launching Cmd</a></li><li><a href=#68--command-launched-from-winlogon>68- Command Launched from WinLogon</a></li><li><a href=#69--host-discovery-commands>69- Host Discovery Commands</a></li><li><a href=#70--create-remote-process-via-wmic>70- Create Remote Process via WMIC</a></li><li><a href=#71--uac-bypass>71- UAC Bypass</a></li><li><a href=#72--generic-regsvr32>72- Generic Regsvr32</a></li><li><a href=#73--squiblydoo>73- Squiblydoo</a></li><li><a href=#74--credential-dumping-via-mimikatz>74- Credential Dumping via Mimikatz</a></li><li><a href=#75--access-permission-modification>75- Access Permission Modification</a></li><li><a href=#76--lsass-process-dump-via-procdump>76- Lsass Process Dump via Procdump</a></li><li><a href=#77--credential-dumping-via-windows-task-manager>77- Credential Dumping via Windows Task Manager</a></li><li><a href=#78--active-directory-dumping-via-ntdsutil>78- Active Directory Dumping via NTDSUtil</a></li><li><a href=#79--shadow-copy-deletion>79- Shadow Copy Deletion</a></li><li><a href=#80--minidump-of-lsass>80- MiniDump of LSASS</a></li><li><a href=#81--rare-lolbas-command-lines>81- Rare LolBAS Command Lines</a></li></ul></li></ul></nav></div><div class="ui segment actions"><button class="ui circular icon button save-as-image" title="Save as image" onclick=savePostAsImg()>
<i class="save icon"></i></button>
<a href="https://twitter.com/intent/tweet?text=SOC%20Splunk101&url=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f" class="ui circular twitter icon button"><i class="twitter icon"></i></a>
<a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fclassroom.anir0y.in%2fpost%2fsoc-splunk101%2f" class="ui circular facebook icon button"><i class="facebook icon"></i></a></div></aside><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column markdown-body dream-single" id=dream-save-post-as-img><section class="ui top attached segment"><header><h1 class="ui large header">SOC Splunk101<div class="sub header">@
<a href=https://bit.ly/34sGFiK target=_blank>Animesh Roy</a>
|
Monday, Apr 10, 2023
| 34 minutes read
| Update at
Monday, Apr 10, 2023</div></h1></header><article class=main><h2 id=some-use-cases-for-splunk>some Use Cases for Splunk.</h2><h3 id=1--windows-audit-log-tampering>1- Windows Audit Log Tampering</h3><p>Check for any tampering done to Windows audit logs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ (sourcetype<span style=color:#f92672>=</span>wineventlog <span style=color:#66d9ef>AND</span> (EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1102</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1100</span>)) <span style=color:#66d9ef>OR</span> (sourcetype<span style=color:#f92672>=</span>wineventlog <span style=color:#66d9ef>AND</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>104</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>by</span> _time EventCode Message sourcetype <span style=color:#66d9ef>host</span>
</span></span></code></pre></div><h3 id=2--finding-large-web-uploads>2- Finding Large Web Uploads</h3><p>Find large file uploads that could point to data exfiltration in your network.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ sourcetype<span style=color:#f92672>=</span>websense<span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> bytes_out <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>35000000</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> _time src_ip bytes<span style=color:#f92672>*</span> uri
</span></span></code></pre></div><h3 id=3--detecting-recurring-malware-on-host>3- Detecting Recurring Malware on Host</h3><p>Using anti-virus logs to detect if malware is recurring on a host after being removed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ sourcetype<span style=color:#f92672>=</span>symantec:<span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>count</span> range(_time) <span style=color:#66d9ef>as</span> TimeRange <span style=color:#66d9ef>by</span> Risk_Name, Computer_Name
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> TimeRange<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1800</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> eval TimeRange_In_Hours <span style=color:#f92672>=</span> round(TimeRange<span style=color:#f92672>/</span><span style=color:#ae81ff>3600</span>,<span style=color:#ae81ff>2</span>), TimeRange_In_Days <span style=color:#f92672>=</span> round(TimeRange<span style=color:#f92672>/</span><span style=color:#ae81ff>3600</span><span style=color:#f92672>/</span><span style=color:#ae81ff>24</span>,<span style=color:#ae81ff>2</span>)
</span></span></code></pre></div><h3 id=4-detecting-brute-force-attacks>4-Detecting Brute Force Attacks</h3><p>A brute-force attack consists of a multiple login attempts using many passwords by an unauthorized user/attacker with the hope of eventually guessing the correct password.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ sourcetype<span style=color:#f92672>=</span>winxsecurity <span style=color:#66d9ef>user</span><span style=color:#f92672>=*</span> <span style=color:#66d9ef>user</span><span style=color:#f92672>!</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>count</span>(eval(action<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;success&#34;</span>)) <span style=color:#66d9ef>as</span> successes <span style=color:#66d9ef>count</span>(eval(action<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;failure&#34;</span>)) <span style=color:#66d9ef>as</span> failures <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>user</span>, ComputerName
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> successes<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>AND</span> failures<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p><strong>Windows</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>windows <span style=color:#66d9ef>source</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;WinEventLog:Security&#34;</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4625</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> bin _time span<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>by</span> _time,<span style=color:#66d9ef>user</span>,<span style=color:#66d9ef>host</span>,src,action
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>count</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p><strong>Linux</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>linux <span style=color:#66d9ef>source</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/auth.log&#34;</span> <span style=color:#e6db74>&#34;Failed password&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> bin _time span<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>by</span> _time,<span style=color:#66d9ef>user</span>,<span style=color:#66d9ef>host</span>,src,action
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>count</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><h3 id=5--detecting-unencrypted-web-communications>5- Detecting Unencrypted Web Communications</h3><p>Find unencrypted web communications that could lead to a data breach.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ sourcetype<span style=color:#f92672>=</span>firewall_data dest_port<span style=color:#f92672>!=</span><span style=color:#ae81ff>443</span> app<span style=color:#f92672>=</span>workday<span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> _time <span style=color:#66d9ef>user</span> app bytes<span style=color:#f92672>*</span> src_ip dest_ip dest_port
</span></span></code></pre></div><h3 id=6--identifying-web-users-by-country>6- Identifying Web Users By Country</h3><p>Use IPs in your data to report and visualize user locations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>web sourcetype<span style=color:#f92672>=</span>access_combined
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> iplocation clientip
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> geostats dc(clientip) <span style=color:#66d9ef>by</span> Country
</span></span></code></pre></div><h3 id=7--identifying-slow-web-content>7- Identifying Slow Web Content</h3><p>A slow loading web site can not only frustrate users, but can also hurt search rankings.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>web sourcetype<span style=color:#f92672>=</span>ms:iis:auto <span style=color:#66d9ef>OR</span> sourcetype<span style=color:#f92672>=</span>apache: <span style=color:#66d9ef>access</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>avg</span>(response_time) <span style=color:#66d9ef>as</span> art <span style=color:#66d9ef>by</span> uri_path
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> eval <span style=color:#e6db74>&#34;Average Response Time&#34;</span> <span style=color:#f92672>=</span> round(art,<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> sort <span style=color:#f92672>-</span><span style=color:#e6db74>&#34;Average Response Time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> uri_path, <span style=color:#e6db74>&#34;Average Response Time&#34;</span>
</span></span></code></pre></div><h3 id=8--finding-new-local-admin-accounts>8- Finding New Local Admin Accounts</h3><p>Often an attack will include the creation of a new user, followed by permissions being elevated to an admin level.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>win_servers sourcetype<span style=color:#f92672>=</span>windows:<span style=color:#66d9ef>security</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4720</span> <span style=color:#66d9ef>OR</span> (EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4732</span> Administrators)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>transaction</span> Security_ID maxspan<span style=color:#f92672>=</span><span style=color:#ae81ff>180</span>m
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>search</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4720</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4732</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> _time, EventCode, Recurity_ID, SamAccountName
</span></span></code></pre></div><h3 id=9--finding-interactive-logins-from-service-accounts>9- Finding Interactive Logins From Service Accounts</h3><p>Most service accounts should never interactively log into servers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>systems sourcetype<span style=color:#f92672>=</span>audit_logs <span style=color:#66d9ef>user</span><span style=color:#f92672>=</span>svc_<span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats earliest(_time) <span style=color:#66d9ef>as</span> earliest latest(_time) <span style=color:#66d9ef>as</span> latest <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>user</span>, dest
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> eval isOutlier<span style=color:#f92672>=</span><span style=color:#66d9ef>if</span>(earliest <span style=color:#f92672>&gt;=</span> relative_time(now(), <span style=color:#e6db74>&#34;-1d@d&#34;</span>), <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>convert</span> ctime(earliest) ctime(Latest)
</span></span></code></pre></div><h3 id=10--log-volume-trending>10- Log Volume Trending</h3><p>Visualizing the number of events being logged by an application can provide a simple, yet powerful indicator of the state of your application, or changes in the behavior of your code or environment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span>tstats prestats<span style=color:#f92672>=</span>t <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>apps <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>host</span> _time span<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>m
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>timechart <span style=color:#66d9ef>partial</span><span style=color:#f92672>=</span>f span<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>m <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>host</span> <span style=color:#66d9ef>limit</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=11--basic-tor-traffic-detection>11- Basic TOR Traffic Detection</h3><p>Use firewall data to find TOR traffic on your network.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>network sourcetype<span style=color:#f92672>=</span>firewall_data app<span style=color:#f92672>=</span>tor src_ip<span style=color:#f92672>=*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> _time src_ip src_port dest_ip dest_port bytes app
</span></span></code></pre></div><h3 id=12--measuring-storage-io-latency>12- Measuring Storage I/O Latency</h3><p>Quickly find I/O bottlenecks across your systems.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>main sourcetype<span style=color:#f92672>=</span>iostat
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> timechart <span style=color:#66d9ef>avg</span>(latency) <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>host</span>
</span></span></code></pre></div><h3 id=13--measuring-storage-speed-io-utilization-by-host>13- Measuring Storage Speed I/O Utilization by Host</h3><p>It simple to track disk I/O, helping you quickly discover storage issues on your servers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>main sourcetype<span style=color:#f92672>=</span>iostat
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> eval hostdevice<span style=color:#f92672>=</span><span style=color:#66d9ef>host</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;:&#34;</span><span style=color:#f92672>+</span>Device
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> timechart <span style=color:#66d9ef>avg</span>(total_ops) <span style=color:#66d9ef>by</span> hostdevice
</span></span></code></pre></div><h3 id=14--measuring-memory-utilization-by-host>14- Measuring Memory Utilization by Host</h3><p>It&rsquo;s easy to track memory utilization of your systems using Splunk Enterprise.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>main sourcetype<span style=color:#f92672>=</span>vmstat
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>max</span>(memUsedPct) <span style=color:#66d9ef>as</span> memused <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>host</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> memused<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>80</span>
</span></span></code></pre></div><h3 id=15--rogue-dns-detection>15- Rogue DNS detection</h3><p>Look for DNS requests that are not destined for the dedicated DNS server.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span><span style=color:#66d9ef>security</span> sourcetype<span style=color:#f92672>=</span>cp_log src_ip<span style=color:#f92672>!=</span><span style=color:#ae81ff>192</span>.<span style=color:#ae81ff>168</span>.<span style=color:#ae81ff>14</span>.<span style=color:#ae81ff>10</span> dest_ip<span style=color:#f92672>!=</span><span style=color:#ae81ff>192</span>.<span style=color:#ae81ff>168</span>.<span style=color:#ae81ff>14</span>.<span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>protocol<span style=color:#f92672>=</span><span style=color:#ae81ff>53</span> action<span style=color:#f92672>!=</span><span style=color:#66d9ef>Drop</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> dest_ip<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;192.168.0.0/16&#34;</span> <span style=color:#66d9ef>AND</span> src_ip<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;192.168.0.0/16&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>count</span>, <span style=color:#66d9ef>values</span>(dest_ip) <span style=color:#66d9ef>by</span> src_ip
</span></span></code></pre></div><h3 id=16--suspicious-powershell-commands>16- Suspicious PowerShell Commands</h3><p>Look for logs with commands that try to download external scripts/content or bypass PowerShell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>windows <span style=color:#66d9ef>source</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;WinEventLog:Microsoft-Windows-PowerShell/Operational&#34;</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4104</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> ((ScriptBlockText<span style=color:#f92672>=*-</span>noni<span style=color:#f92672>*</span> <span style=color:#f92672>*</span>iex<span style=color:#f92672>*</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>New</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span><span style=color:#f92672>*</span>) <span style=color:#66d9ef>OR</span> (ScriptBlockText<span style=color:#f92672>=*-</span>ep<span style=color:#f92672>*</span> <span style=color:#f92672>*</span>bypass<span style=color:#f92672>*</span> <span style=color:#f92672>*-</span>Enc<span style=color:#f92672>*</span>) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(ScriptBlockText<span style=color:#f92672>=*</span>powershell<span style=color:#f92672>*</span> <span style=color:#f92672>*</span>reg<span style=color:#f92672>*</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>add</span><span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>*</span>HKCU<span style=color:#960050;background-color:#1e0010>\\</span>software<span style=color:#960050;background-color:#1e0010>\\</span>microsoft<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>currentversion<span style=color:#960050;background-color:#1e0010>\\</span>run<span style=color:#f92672>*</span>) <span style=color:#66d9ef>OR</span> (ScriptBlockText<span style=color:#f92672>=*</span>bypass<span style=color:#f92672>*</span> <span style=color:#f92672>*-</span>
</span></span><span style=display:flex><span>noprofile<span style=color:#f92672>*</span> <span style=color:#f92672>*-</span>windowstyle<span style=color:#f92672>*</span> <span style=color:#f92672>*</span>hidden<span style=color:#f92672>*</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>new</span><span style=color:#f92672>-</span><span style=color:#66d9ef>object</span><span style=color:#f92672>*</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>system</span>.net.webclient<span style=color:#f92672>*</span> <span style=color:#f92672>*</span>.download<span style=color:#f92672>*</span>) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(ScriptBlockText<span style=color:#f92672>=*</span>iex<span style=color:#f92672>*</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>New</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span><span style=color:#f92672>*</span> <span style=color:#f92672>*</span>Net.WebClient<span style=color:#f92672>*</span> <span style=color:#f92672>*</span>.Download<span style=color:#f92672>*</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> Computer, ScriptBlockText, UserID
</span></span></code></pre></div><h3 id=17--windows-audit-log-cleared>17- Windows audit log cleared</h3><p>Look for security logs filtered with EventCode 1102.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>windows <span style=color:#66d9ef>source</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;WinEventLog:Security&#34;</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1102</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> _time, <span style=color:#66d9ef>host</span>, signature, <span style=color:#66d9ef>user</span>
</span></span></code></pre></div><h3 id=18--detecting-network-and-port-scanning>18- Detecting Network and Port Scanning</h3><p>Look for distinct count of destination ports within a short span of time.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>from</span> datamodel:<span style=color:#e6db74>&#34;Network_Traffic&#34;</span>.<span style=color:#e6db74>&#34;All_Traffic&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats dc(dest_port) <span style=color:#66d9ef>as</span> dc_dest_port <span style=color:#66d9ef>by</span> src, dest
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> dc_dest_port <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>OR</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ sourcetype<span style=color:#f92672>=</span>firewall<span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats dc(dest_port) <span style=color:#66d9ef>as</span> num_dest_port dc(dest_ip) <span style=color:#66d9ef>as</span> num_dest_ip <span style=color:#66d9ef>by</span> src_ip
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> num_dest_port <span style=color:#f92672>&gt;</span><span style=color:#ae81ff>500</span> <span style=color:#66d9ef>OR</span> num_dest_ip <span style=color:#f92672>&gt;</span><span style=color:#ae81ff>500</span>
</span></span></code></pre></div><h3 id=19--unusual-access>19- Unusual Access</h3><p>Look for count of multiple failed login attempts where successful login is true.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>from</span> datamodel:<span style=color:#e6db74>&#34;Authentication&#34;</span>.<span style=color:#e6db74>&#34;Authentication&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>like</span>(app,<span style=color:#e6db74>&#34;ssh&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats list(action) <span style=color:#66d9ef>as</span> Attempts, <span style=color:#66d9ef>count</span>(eval(<span style=color:#66d9ef>match</span>(action,<span style=color:#e6db74>&#34;failure&#34;</span>))) <span style=color:#66d9ef>as</span> Failed,
</span></span><span style=display:flex><span><span style=color:#66d9ef>count</span>(eval(<span style=color:#66d9ef>match</span>(action,<span style=color:#e6db74>&#34;success&#34;</span>))) <span style=color:#66d9ef>as</span> Success <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>user</span>,src,dest,app
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> mvcount(Attempts)<span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>6</span> <span style=color:#66d9ef>AND</span> Success<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>AND</span> Failed<span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>5</span>
</span></span></code></pre></div><h3 id=20--malware-attack>20- Malware Attack</h3><p>Look for infection count of malware attack.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>from</span> datamodel:<span style=color:#e6db74>&#34;Malware&#34;</span>.<span style=color:#e6db74>&#34;Malware_Attacks&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> stats dc(<span style=color:#e6db74>&#34;signature&#34;</span>) <span style=color:#66d9ef>as</span> <span style=color:#e6db74>&#34;infection_count&#34;</span> <span style=color:#66d9ef>by</span> <span style=color:#e6db74>&#34;dest&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#39;infection_count&#39;</span><span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h3 id=21-attempt-to-add-certificate-to-untrusted-store>21-Attempt To Add Certificate To Untrusted Store</h3><p>Adversaries may add their own root certificate to the certificate store, to cause the web browser to trust that certificate and not display a security warning when it encounters the previously unseen certificate. This action may be the precursor to malicious activity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>values</span>(Processes.process) <span style=color:#66d9ef>as</span> process <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> Processes.process_name<span style=color:#f92672>=*</span>certutil<span style=color:#f92672>*</span> (Processes.process<span style=color:#f92672>=*-</span>addstore<span style=color:#f92672>*</span>) <span style=color:#66d9ef>by</span> Processes.parent_process Processes.process_name Processes.<span style=color:#66d9ef>user</span>
</span></span></code></pre></div><h3 id=22--batch-file-write-to-system32>22**- Batch File Write to System32**</h3><p>While batch files are not inherently malicious, it is uncommon to see them created after OS installation, especially in the Windows directory. This analytic looks for the suspicious activity of a batch file being created within the C:\Windows\System32 directory tree. There will be only occasional false positives due to administrator actions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>values</span>(Filesystem.dest) <span style=color:#66d9ef>as</span> dest <span style=color:#66d9ef>values</span>(Filesystem.file_name) <span style=color:#66d9ef>as</span> file_name <span style=color:#66d9ef>values</span>(Filesystem.<span style=color:#66d9ef>user</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>user</span> <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Filesystem <span style=color:#66d9ef>by</span> Filesystem.file_path   <span style=color:#f92672>|</span> rex field<span style=color:#f92672>=</span>file_name <span style=color:#e6db74>&#34;(?&lt;file_extension&gt;\.[^\.]+)$&#34;</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>search</span> file_path<span style=color:#f92672>=*</span>system32<span style=color:#f92672>*</span> <span style=color:#66d9ef>AND</span> file_extension<span style=color:#f92672>=</span>.bat
</span></span></code></pre></div><h3 id=23--bcdedit-failure-recovery-modification>23- BCDEdit Failure Recovery Modification</h3><p>This search looks for flags passed to bcdedit.exe modifications to the built-in Windows error recovery boot configurations. This is typically used by ransomware to prevent recovery.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> Processes.process_name <span style=color:#f92672>=</span> bcdedit.exe Processes.process<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*recoveryenabled*&#34;</span> (Processes.process<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* no*&#34;</span>) <span style=color:#66d9ef>by</span> Processes.process_name Processes.process Processes.parent_process_name Processes.dest Processes.<span style=color:#66d9ef>user</span>
</span></span></code></pre></div><h3 id=24--bits-job-persistence>24- BITS Job Persistence</h3><p>The following query identifies Microsoft Background Intelligent Transfer Service utility <code>bitsadmin.exe</code> scheduling a BITS job to persist on an endpoint. The query identifies the parameters used to create, resume or add a file to a BITS job. Typically seen combined in a oneliner or ran in sequence. If identified, review the BITS job created and capture any files written to disk. It is possible for BITS to be used to upload files and this may require further network data analysis to identify. You can use <code>bitsadmin /list /verbose</code> to list out the jobs during investigation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> Processes.process_name<span style=color:#f92672>=</span>bitsadmin.exe Processes.process <span style=color:#66d9ef>IN</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>create</span><span style=color:#f92672>*</span>, <span style=color:#f92672>*</span>addfile<span style=color:#f92672>*</span>, <span style=color:#f92672>*</span>setnotifyflags<span style=color:#f92672>*</span>, <span style=color:#f92672>*</span>setnotifycmdline<span style=color:#f92672>*</span>, <span style=color:#f92672>*</span>setminretrydelay<span style=color:#f92672>*</span>, <span style=color:#f92672>*</span>setcustomheaders<span style=color:#f92672>*</span>, <span style=color:#f92672>*</span>resume<span style=color:#f92672>*</span> ) <span style=color:#66d9ef>by</span> Processes.dest Processes.<span style=color:#66d9ef>user</span> Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
</span></span></code></pre></div><h3 id=25--bitsadmin-download-file>25- BITSAdmin Download File</h3><p>The following query identifies Microsoft Background Intelligent Transfer Service utility <code>bitsadmin.exe</code> using the <code>transfer</code> parameter to download a remote object. In addition, look for <code>download</code> or <code>upload</code> on the command-line, the switches are not required to perform a transfer. Capture any files downloaded. Review the reputation of the IP or domain used. Typically once executed, a follow on command will be used to execute the dropped file. Note that the network connection or file modification events related will not spawn or create from <code>bitsadmin.exe</code>, but the artifacts will appear in a parallel process of <code>svchost.exe</code> with a command-line similar to <code>svchost.exe -k netsvcs -s BITS</code>. It’s important to review all parallel and child processes to capture any behaviors and artifacts. In some suspicious and malicious instances, BITS jobs will be created. You can use <code>bitsadmin /list /verbose</code> to list out the jobs during investigation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> Processes.process_name<span style=color:#f92672>=</span>bitsadmin.exe Processes.process<span style=color:#f92672>=*</span>transfer<span style=color:#f92672>*</span> <span style=color:#66d9ef>by</span> Processes.dest Processes.<span style=color:#66d9ef>user</span> Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
</span></span></code></pre></div><h3 id=26--certutil-download-with-urlcache-and-split-arguments>26- CertUtil Download With URLCache and Split Arguments</h3><p>Certutil.exe may download a file from a remote destination using <code>urlcache</code>. This behavior does require a URL to be passed on the command-line. In addition, <code>f</code> (force) and <code>split</code> (Split embedded ASN.1 elements, and save to files) will be used. It is not entirely common for <code>certutil.exe</code> to contact public IP space. However, it is uncommon for <code>certutil.exe</code> to write files to world writeable paths.\ During triage, capture any files on disk and review. Review the reputation of the remote IP or domain in question.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> Processes.process_name<span style=color:#f92672>=</span>certutil.exe Processes.process<span style=color:#f92672>=*</span>urlcache<span style=color:#f92672>*</span> Processes.process<span style=color:#f92672>=*</span>split<span style=color:#f92672>*</span> <span style=color:#66d9ef>by</span> Processes.dest Processes.<span style=color:#66d9ef>user</span> Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
</span></span></code></pre></div><h3 id=27--certutil-download-with-verifyctl-and-split-arguments>27- CertUtil Download With VerifyCtl and Split Arguments</h3><p>Certutil.exe may download a file from a remote destination using <code>VerifyCtl</code>. This behavior does require a URL to be passed on the command-line. In addition, <code>f</code> (force) and <code>split</code> (Split embedded ASN.1 elements, and save to files) will be used. It is not entirely common for <code>certutil.exe</code> to contact public IP space. \ During triage, capture any files on disk and review. Review the reputation of the remote IP or domain in question. Using <code>VerifyCtl</code>, the file will either be written to the current working directory or <code>%APPDATA%\..\LocalLow\Microsoft\CryptnetUrlCache\Content\&lt;hash></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> Processes.process_name<span style=color:#f92672>=</span>certutil.exe Processes.process<span style=color:#f92672>=*</span>verifyctl<span style=color:#f92672>*</span> Processes.process<span style=color:#f92672>=*</span>split<span style=color:#f92672>*</span> <span style=color:#66d9ef>by</span> Processes.dest Processes.<span style=color:#66d9ef>user</span> Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
</span></span></code></pre></div><h3 id=28--certutil-exe-certificate-extraction>28- Certutil exe certificate extraction</h3><p>This search looks for arguments to certutil.exe indicating the manipulation or extraction of Certificate. This certificate can then be used to sign new authentication tokens specially inside Federated environments such as Windows ADFS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>values</span>(Processes.process) <span style=color:#66d9ef>as</span> process <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> Processes.process_name<span style=color:#f92672>=</span>certutil.exe Processes.process <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;* -exportPFX *&#34;</span> <span style=color:#66d9ef>by</span> Processes.parent_process Processes.process_name Processes.process Processes.<span style=color:#66d9ef>user</span>
</span></span></code></pre></div><h3 id=29--certutil-with-decode-argument>29- CertUtil With Decode Argument</h3><p>CertUtil.exe may be used to <code>encode</code> and <code>decode</code> a file, including PE and script code. Encoding will convert a file to base64 with <code>----BEGIN CERTIFICATE-----</code> and <code>----END CERTIFICATE-----</code> tags. Malicious usage will include decoding a encoded file that was downloaded. Once decoded, it will be loaded by a parallel process. Note that there are two additional command switches that may be used - <code>encodehex</code> and <code>decodehex</code>. Similarly, the file will be encoded in HEX and later decoded for further execution. During triage, identify the source of the file being decoded. Review its contents or execution behavior for further analysis.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> Processes.process_name<span style=color:#f92672>=</span>certutil.exe Processes.process<span style=color:#f92672>=*</span>decode<span style=color:#f92672>*</span> <span style=color:#66d9ef>by</span> Processes.dest Processes.<span style=color:#66d9ef>user</span> Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
</span></span></code></pre></div><h3 id=30--create-local-admin-accounts-using-net-exe>30- Create local admin accounts using net exe</h3><p>This search looks for the creation of local administrator accounts using net.exe.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>|</span> tstats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>values</span>(Processes.<span style=color:#66d9ef>user</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>user</span> <span style=color:#66d9ef>values</span>(Processes.parent_process) <span style=color:#66d9ef>as</span> parent_process <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>from</span> datamodel<span style=color:#f92672>=</span>Endpoint.Processes <span style=color:#66d9ef>where</span> (Processes.process_name<span style=color:#f92672>=</span>net.exe <span style=color:#66d9ef>OR</span> Processes.process_name<span style=color:#f92672>=</span>net1.exe) <span style=color:#66d9ef>AND</span> (Processes.process<span style=color:#f92672>=*</span>localgroup<span style=color:#f92672>*</span> <span style=color:#66d9ef>OR</span> Processes.process<span style=color:#f92672>=*/</span><span style=color:#66d9ef>add</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>OR</span> Processes.process<span style=color:#f92672>=*</span><span style=color:#66d9ef>user</span><span style=color:#f92672>*</span>) <span style=color:#66d9ef>by</span> Processes.process Processes.process_name Processes.dest   <span style=color:#f92672>|`</span>create_local_admin_accounts_using_net_exe_filter<span style=color:#f92672>`</span>
</span></span></code></pre></div><h3 id=31--create-remote-thread-into-lsass>31- Create Remote Thread into LSASS</h3><p>Actors may create a remote thread into the LSASS service as part of a workflow to dump credentials.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>`</span>sysmon<span style=color:#f92672>`</span> EventID<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> TargetImage<span style=color:#f92672>=*</span>lsass.exe <span style=color:#f92672>|</span> stats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>by</span> Computer, EventCode, TargetImage, TargetProcessId <span style=color:#f92672>|</span> <span style=color:#66d9ef>rename</span> Computer <span style=color:#66d9ef>as</span> dest
</span></span></code></pre></div><h3 id=32--create-service-in-suspicious-file-path>32- Create Service In Suspicious File Path</h3><p>This detection is to identify a creation of “user mode service” where the service file path is located in non-common service folder in windows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>`</span>wineventlog_system<span style=color:#f92672>`</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>7045</span>  Service_File_Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*\.exe&#34;</span> <span style=color:#66d9ef>NOT</span> (Service_File_Name <span style=color:#66d9ef>IN</span> (<span style=color:#e6db74>&#34;C:\\Windows\\*&#34;</span>, <span style=color:#e6db74>&#34;C:\\Program File*&#34;</span>, <span style=color:#e6db74>&#34;C:\\Programdata\\*&#34;</span>, <span style=color:#e6db74>&#34;%systemroot%\\*&#34;</span>)) Service_Type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;user mode service&#34;</span> <span style=color:#f92672>|</span> stats <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>min</span>(_time) <span style=color:#66d9ef>as</span> firstTime <span style=color:#66d9ef>max</span>(_time) <span style=color:#66d9ef>as</span> lastTime <span style=color:#66d9ef>by</span> EventCode Service_File_Name Service_Name Service_Start_Type Service_Type
</span></span></code></pre></div><h3 id=33--common-windows-process-masquerading>33- Common Windows Process Masquerading</h3><p>“Masquerading occurs when the name or location of an object, legitimate or malicious, is manipulated or abused for the sake of evading defenses and observation. This may include manipulating file metadata, tricking users into misidentifying the file type, and giving legitimate task or service names.”</p><p>Malware authors often use this technique to hide malicious executables behind legitimate Windows executable names (e.g. <code>lsass.exe</code>, <code>svchost.exe</code>, etc).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ <span style=color:#66d9ef>source</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;XmlWinEventLog:Microsoft-Windows-Sysmon/Operational&#34;</span> <span style=color:#66d9ef>AND</span> (
</span></span><span style=display:flex><span>(process_name<span style=color:#f92672>=</span>svchost.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> (process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\svchost.exe&#34;</span> <span style=color:#66d9ef>OR</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\SysWow64\\svchost.exe&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>smss.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\smss.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>wininit.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>taskhost.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\taskhost.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>lasass.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\lsass.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>winlogon.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\winlogon.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>csrss.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\csrss.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>services.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\services.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>lsm.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\lsm.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (process_name<span style=color:#f92672>=</span>explorer.exe <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> process_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\explorer.exe&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=34--unusual-child-process-spawned-using-dde-exploit>34- Unusual Child Process spawned using DDE exploit</h3><p>Adversaries may use Windows Dynamic Data Exchange (DDE) to execute arbitrary commands. DDE is a client-server protocol for one-time and/or continuous inter-process communication (IPC) between applications. Once a link is established, applications can autonomously exchange transactions consisting of strings, warm data links (notifications when a data item changes), hot data links (duplications of changes to a data item), and requests for command execution.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span> <span style=color:#f92672>=</span> __your_sysmon__index__ (ParentImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*excel.exe&#34;</span> <span style=color:#66d9ef>OR</span> ParentImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*word.exe&#34;</span> <span style=color:#66d9ef>OR</span> ParentImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*outlook.exe&#34;</span>) Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*.exe&#34;</span>
</span></span></code></pre></div><h3 id=35--detecting-tampering-of-windows-defender-command-prompt>35- Detecting Tampering of Windows Defender Command Prompt</h3><p>In an attempt to avoid detection after compromising a machine, threat actors often try to disable Windows Defender. This is often done using “sc” [service control], a legitimate tool provided by Microsoft for managing services. This action interferes with event detection and may lead to a security event going undetected, thereby potentially leading to further compromise of the network.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span> __your_sysmon__index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;C:\\Windows\\System32\\sc.exe&#34;</span>  <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;^sc\s*(config|stop|query)\sWinDefend$&#34;</span>
</span></span></code></pre></div><h3 id=36--disable-uac>36- Disable UAC</h3><p>Threat actors often, after compromising a machine, try to disable User Access Control (UAC) to escalate privileges. This is often done by changing the registry key for system policies using “reg.exe”, a legitimate tool provided by Microsoft for modifying the registry via command prompt or scripts. This action interferes with UAC and may enable a threat actor to escalate privileges on the compromised system, thereby allowing further exploitation of the system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sourcetype <span style=color:#f92672>=</span> __your_sysmon_index__ ParentImage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>like</span>(CommandLine,<span style=color:#e6db74>&#34;reg.exe%HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System%REG_DWORD /d 0%&#34;</span>)
</span></span></code></pre></div><h3 id=37--identifying-port-scanning-activity>37- Identifying Port Scanning Activity</h3><p>After compromising an initial machine, adversaries commonly attempt to laterally move across the network. The first step to attempt the lateral movement often involves conducting host identification, port and service scans on the internal network via the compromised machine using tools such as Nmap, Cobalt Strike, etc.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sourcetype<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;firewall_logs&#39;</span> dest_ip <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;internal_subnet&#39;</span> <span style=color:#f92672>|</span> stats dc(dest_port) <span style=color:#66d9ef>as</span> pcount <span style=color:#66d9ef>by</span> src_ip <span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> pcount <span style=color:#f92672>&gt;</span><span style=color:#ae81ff>5</span>
</span></span></code></pre></div><h3 id=38--unusually-long-command-line-strings>38- Unusually Long Command Line Strings</h3><p>Often, after a threat actor gains access to a system, they will attempt to run some kind of malware to further infect the victim machine. These malware often have long command line strings, which could be a possible indicator of attack. Here, we use sysmon and Splunk to first find the average command string length and search for command strings that stretch over multiple lines, thus identifying anomalies and possibly malicious commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ sourcetype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xmlwineventlog&#34;</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4688</span>  <span style=color:#f92672>|</span>eval cmd_len<span style=color:#f92672>=</span>len(CommandLine) <span style=color:#f92672>|</span> eventstats <span style=color:#66d9ef>avg</span>(cmd_len) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>avg</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>host</span><span style=color:#f92672>|</span> stats <span style=color:#66d9ef>max</span>(cmd_len) <span style=color:#66d9ef>as</span> maxlen, <span style=color:#66d9ef>values</span>(<span style=color:#66d9ef>avg</span>) <span style=color:#66d9ef>as</span> avgperhost <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>host</span>, CommandLine <span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> maxlen <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#f92672>*</span>avgperhost
</span></span></code></pre></div><h3 id=39--clearing-windows-logs-with-wevtutil>39- Clearing Windows Logs with Wevtutil</h3><p>In an attempt to clear traces after compromising a machine, threat actors often try to clear Windows Event logs. This is often done using “wevtutil”, a legitimate tool provided by Microsoft. This action interferes with event collection and notification, and may lead to a security event going undetected, thereby potentially leading to further compromise of the network.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ sourcetype<span style=color:#f92672>=</span> __your__windows__sysmon__sourcetype EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=*</span>wevtutil<span style=color:#f92672>*</span> CommandLine<span style=color:#f92672>=*</span>cl<span style=color:#f92672>*</span> (CommandLine<span style=color:#f92672>=*</span><span style=color:#66d9ef>System</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=*</span><span style=color:#66d9ef>Security</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=*</span>Setup<span style=color:#f92672>*</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=*</span>Application<span style=color:#f92672>*</span>)
</span></span></code></pre></div><hr><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-3526678290068011 data-ad-slot=7160066188></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h3 id=40--unusual-child-process-for-spoolsvexe-or-connhostexe>40- Unusual Child Process for Spoolsv.Exe or Connhost.Exe</h3><p>After gaining initial access to a system, threat actors attempt to escalate privileges as they may be operating within a lower privileged process which does not allow them to access protected information or carry out tasks which require higher permissions. A common way of escalating privileges in a system is by externally invoking and exploiting spoolsv or connhost executables, both of which are legitimate Windows applications. This query searches for an invocation of either of these executables by a user, thus alerting us of any potentially malicious activity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) (Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>System32<span style=color:#960050;background-color:#1e0010>\\</span>spoolsv.exe<span style=color:#f92672>*</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>System32<span style=color:#960050;background-color:#1e0010>\\</span>conhost.exe) ParentImage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span>
</span></span></code></pre></div><h3 id=41--detecting-shadow-copy-deletion-via-vssadminexe>41- Detecting Shadow Copy Deletion via Vssadmin.exe</h3><p>After compromising a network of systems, threat actors often try to delete Shadow Copy in an attempt to prevent administrators from restoring the systems to versions present before the attack. This is often done via vssadmin, a legitimate Windows tool to interact with shadow copies. This non-detection of this technique, which is often employed by ransomware strains such as “Olympic Destroyer”, may lead to a failure in recovering systems after an attack.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_win_event_log_index__ EventType<span style=color:#f92672>=</span><span style=color:#ae81ff>4688</span> CommandLine:<span style=color:#e6db74>&#34;delete&#34;</span> OriginalFileName:<span style=color:#e6db74>&#34;VSSADMIN.EXE&#34;</span>
</span></span></code></pre></div><h3 id=42--webshell-indicative-process-tree>42- Webshell-Indicative Process Tree</h3><p>A web shell is a web script placed on an openly accessible web server to allow an adversary to use the server as a gatway in a network. As the shell operates, commands will be issued from within the web application into the broader server operating system. This analytic looks for host enumeration executables initiated by any web service that would not normally be executed within that environment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ (ParentImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\services.exe&#34;</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span> (CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*echo*&#34;</span> <span style=color:#66d9ef>AND</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\\pipe\\*&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\rundll32.exe&#34;</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*,a /p:*&#34;</span>)
</span></span></code></pre></div><h3 id=43--get-system-elevation>43- Get System Elevation</h3><p>Cyber actors frequently escalate to the SYSTEM account after gaining entry to a Windows host, to enable them to carry out various attacks more effectively. Tools such as Meterpreter, Cobalt Strike, and Empire carry out automated steps to “Get System”, which is the same as switching over to the System user account. Most of these tools utilize multiple techniques to try and attain SYSTEM: in the first technique, they create a named pipe and connects an instance of cmd.exe to it, which allows them to impersonate the security context of cmd.exe, which is SYSTEM. In the second technique, a malicious DLL is injected into a process that is running as SYSTEM; the injected DLL steals the SYSTEM token and applies it where necessary to escalate privileges. This analytic looks for both of these techniques.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>index<span style=color:#f92672>=</span>__your_sysmon_index__ <span style=color:#f92672>(</span>ParentImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\services.exe&#34;</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span> <span style=color:#f92672>(</span>CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*echo*&#34;</span> AND CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\\pipe\\*&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>OR <span style=color:#f92672>(</span>Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\rundll32.exe&#34;</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*,a /p:*&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\cmd.exe&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*%COMSPEC%*&#34;</span>) (CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*echo*&#34;</span> <span style=color:#66d9ef>AND</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\pipe\*&#34;</span>)
</span></span></code></pre></div><h3 id=44--boot-or-logon-initialization-scripts>44- Boot or Logon Initialization Scripts</h3><p>Adversaries may schedule software to run whenever a user logs into the system; this is done to establish persistence and sometimes for lateral movement. This trigger is established through the registry key HKEY_CURRENT_USER\Environment<em>UserInitMprLogonScript</em>. This signature looks edits to existing keys or creation of new keys in that path. Users purposefully adding benign scripts to this path will result in false positives; that case is rare, however. There are other ways of running a script at startup or login that are not covered in this signature. Note that this signature overlaps with the Windows Sysinternals Autoruns tool, which would also show changes to this registry path.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\reg.exe&#34;</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*add*\\Environment*UserInitMprLogonScript&#34;</span>) <span style=color:#66d9ef>OR</span> (<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ (EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span>) TargetObject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\\Environment*UserInitMprLogonScript&#34;</span>)
</span></span></code></pre></div><h3 id=45--local-network-sniffing>45- Local Network Sniffing</h3><p>Adversaries may use a variety of tools to gain visibility on the current status of things on the network: which processes are listening on which ports, which services are running on other hosts, etc. This analytic looks for the names of the most common network sniffing tools. While this may be noisy on networks where sysadmins are using any of these tools on a regular basis, in most networks their use is noteworthy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*tshark.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*windump.exe&#34;</span> <span style=color:#66d9ef>OR</span> (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*logman.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;?&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Program Files\\Windows Event Reporting\\Core\\EventReporting.AgentService.exe&#34;</span>) <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*tcpdump.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*wprui.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*wpr.exe&#34;</span>)
</span></span></code></pre></div><h3 id=46--dll-injection-with-mavinject>46- DLL Injection with Mavinject</h3><p>Injecting a malicious DLL into a process is a common adversary TTP. Although the ways of doing this are numerous, mavinject.exe is a commonly used tool for doing so because it roles up many of the necessary steps into one, and is available within Windows. Attackers may rename the executable, so we also use the common argument “INJECTRUNNING” as a related signature here. Whitelisting certain applications may be necessary to reduce noise for this analytic.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\SysWOW64\\mavinject.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\mavinject.exe&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\INJECTRUNNING*&#34;</span>)
</span></span></code></pre></div><h3 id=47--processes-started-from-irregular-parent>47- Processes Started From Irregular Parent</h3><p>Adversaries may start legitimate processes and then use their memory space to run malicious code. This analytic looks for common Windows processes that have been abused this way in the past; when the processes are started for this purpose they may not have the standard parent that we would expect. This list is not exhaustive, and it is possible for cyber actors to avoid this discepency. These signatures only work if Sysmon reports the parent process, which may not always be the case if the parent dies before sysmon processes the event.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;?&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Program Files\\SplunkUniversalForwarder\\bin\\splunk-regmon.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Program Files\\SplunkUniversalForwarder\\bin\\splunk-powershell.exe&#34;</span> <span style=color:#66d9ef>AND</span>
</span></span><span style=display:flex><span>((Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\System32\\smss.exe&#34;</span> <span style=color:#66d9ef>AND</span> (ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\smss.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;System&#34;</span>)) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\csrss.exe&#34;</span> <span style=color:#66d9ef>AND</span> (ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\smss.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\svchost.exe&#34;</span>)) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\smss.exe&#34;</span>) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\winlogon.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\smss.exe&#34;</span>) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\lsass.exe&#34;</span> <span style=color:#66d9ef>and</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span>) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\LogonUI.exe&#34;</span> <span style=color:#66d9ef>AND</span> (ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\winlogon.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span>)) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\services.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\wininit.exe&#34;</span>) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\spoolsv.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\services.exe&#34;</span>) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\taskhost.exe&#34;</span> <span style=color:#66d9ef>AND</span> (ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\services.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\svchost.exe&#34;</span>)) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\taskhostw.exe&#34;</span> <span style=color:#66d9ef>AND</span> (ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\services.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\svchost.exe&#34;</span>)) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>(Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\System32\\userinit.exe&#34;</span> <span style=color:#66d9ef>AND</span> (ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\dwm.exe&#34;</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\winlogon.exe&#34;</span>)))
</span></span></code></pre></div><h3 id=48--clear-powershell-console-command-history>48- Clear Powershell Console Command History</h3><p>Adversaries may attempt to conceal their tracks by deleting the history of commands run within the Powershell console, or turning off history saving to begin with. This analytic looks for several commands that would do this. This does not capture the event if it is done within the console itself; only commandline-based commands are detected. Note that the command to remove the history file directly may very a bit if the history file is not saved in the default path on a particular system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>index<span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*rm (Get-PSReadlineOption).HistorySavePath*&#34;</span> OR CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*del (Get-PSReadlineOption).HistorySavePath*&#34;</span> OR CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Set-PSReadlineOption –HistorySaveStyle SaveNothing*&#34;</span> OR CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Remove-Item (Get-PSReadlineOption).HistorySavePath*&#34;</span> OR CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;del*Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=49--local-permission-group-discovery>49- Local Permission Group Discovery</h3><p>Cyber actors frequently enumerate local or domain permissions groups. The net utility is usually used for this purpose. This analytic looks for any instances of net.exe, which is not normally used for benign purposes, although system administrator actions may trigger false positives.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>index<span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span>1<span style=color:#f92672>)</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\net.exe&#34;</span> AND <span style=color:#f92672>(</span>CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* user*&#34;</span> OR CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* group*&#34;</span> OR CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* localgroup*&#34;</span> OR CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*get-localgroup*&#34;</span> OR CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*get-ADPrincipalGroupMembership*&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=50--network-share-connection-removal>50- Network Share Connection Removal</h3><p>Adversaries may use network shares to exfliltrate date; they will then remove the shares to cover their tracks. This analytic looks for the removal of network shares via commandline, which is otherwise a rare event.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) ((Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\net.exe&#34;</span> <span style=color:#66d9ef>AND</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*delete*&#34;</span>) <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Remove-SmbShare*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Remove-FileShare*&#34;</span>)
</span></span></code></pre></div><h3 id=51--msbuild-and-msxsl>51- MSBuild and msxsl</h3><p>Trusted developer utilities such as MSBuild may be leveraged to run malicious code with elevated privileges. This analytic looks for any instances of msbuild.exe, which will execute any C# code placed within a given XML document; and msxsl.exe, which processes xsl transformation specifications for XML files and will execute a variaty of scripting languages contained within the XSL file. Both of these executables are rarely used outside of Visual Studio.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Program Files (x86)\\Microsoft Visual Studio\\*\\bin\\MSBuild.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\Microsoft.NET\\Framework*\\msbuild.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\users\\*\\appdata\\roaming\\microsoft\\msxsl.exe&#34;</span>) ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;*\\Microsoft Visual Studio*&#34;</span>)
</span></span></code></pre></div><h3 id=52--compiled-html-access>52- Compiled HTML Access</h3><p>Adversaries may hide malicious code in .chm compiled HTML files. When these files are read, Windows uses the HTML help executable named hh.exe, which is the signature for this analytic.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\syswow64\\hh.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\system32\\hh.exe&#34;</span>)
</span></span></code></pre></div><h3 id=53--cmstp>53- CMSTP</h3><p>CMSTP.exe is the Microsoft Connection Manager Profile Installer, which can be leveraged to setup listeners that will receive and install malware from remote sources in trusted fashion. When CMSTP.exe is seen in combination with an external connection, it is a good indication of this TTP.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>(<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>) Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\CMSTP.exe&#34;</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> ((<span style=color:#f92672>!</span>cidrmatch(<span style=color:#e6db74>&#34;10.0.0.0/8&#34;</span>, SourceIp) <span style=color:#66d9ef>AND</span> <span style=color:#f92672>!</span>cidrmatch(<span style=color:#e6db74>&#34;192.168.0.0/16&#34;</span>, SourceIp) <span style=color:#66d9ef>AND</span> <span style=color:#f92672>!</span>cidrmatch(<span style=color:#e6db74>&#34;172.16.0.0/12&#34;</span>, SourceIp))
</span></span></code></pre></div><h3 id=54--registry-edit-from-screensaver>54- Registry Edit from Screensaver</h3><p>Adversaries may use screensaver files to run malicious code. This analytic triggers on suspicious edits to the screensaver registry keys, which dictate which .scr file the screensaver runs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>your_sysmon_index (EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span>) TargetObject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\\Software\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\SCRNSAVE.EXE&#34;</span>
</span></span></code></pre></div><h3 id=55--scheduled-task---file-access>55- Scheduled Task - File Access</h3><p>In order to gain persistence, privilege escalation, or remote execution, an adversary may use the Windows Task Scheduler to schedule a command to be run at a specified time, date, and even host. Task Scheduler stores tasks as files in two locations - C:\Windows\Tasks (legacy) or C:\Windows\System32\Tasks. Accordingly, this analytic looks for the creation of task files in these two locations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span> Image<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\WINDOWS\\system32\\svchost.exe&#34;</span> (TargetFilename<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\Tasks\\*&#34;</span> <span style=color:#66d9ef>OR</span> TargetFilename<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\Tasks\\*&#34;</span>)
</span></span></code></pre></div><h3 id=56--component-object-model-hijacking>56- Component Object Model Hijacking</h3><p>Adversaries may establish persistence or escalate privileges by executing malicious content triggered by hijacked references to Component Object Model (COM) objects. This is typically done by replacing COM object registry entries under the HKEY_CURRENT_USER\Software\Classes\CLSID or HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID keys. Accordingly, this analytic looks for any changes under these keys.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ (EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span>) TargetObject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\\Software\\Classes\\CLSID\\*&#34;</span>
</span></span></code></pre></div><h3 id=57--indicator-blocking---driver-unloaded>57- Indicator Blocking - Driver Unloaded</h3><p>Adversaries may attempt to evade system defenses by unloading minifilter drivers used by host-based sensors such as Sysmon through the use of the fltmc command-line utility. Accordingly, this analytic looks for command-line invocations of this utility when used to unload minifilter drivers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>client EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*unload*&#34;</span> (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\SysWOW64\\fltMC.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\fltMC.exe&#34;</span>)
</span></span></code></pre></div><h3 id=58--credentials-in-files--registry>58- Credentials in Files & Registry</h3><p>Adversaries may search the Windows Registry on compromised systems for insecurely stored credentials for credential access. This can be accomplished using the query functionality of the reg.exe system utility, by looking for keys and values that contain strings such as “password”. In addition, adversaries may use toolkits such as <a href=https://powersploit.readthedocs.io/en/latest/>PowerSploit</a> in order to dump credentials from various applications such as IIS.Accordingly, this analytic looks for invocations of reg.exe in this capacity as well as that of several powersploit modules with similar functionality.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>((<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>OR</span> (<span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_win_syslog_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4688</span>)) (CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*reg* query HKLM /f password /t REG_SZ /s*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;reg* query HKCU /f password /t REG_SZ /s&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Get-UnattendedInstallFile*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Get-Webconfig*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Get-ApplicationHost*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Get-SiteListPassword*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Get-CachedGPPPassword*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*Get-RegistryAutoLogon*&#34;</span>)
</span></span></code></pre></div><h3 id=59--appinit-dlls>59- AppInit DLLs</h3><p>Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by AppInit DLLs loaded into processes. Dynamic-link libraries (DLLs) that are specified in the AppInit_DLLs value in the Registry keys <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows</code> or <code>HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows</code> are loaded by user32.dll into every process that loads user32.dll. These values can be abused to obtain elevated privileges by causing a malicious DLL to be loaded and run in the context of separate processes. Accordingly, this analytic looks for modifications to these registry keys that may be indicative of this type of abuse.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ (EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span> <span style=color:#66d9ef>OR</span> EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span>) (TargetObject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Appinit_Dlls\\*&#34;</span> <span style=color:#66d9ef>OR</span> TargetObject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Appinit_Dlls\\*&#34;</span>)
</span></span></code></pre></div><h3 id=60--ntfs-alternate-data-stream-execution---system-utilities>60- NTFS Alternate Data Stream Execution - System Utilities</h3><p>NTFS Alternate Data Streams (ADSs) may be used by adversaries as a means of evading security tools by storing malicious data or binaries in file attribute metadata. ADSs are also powerful because they can be directly executed by various Windows tools; accordingly, this analytic looks at common ways of executing ADSs using system utilities such as powershell.</p><p><strong>NTFS ADS - PowerShell</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#f92672>*</span><span style=color:#960050;background-color:#1e0010>\\</span>powershell.exe<span style=color:#f92672>|</span>regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Invoke-CimMethod\s+-ClassName\s+Win32_Process\s+-MethodName\s+Create.*\b(\w+(\.\w+)?):(\w+(\.\w+)?)|-ep bypass\s+-\s+&lt;.*\b(\w+(\.\w+)?):(\w+(\.\w+)?)|-command.*Get-Content.*-Stream.*Set-Content.*start-process .*(\w+(\.\w+)?)&#34;</span>NTFS ADS <span style=color:#f92672>-</span> wmic
</span></span></code></pre></div><p><strong>NTFS ADS - wmic</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#f92672>*</span><span style=color:#960050;background-color:#1e0010>\\</span>wmic.exe <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;process call create.*\&#34;</span>(<span style=color:#960050;background-color:#1e0010>\</span>w<span style=color:#f92672>+</span>(<span style=color:#960050;background-color:#1e0010>\</span>.<span style=color:#960050;background-color:#1e0010>\</span>w<span style=color:#f92672>+</span>)<span style=color:#f92672>?</span>):(<span style=color:#960050;background-color:#1e0010>\</span>w<span style=color:#f92672>+</span>(<span style=color:#960050;background-color:#1e0010>\</span>.<span style=color:#960050;background-color:#1e0010>\</span>w<span style=color:#f92672>+</span>)<span style=color:#f92672>?</span>)<span style=color:#e6db74>&#34;
</span></span></span></code></pre></div><p><strong>NTFS ADS - rundll32</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__  EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#f92672>*</span><span style=color:#960050;background-color:#1e0010>\\</span>rundll32.exe <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;\&#34;</span><span style=color:#f92672>?</span>(<span style=color:#960050;background-color:#1e0010>\</span>w<span style=color:#f92672>+</span>(<span style=color:#960050;background-color:#1e0010>\</span>.<span style=color:#960050;background-color:#1e0010>\</span>w<span style=color:#f92672>+</span>)<span style=color:#f92672>?</span>):(<span style=color:#960050;background-color:#1e0010>\</span>w<span style=color:#f92672>+</span>(<span style=color:#960050;background-color:#1e0010>\</span>.<span style=color:#960050;background-color:#1e0010>\</span>w<span style=color:#f92672>+</span>)<span style=color:#f92672>?</span>)<span style=color:#f92672>?</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>&#34;?,\w+\|(advpack\.dll\|ieadvpack\.dll),RegisterOCX\s+(\w+\.\w+):(\w+(\.\w+)?)\|(shdocvw\.dll\|ieframe\.dll),OpenURL.*(\w+\.\w+):(\w+(\.\w+)?)&#34;</span>
</span></span></code></pre></div><p><strong>NTFS ADS - wscript/cscript</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#f92672>*</span><span style=color:#960050;background-color:#1e0010>\\</span>wscript.exe <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#f92672>*</span><span style=color:#960050;background-color:#1e0010>\\</span>cscript.exe) <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;(?&lt;!\/)\b\w+(\.\w+)?:\w+(\.\w+)?$&#34;</span>
</span></span></code></pre></div><h3 id=61--ntfs-alternate-data-stream-execution---lolbas>61- NTFS Alternate Data Stream Execution - LOLBAS</h3><p>NTFS Alternate Data Streams (ADSs) may be used by adversaries as a means of evading security tools by storing malicious data or binaries in file attribute metadata. ADSs are also powerful because their contents can be directly executed by various Windows tools; accordingly, this analytic looks at common ways of executing ADSs using Living off the Land Binaries and Scripts (LOLBAS).</p><p><strong>NTFS ADS - control</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\</span>System32<span style=color:#960050;background-color:#1e0010>\\</span>control.exe <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\</span>SysWOW64<span style=color:#960050;background-color:#1e0010>\\</span>control.exe) <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;(\w+(\.\w+)?):(\w+\.dll)&#34;</span>
</span></span></code></pre></div><p><strong>NTFS ADS - appvlp</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Program Files\\Microsoft Office\\root\\Client\\AppVLP.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Program Files (x86)\\Microsoft Office\\root\\Client\\AppVLP.exe&#34;</span>) <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span>
</span></span></code></pre></div><p><strong>NTFS ADS - cmd</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>System32<span style=color:#960050;background-color:#1e0010>\\</span>cmd.exe <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>SysWOW64<span style=color:#960050;background-color:#1e0010>\\</span>cmd.exe) <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-\s+&lt;.*\b(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span>
</span></span></code></pre></div><p><strong>NTFS ADS - ftp</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>System32<span style=color:#960050;background-color:#1e0010>\\</span>ftp.exe <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>SysWOW64<span style=color:#960050;background-color:#1e0010>\\</span>ftp.exe) <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-s:(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span>
</span></span></code></pre></div><p><strong>NTFS ADS - bash</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>System32<span style=color:#960050;background-color:#1e0010>\\</span>bash.exe <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>SysWOW64<span style=color:#960050;background-color:#1e0010>\\</span>bash.exe) <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-c.*(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span>
</span></span></code></pre></div><p><strong>NTFS ADS - mavinject</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>System32<span style=color:#960050;background-color:#1e0010>\\</span>mavinject.exe <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>SysWOW64<span style=color:#960050;background-color:#1e0010>\\</span>mavinject.exe) <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;\d+\s+\/INJECTRUNNING.*\b(\w+(\.\w+)?):(\w+(\.\w+)?)&#34;</span>
</span></span></code></pre></div><p><strong>NTFS ADS - bitsadmin</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>System32<span style=color:#960050;background-color:#1e0010>\\</span>bitsadmin.exe <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>C</span>:<span style=color:#960050;background-color:#1e0010>\\</span>Windows<span style=color:#960050;background-color:#1e0010>\\</span>SysWOW64<span style=color:#960050;background-color:#1e0010>\\</span>bitsadmin.exe) <span style=color:#f92672>|</span> regex CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;\/create.*\/addfile.*\/SetNotifyCmdLine.*\b(\w+\.\w+):(\w+(\.\w+)?)&#34;</span>
</span></span></code></pre></div><h3 id=62--execution-with-at>62- Execution with AT</h3><p>In order to gain <a href=https://attack.mitre.org/tactics/TA0003/>persistence</a>, <a href=https://attack.mitre.org/tactics/TA0004/>privilege escalation</a>, or <a href=https://attack.mitre.org/tactics/TA0002/>remote execution</a>, an adversary may use the Windows built-in command AT (at.exe) to <a href=https://attack.mitre.org/techniques/T1053/002>schedule a command</a> to be run at a specified time, date, and even host. This method has been used by adversaries and administrators alike. Its use may lead to detection of compromised hosts and compromised users if it is used to move laterally. The built-in Windows tool schtasks.exe (<a href=https://car.mitre.org/analytics/CAR-2013-08-001>CAR-2013-08-001</a>) offers greater flexibility when creating, modifying, and enumerating tasks. For these reasons, schtasks.exe is more commonly used by administrators, tools/scripts, and power users.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\at.exe&#34;</span><span style=color:#f92672>|</span>stats <span style=color:#66d9ef>values</span>(CommandLine) <span style=color:#66d9ef>as</span> <span style=color:#e6db74>&#34;Command Lines&#34;</span> <span style=color:#66d9ef>by</span> ComputerName
</span></span></code></pre></div><h3 id=63--running-executables-with-same-hash-and-different-names>63- Running executables with same hash and different names</h3><p>Executables are generally not renamed, thus a given hash of an executable should only have ever one name. Identifying instances where multiple process names share the same hash may find cases where tools are copied by attackers to different folders or hosts to <a href=https://attack.mitre.org/tactics/TA0005>avoid detection</a>.</p><p>Although this analytic was initially based on MD5 hashes, it is equally applicable to any hashing convention.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#f92672>|</span>stats dc(Hashes) <span style=color:#66d9ef>as</span> Num_Hashes <span style=color:#66d9ef>values</span>(Hashes) <span style=color:#66d9ef>as</span> <span style=color:#e6db74>&#34;Hashes&#34;</span> <span style=color:#66d9ef>by</span> Image<span style=color:#f92672>|</span><span style=color:#66d9ef>where</span> Num_Hashes <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h3 id=64--suspicious-arguments>64- Suspicious Arguments</h3><p>Malicious actors may rename built-in commands or external tools, such as those provided by SysInternals, to better <a href=https://attack.mitre.org/tactics/TA0005>blend in</a> with the environment. In those cases, the file path name is arbitrary and may blend in well with the background. If the arguments are closely inspected, it may be possible to infer what tools are running and understand what an adversary is doing. When any legitimate software shares the same command lines, it must be whitelisted according to the expected parameters.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* -R * -pw*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* -pw * *@*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*sekurlsa*&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* -hp *&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* a *&#34;</span>)
</span></span></code></pre></div><h3 id=65--user-login-activity-monitoring>65- User Login Activity Monitoring</h3><p>Monitoring logon and logoff events for hosts on the network is very important for situational awareness. This information can be used as an indicator of unusual activity as well as to corroborate activity seen elsewhere.</p><p>Could be applied to a number of different types of monitoring depending on what information is desired. Some use cases include monitoring for all remote connections and building login timelines for users. Logon events are Windows Event Code 4624 for Windows Vista and above, 518 for pre-Vista. Logoff events are 4634 for Windows Vista and above, 538 for pre-Vista.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_win_event_log_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4624</span><span style=color:#f92672>|</span><span style=color:#66d9ef>search</span> <span style=color:#66d9ef>NOT</span> [<span style=color:#66d9ef>search</span> <span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_win_event_log_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4624</span><span style=color:#f92672>|</span>top <span style=color:#ae81ff>30</span> Account_Name<span style=color:#f92672>|</span><span style=color:#66d9ef>table</span> Account_Name]
</span></span></code></pre></div><h3 id=66--powershell-execution>66- PowerShell Execution</h3><p><a href=https://attack.mitre.org/techniques/T1059/001/>PowerShell</a> is a scripting environment included with Windows that is used by both attackers and administrators. Execution of PowerShell scripts in most Windows versions is opaque and not typically secured by antivirus which makes using PowerShell an easy way to circumvent security measures. This analytic detects execution of PowerShell scripts.</p><p>Powershell can be used to hide monitored command line execution such as:</p><ul><li><code>net use</code></li><li><code>sc start</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\powershell.exe&#34;</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;C:\\Windows\\explorer.exe&#34;</span><span style=color:#f92672>|</span>stats <span style=color:#66d9ef>values</span>(CommandLine) <span style=color:#66d9ef>as</span> <span style=color:#e6db74>&#34;Command Lines&#34;</span> <span style=color:#66d9ef>values</span>(ParentImage) <span style=color:#66d9ef>as</span> <span style=color:#e6db74>&#34;Parent Images&#34;</span> <span style=color:#66d9ef>by</span> ComputerName
</span></span></code></pre></div><h3 id=67--services-launching-cmd>67- Services launching Cmd</h3><p>Windows runs the <a href=https://en.wikipedia.org/wiki/Service_Control_Manager>Service Control Manager</a> (SCM) within the process <code>services.exe</code>. Windows launches services as independent processes or DLL loads within a <a href=https://en.wikipedia.org/wiki/svchost.exe>svchost.exe</a> group. To be a legitimate service, a process (or DLL) must have the appropriate service entry point <a href=https://msdn.microsoft.com/en-us/library/windows/desktop/ms687414.aspx>SvcMain</a>. If an application does not have the entry point, then it will timeout (default is 30 seconds) and the process will be killed.</p><p>To survive the timeout, <a href=https://www.operationblockbuster.com/wp-content/uploads/2016/02/Operation-Blockbuster-RAT-and-Staging-Report.pdf>adversaries and red teams</a> can create services that direct to <code>cmd.exe</code> with the flag <code>/c</code>, followed by the desired command. The <code>/c</code> flag causes the command shell to run a command and immediately exit. As a result, the desired program will remain running and it will report an error starting the service. This analytic will catch that command prompt instance that is used to launch the actual malicious executable. Additionally, the children and descendants of services.exe will run as a SYSTEM user by default. Thus, services are a convenient way for an adversary to gain <a href=https://attack.mitre.org/tactics/TA0003>Persistence</a> and <a href=https://attack.mitre.org/tactics/TA0004>Privilege Escalation</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\cmd.exe&#34;</span> ParentImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\services.exe&#34;</span>
</span></span></code></pre></div><h3 id=68--command-launched-from-winlogon>68- Command Launched from WinLogon</h3><p>An adversary can use <a href=https://attack.mitre.org/techniques/T1546/008>accessibility features</a> (Ease of Access), such as StickyKeys or Utilman, to launch a command shell from the logon screen and gain SYSTEM access. Since an adversary does not have physical access to the machine, this technique must be run within <a href=https://attack.mitre.org/techniques/T1021/001>Remote Desktop</a>. To prevent an adversary from getting to the login screen without first authenticating, Network-Level Authentication (NLA) must be enabled. If a debugger is set up for one of the accessibility features, then it will intercept the process launch of the feature and instead execute a new command line. This analytic looks for instances of <code>cmd.exe</code> or <code>powershell.exe</code> launched directly from the logon process, <code>winlogon.exe</code>. It should be used in tandem with <a href=https://car.mitre.org/analytics/CAR-2014-11-003>CAR-2014-11-003</a>, which detects the accessibility programs in the command line.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ParentImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\winlogon.exe&#34;</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\cmd.exe&#34;</span>
</span></span></code></pre></div><h3 id=69--host-discovery-commands>69- Host Discovery Commands</h3><p>When entering on a host for the first time, an adversary may try to <a href=https://attack.mitre.org/tactics/TA0007>discover</a> information about the host. There are several built-in Windows commands that can be used to learn about the software configurations, active users, administrators, and networking configuration. These commands should be monitored to identify when an adversary is learning information about the system and environment. The information returned may impact choices an adversary can make when <a href=https://attack.mitre.org/tactics/TA0003>establishing persistence</a>, <a href=https://attack.mitre.org/tactics/TA0004>escalating privileges</a>, or <a href=https://attack.mitre.org/tactics/TA0008>moving laterally</a>.</p><p>Because these commands are built in, they may be run frequently by power users or even by normal users. Thus, an analytic looking at this information should have well-defined white- or blacklists, and should consider looking at an anomaly detection approach, so that this information can be learned dynamically.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\hostname.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\ipconfig.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\net.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\quser.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\qwinsta.exe&#34;</span> <span style=color:#66d9ef>OR</span> (Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\sc.exe&#34;</span> <span style=color:#66d9ef>AND</span> (CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* query *&#34;</span> <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* qc *&#34;</span>)) <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\systeminfo.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\tasklist.exe&#34;</span> <span style=color:#66d9ef>OR</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\whoami.exe&#34;</span>)<span style=color:#f92672>|</span>stats <span style=color:#66d9ef>values</span>(Image) <span style=color:#66d9ef>as</span> <span style=color:#e6db74>&#34;Images&#34;</span> <span style=color:#66d9ef>values</span>(CommandLine) <span style=color:#66d9ef>as</span> <span style=color:#e6db74>&#34;Command Lines&#34;</span> <span style=color:#66d9ef>by</span> ComputerName
</span></span></code></pre></div><h3 id=70--create-remote-process-via-wmic>70- Create Remote Process via WMIC</h3><p>Adversaries may use <a href=https://attack.mitre.org/techniques/T1047>Windows Management Instrumentation</a> (WMI) to move laterally, by launching executables remotely.The analytic <a href=https://car.mitre.org/analytics/CAR-2014-12-001>CAR-2014-12-001</a> describes how to detect these processes with network traffic monitoring and process monitoring on the target host. However, if the command line utility <code>wmic.exe</code> is used on the source host, then it can additionally be detected on an analytic. The command line on the source host is constructed into something like <code>wmic.exe /node:"\&lt;hostname\>" process call create "\&lt;command line\>"</code>. It is possible to also connect via IP address, in which case the string <code>"\&lt;hostname\>"</code> would instead look like <code>IP Address</code>.</p><p>Although this analytic was created after <a href=https://car.mitre.org/analytics/CAR-2014-12-001>CAR-2014-12-001</a>, it is a much simpler (although more limited) approach. Processes can be created remotely via WMI in a few other ways, such as more direct API access or the built-in utility</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\wmic.exe&#34;</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* process call create *&#34;</span><span style=color:#f92672>|</span><span style=color:#66d9ef>search</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* /node:*&#34;</span>
</span></span></code></pre></div><h3 id=71--uac-bypass>71- UAC Bypass</h3><p>Bypassing user account control (UAC Bypass) is generally done by piggybacking on a system process that has auto-escalate privileges. This analytic looks to detect those cases as described by the open-source <a href=https://github.com/hfiref0x/UACME>UACME</a> tool.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>_your_sysmon_index_ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> IntegrityLevel<span style=color:#f92672>=</span>High<span style=color:#f92672>|</span><span style=color:#66d9ef>search</span> (ParentCommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;\&#34;</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>system32<span style=color:#960050;background-color:#1e0010>\\</span>dism.exe<span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>&#34;*&#34;&#34;*.xml&#34;</span> <span style=color:#66d9ef>AND</span> Image<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;c:\\users\\*\\appdata\\local\\temp\\*\\dismhost.exe&#34;</span>) <span style=color:#66d9ef>OR</span> ParentImage<span style=color:#f92672>=</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>system32<span style=color:#960050;background-color:#1e0010>\\</span>fodhelper.exe <span style=color:#66d9ef>OR</span> (CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;\&#34;</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>system32<span style=color:#960050;background-color:#1e0010>\\</span>wusa.exe<span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>&#34;*/quiet*&#34;</span> <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>!=</span>NOT_TRANSLATED <span style=color:#66d9ef>AND</span> CurrentDirectory<span style=color:#f92672>=</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>system32<span style=color:#960050;background-color:#1e0010>\\</span> <span style=color:#66d9ef>AND</span> ParentImage<span style=color:#f92672>!=</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>explorer.exe) <span style=color:#66d9ef>OR</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*.exe\&#34;</span><span style=color:#f92672>*</span>cleanmgr.exe <span style=color:#f92672>/</span>autoclean<span style=color:#f92672>*</span><span style=color:#e6db74>&#34; OR (ParentImage=&#34;</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#f92672>*</span>dccw.exe<span style=color:#e6db74>&#34; AND Image!=&#34;</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>system32<span style=color:#960050;background-color:#1e0010>\\</span>cttune.exe<span style=color:#e6db74>&#34;) OR Image=&#34;</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>program files<span style=color:#960050;background-color:#1e0010>\\</span>windows media player<span style=color:#960050;background-color:#1e0010>\\</span>osk.exe<span style=color:#e6db74>&#34; OR ParentImage=&#34;</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>system32<span style=color:#960050;background-color:#1e0010>\\</span>slui.exe<span style=color:#e6db74>&#34;|eval PossibleTechniques=case(like(lower(ParentCommandLine),&#34;</span><span style=color:#f92672>%</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>system32<span style=color:#960050;background-color:#1e0010>\\</span>dism.exe<span style=color:#f92672>%</span><span style=color:#e6db74>&#34;), &#34;</span>UACME <span style=color:#f92672>#</span><span style=color:#ae81ff>23</span><span style=color:#e6db74>&#34;, like(lower(Image),&#34;</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>program files<span style=color:#960050;background-color:#1e0010>\\</span>windows media player<span style=color:#960050;background-color:#1e0010>\\</span>osk.exe<span style=color:#e6db74>&#34;), &#34;</span>UACME <span style=color:#f92672>#</span><span style=color:#ae81ff>32</span><span style=color:#e6db74>&#34;, like(lower(ParentImage),&#34;</span><span style=color:#66d9ef>c</span>:<span style=color:#960050;background-color:#1e0010>\\</span>windows<span style=color:#960050;background-color:#1e0010>\\</span>system32<span style=color:#960050;background-color:#1e0010>\\</span>fodhelper.exe<span style=color:#e6db74>&#34;),  &#34;</span>UACME <span style=color:#f92672>#</span><span style=color:#ae81ff>33</span><span style=color:#e6db74>&#34;, like(lower(CommandLine),&#34;</span><span style=color:#f92672>%</span>.exe<span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>&#34;%cleanmgr.exe /autoclean%&#34;</span>), <span style=color:#e6db74>&#34;UACME #34&#34;</span>, <span style=color:#66d9ef>like</span>(<span style=color:#66d9ef>lower</span>(Image),<span style=color:#e6db74>&#34;c:\\windows\\system32\\wusa.exe&#34;</span>), <span style=color:#e6db74>&#34;UACME #36&#34;</span>, <span style=color:#66d9ef>like</span>(<span style=color:#66d9ef>lower</span>(ParentImage),<span style=color:#e6db74>&#34;c:\\windows\\%dccw.exe&#34;</span>), <span style=color:#e6db74>&#34;UACME #37&#34;</span>, <span style=color:#66d9ef>like</span>(<span style=color:#66d9ef>lower</span>(ParentImage),<span style=color:#e6db74>&#34;c:\\windows\\system32\\slui.exe&#34;</span>), <span style=color:#e6db74>&#34;UACME #45&#34;</span>)
</span></span></code></pre></div><h3 id=72--generic-regsvr32>72- Generic Regsvr32</h3><p>Regsvr32 can be used to execute arbitrary code in the context of a Windows signed binary, which can be used to bypass application whitelisting. This analytic looks for suspicious usage of the tool. It’s not likely that you’ll get millions of hits, but it does occur during normal activity so some form of baselining would be necessary for this to be an alerting analytic. Alternatively, it can be used for hunt by looking for new or anomalous DLLs manually.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_data__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> regsvr32.exe <span style=color:#f92672>|</span> <span style=color:#66d9ef>search</span> ParentImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*regsvr32.exe&#34;</span> <span style=color:#66d9ef>AND</span> Image<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;*regsvr32.exe*&#34;</span>
</span></span></code></pre></div><h3 id=73--squiblydoo>73- Squiblydoo</h3><p>Squiblydoo is a specific usage of regsvr32.dll to load a COM scriptlet directly from the internet and execute it in a way that bypasses application whitelisting. It can be seen by looking for regsvr32.exe executions that load the scrobj.dll (which execute the COM scriptlet) or, if that is too noisy, those that also load content directly via HTTP or HTTPS.</p><p>Squiblydoo was first written up by Casey Smith at Red Canary, though that blog post is no longer accessible.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_events__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> regsvr32.exe scrobj.dll <span style=color:#f92672>|</span> <span style=color:#66d9ef>search</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*regsvr32.exe&#34;</span>
</span></span></code></pre></div><h3 id=74--credential-dumping-via-mimikatz>74- Credential Dumping via Mimikatz</h3><p>Credential dumpers like Mimikatz can be loaded into memory and from there read data from another processes. This analytic looks for instances where processes are requesting specific permissions to read parts of the LSASS process in order to detect when credential dumping is occurring. One weakness is that all current implementations are “overtuned” to look for common access patterns used by Mimikatz.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_data__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span> 
</span></span><span style=display:flex><span>TargetImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\WINDOWS\\system32\\lsass.exe&#34;</span>
</span></span><span style=display:flex><span>(GrantedAccess<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x1410 <span style=color:#66d9ef>OR</span> GrantedAccess<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x1010 <span style=color:#66d9ef>OR</span> GrantedAccess<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x1438 <span style=color:#66d9ef>OR</span> GrantedAccess<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x143a <span style=color:#66d9ef>OR</span> GrantedAccess<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x1418)
</span></span><span style=display:flex><span>CallTrace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\windows\\SYSTEM32\\ntdll.dll+*|C:\\windows\\System32\\KERNELBASE.dll+20edd|UNKNOWN(*)&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> _time hostname <span style=color:#66d9ef>user</span> SourceImage GrantedAccess
</span></span></code></pre></div><h3 id=75--access-permission-modification>75- Access Permission Modification</h3><p>Adversaries sometimes modify object access rights at the operating system level. There are varying motivations behind this action - they may not want some files/objects to be changed on systems for persistence reasons and therefore provide admin only rights; also, they may want files to be accessible with lower levels of permissions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_windows_security_log_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>4670</span> Object_Type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;File&#34;</span> Security_ID<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;NT AUTHORITY\\SYSTEM&#34;</span>
</span></span></code></pre></div><h3 id=76--lsass-process-dump-via-procdump>76- Lsass Process Dump via Procdump</h3><p><a href=https://docs.microsoft.com/en-us/sysinternals/downloads/procdump>ProcDump</a> is a sysinternal command-line utility whose primary purpose is monitoring an application for CPU spikes and generating crash dumps during a spike that an administrator or developer can use to determine the cause of the spike.</p><p>ProcDump may be used to dump the memory space of lsass.exe to disk for processing with a credential access tool such as Mimikatz. This is performed by launching procdump.exe as a privileged user with command line options indicating that lsass.exe should be dumped to a file with an arbitrary name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*\\procdump*.exe&#34;</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*lsass*&#34;</span>
</span></span></code></pre></div><h3 id=77--credential-dumping-via-windows-task-manager>77- Credential Dumping via Windows Task Manager</h3><p>The Windows Task Manager may be used to dump the memory space of <code>lsass.exe</code> to disk for processing with a credential access tool such as Mimikatz. This is performed by launching Task Manager as a privileged user, selecting <code>lsass.exe</code>, and clicking “Create dump file”. This saves a dump file to disk with a deterministic name that includes the name of the process being dumped.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span> TargetFilename<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*lsass*.dmp&#34;</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\taskmgr.exe&#34;</span>
</span></span></code></pre></div><h3 id=78--active-directory-dumping-via-ntdsutil>78- Active Directory Dumping via NTDSUtil</h3><p>The NTDSUtil tool may be used to dump a Microsoft Active Directory database to disk for processing with a credential access tool such as Mimikatz. This is performed by launching <code>ntdsutil.exe</code> as a privileged user with command line arguments indicating that media should be created for offline Active Directory installation and specifying a folder path. This process will create a copy of the Active Directory database, <code>ntds.dit</code>, to the specified folder path.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span> TargetFilename<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*ntds.dit&#34;</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*ntdsutil.exe&#34;</span>
</span></span></code></pre></div><h3 id=79--shadow-copy-deletion>79- Shadow Copy Deletion</h3><p>The Windows <a href=https://docs.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service>Volume Shadow Copy Service</a> is a built-in OS feature that can be used to create backup copies of files and volumes.</p><p>Adversaries may delete these shadow copies, typically through the usage of system utilities such as vssadmin.exe or wmic.exe, in order prevent file and data recovery. This technique is commonly employed for this purpose by ransomware.</p><p><strong>Vssadmin.exe delete shadows</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\System32\\vssadmin.exe&#34;</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*delete shadows*&#34;</span>
</span></span></code></pre></div><p><strong>WMIC shadowcopy delete</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\Windows\\*\\wmic.exe&#34;</span> CommandLine<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*shadowcopy delete*&#34;</span>
</span></span></code></pre></div><h3 id=80--minidump-of-lsass>80- MiniDump of LSASS</h3><p>This analytic detects the minidump variant of credential dumping where a process opens lsass.exe in order to extract credentials using the Win32 API call <a href=https://docs.microsoft.com/en-us/windows/win32/api/minidumpapiset/nf-minidumpapiset-minidumpwritedump>MiniDumpWriteDump</a>. Tools like <a href=https://github.com/GhostPack/SafetyKatz>SafetyKatz</a>, <a href=https://github.com/m0rv4i/SafetyDump>SafetyDump</a>, and <a href=https://github.com/outflanknl/Dumpert>Outflank-Dumpert</a> default to this variant and may be detected by this analytic, though keep in mind that not all options for using those tools will result in this specific behavior.</p><p>The analytic is based on a <a href=https://github.com/NVISO-BE/sigma-public/blob/master/rules/windows/sysmon/sysmon_lsass_memdump.yml>Sigma analytic</a> contributed by Samir Bousseaden and written up in a <a href=https://blog.menasec.net/2019/02/threat-hunting-21-procdump-or-taskmgr.html>blog on MENASEC</a>. It looks for a call trace that includes either dbghelp.dll or dbgcore.dll, which export the relevant functions/permissions to perform the dump. It also detects using the Windows Task Manager (taskmgr.exe) to dump lsass, which is described in <a href=https://car.mitre.org/analytics/CAR-2019-08-001/>CAR-2019-08-001</a>. In this iteration of the Sigma analytic, the <code>GrantedAccess</code> filter isn’t included because it didn’t seem to filter out any false positives and introduces the potential for evasion.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span> TargetImage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\\windows\\system32\\lsass.exe&#34;</span> (CallTrace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*dbghelp.dll*&#34;</span> <span style=color:#66d9ef>OR</span> CallTrace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*dbgcore.dll*&#34;</span>)<span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> _time <span style=color:#66d9ef>host</span> SourceProcessId SourceImage
</span></span></code></pre></div><h3 id=81--rare-lolbas-command-lines>81- Rare LolBAS Command Lines</h3><p><a href=https://lolbas-project.github.io/>LoLBAS</a> are binaries and scripts that are built in to Windows, frequently are signed by Microsoft, and may be used by an attacker. Some LoLBAS are used very rarely and it might be possible to alert every time they’re used (this would depend on your environment), but many others are very common and can’t be simply alerted on.</p><p>This analytic takes all instances of LoLBAS execution and then looks for instances of command lines that are not normal in the environment. This can detect attackers (which will tend to need the binaries for something different than normal usage) but will also tend to have false positives.</p><p>The analytic needs to be tuned. The <code>1.5</code> in the query is the number of standard deviations away to look. It can be tuned up to filter out more noise and tuned down to get more results. This means it is probably best as a hunting analytic when you have analysts looking at the screen and able to tune the analytic up and down, because the threshold may not be stable for very long.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>index</span><span style=color:#f92672>=</span>__your_sysmon_index__ EventCode<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (OriginalFileName <span style=color:#f92672>=</span> <span style=color:#66d9ef>At</span>.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Atbroker.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Bash.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Bitsadmin.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Certutil.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Cmd.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Cmdkey.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Cmstp.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Control.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Csc.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Cscript.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Dfsvc.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Diskshadow.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Dnscmd.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Esentutl.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Eventvwr.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Expand.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Extexport.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Extrac32.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Findstr.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Forfiles.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Ftp.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Gpscript.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Hh.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Ie4uinit.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Ieexec.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Infdefaultinstall.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Installutil.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Jsc.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Makecab.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Mavinject.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Microsoft.Workflow.r.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Mmc.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Msbuild.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Msconfig.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Msdt.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Mshta.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Msiexec.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Odbcconf.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Pcalua.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Pcwrun.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Presentationhost.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Print.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Reg.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Regasm.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Regedit.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Register<span style=color:#f92672>-</span>cimprovider.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Regsvcs.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Regsvr32.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> <span style=color:#66d9ef>Replace</span>.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Rpcping.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Rundll32.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Runonce.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Runscripthelper.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Sc.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Schtasks.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Scriptrunner.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> SyncAppvPublishingServer.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Tttracer.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Verclsid.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Wab.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Wmic.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Wscript.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Wsreset.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Xwizard.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Advpack.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Comsvcs.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Ieadvpack.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Ieaframe.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Mshtml.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Pcwutl.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Setupapi.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Shdocvw.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Shell32.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Syssetup.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Url.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Zipfldr.dll <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Appvlp.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Bginfo.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Cdb.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> csi.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Devtoolslauncher.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> dnx.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Dxcap.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Excel.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Mftrace.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Msdeploy.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> msxsl.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Powerpnt.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> rcsi.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Sqler.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Sqlps.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> SQLToolsPS.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Squirrel.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> te.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Tracker.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> <span style=color:#66d9ef>Update</span>.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> vsjitdebugger.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Winword.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Wsl.exe <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> CL_Mutexverifiers.ps1 <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> CL_Invocation.ps1 <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Manage<span style=color:#f92672>-</span>bde.wsf <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Pubprn.vbs <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Slmgr.vbs <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Syncappvpublishingserver.vbs <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> winrm.vbs <span style=color:#66d9ef>OR</span> OriginalFileName <span style=color:#f92672>=</span> Pester.bat)<span style=color:#f92672>|</span>eval CommandLine<span style=color:#f92672>=</span><span style=color:#66d9ef>lower</span>(CommandLine)<span style=color:#f92672>|</span>eventstats <span style=color:#66d9ef>count</span>(process) <span style=color:#66d9ef>as</span> procCount <span style=color:#66d9ef>by</span> process<span style=color:#f92672>|</span>eventstats <span style=color:#66d9ef>avg</span>(procCount) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>avg</span> stdev(procCount) <span style=color:#66d9ef>as</span> stdev<span style=color:#f92672>|</span>eval lowerBound<span style=color:#f92672>=</span>(<span style=color:#66d9ef>avg</span><span style=color:#f92672>-</span>stdev<span style=color:#f92672>*</span><span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>5</span>)<span style=color:#f92672>|</span>eval isOutlier<span style=color:#f92672>=</span><span style=color:#66d9ef>if</span>((procCount <span style=color:#f92672>&lt;</span> lowerBound),<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>0</span>)<span style=color:#f92672>|</span><span style=color:#66d9ef>where</span> isOutlier<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#f92672>|</span><span style=color:#66d9ef>table</span> <span style=color:#66d9ef>host</span>, Image, ParentImage, CommandLine, ParentCommandLine, procCount
</span></span></code></pre></div><p><strong>References:</strong></p><p><a href=https://www.youtube.com/c/SplunkHowTo/videos>Splunk How-To</a></p><p><a href=https://car.mitre.org/>car.mitre.org</a></p><p><a href=https://car.mitre.org/analytics/>Analytics</a></p><hr><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-3526678290068011 data-ad-slot=7160066188></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=anir0y data-description="Support me on Buy me a coffee!" data-message data-color=#5F7FFF data-position=Right data-x_margin=18 data-y_margin=18></script></article></section></div></div><footer class="ui basic center aligned segment" style=background-color:transparent><p>© 2010 - 2023 Classroom</p></footer></div></section><section class=back><div class=dream-max-width><header class="ui basic very padded segment dream-header"><div class="ui small circular image"><img src=/img/avatar.jpeg></div><div class=content><h1 class="ui medium header">Reading Stuffs<div class="sub header"></div></h1><article class="ui horizontal list"><a class=item href=/categories><i class="th list icon" title="All Categories"></i></a>
<a class=item href=/tags><i class="tags icon" title="All Tags"></i></a></article></div></header><div class="ui relaxed grid dream-grid dream-back"><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment"><h3 class="ui header">Social Links</h3><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=/index.xml><i class="large rss square icon" title=RSS></i></a></div><div class=item><a href=mailto:classroom@anir0y.in><i class="large mail icon" title=Email></i></a></div><div class=item><a href=https://twitter.com/anir0y target=_blank><i class="large twitter icon" title=Twitter></i></a></div><div class=item><a href=https://facebook.com/0xanir0y target=_blank><i class="large facebook icon" title=Facebook></i></a></div><div class=item><a href=https://instagram.com/0xanir0y target=_blank><i class="large instagram icon" title=Instagram></i></a></div><div class=item><a href=https://www.linkedin.com/in/anir0y target=_blank><i class="large linkedin icon" title=Linkedin></i></a></div><div class=item><a href=https://github.com/anir0y target=_blank><i class="large github icon" title=GitHub></i></a></div></nav></article></div><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment">YOU CAN REUSE MY CONTENT</article></div></div></div></section></div></div><script>window.defaultDark=null,window.backgroundDark="black",window.backgroundImageDark=null,window.darkNav=!0,window.hasTwitterEmbed=!0,window.hasTwitterEmbed&&(window.twttr=function(e,t,n){var o,i=e.getElementsByTagName(t)[0],s=window.twttr||{};return e.getElementById(n)?s:(o=e.createElement(t),o.id=n,o.src="https://platform.twitter.com/widgets.js",i.parentNode.insertBefore(o,i),s._e=[],s.ready=function(e){s._e.push(e)},s)}(document,"script","twitter-wjs"))</script><script src=/js/jquery.min.js></script>
<script src=/js/semantic.min.js></script>
<script src=/js/jquery.overlayScrollbars.min.js></script>
<script src=/js/header.js></script>
<script src=/js/main.js></script>
<script src=/js/theme.js></script>
<script src=/js/html2canvas.min.js></script>
<script src=/js/post.js></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/clojure.min.js></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/ocaml.min.js></script>
<script>hljs.initHighlightingOnLoad(),setHighlightTheme();function setHighlightTheme(){var e=localStore.getItem("hugo-theme-dream-is-dark"),e=e?e:window.defaultDark?"y":e,t="tomorrow",n="tomorrow-night",s=e==="y"?n:t;$("link[data-highlight]").attr("href","https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/"+s+".min.css"),$("pre").css("background",e==="y"?"#333":"")}</script><div class="ui inverted segment" id=dream-search><div class="ui search"><div class="ui transparent input"><input class=prompt type=text placeholder=Search></div><div class=results></div></div></div><script>$(document).ready(function(){$.getJSON("https://classroom.anir0y.in/index.json",function(e){$(".ui.search").search({source:e,searchFields:["title"],showNoResults:!0})})})</script><script src=/js/search.js></script></body></html>